<html>
<!-- $ID$ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>OpenBet Administration</title>

<script>
function fs(b,t)
{
	b.form.SubmitName.value=t;
	b.form.submit();
	return true;
}

function doAudit(audit, b) {
	b.form.AuditInfo.value = audit;
	return fs(b, "GoAudit");
}

selected = false;

function selectAllCusts(b) {

	val = true;
	if (selected == false) {
		val = true;
		b.value="Select None";
		selected = true;
	} else {
		val = false;
		b.value="Select All";
		selected = false;
	}

	##TP_LOOP row_idx {[tpGetVar debt_num_rows]}##
	this.document.getElementById('chk_##TP_cust_id##').checked = selected;
	##TP_ENDLOOP##
}


##TP_IF {![OT_CfgGet RIGHTNOW_DEBT_MAN_ENABLED 1]}##

function updateLetterSelect() {

	template = document.debt_management.LetterTemplate.options[document.debt_management.LetterTemplate.selectedIndex].value;

	var selectionBox = document.debt_management.Letter;
	selectionBox.options.length = 0;

	##TP_LOOP template_idx {[tpGetVar debt_num_templates]}##
	if (template == "##TP_template_id##") {
		selectionBox.options[selectionBox.options.length] = new Option('(New)',0,true);
		##TP_LOOP letter_idx {[tpGetVar debt_num_letters]}##
			##TP_IF {[tpBindGet ltr_tmplt_id] == [tpBindGet template_id]}##
				selectionBox.options[selectionBox.options.length] = new Option('##TP_letter_name##',##TP_letter_id##);
			##TP_ENDIF##
		##TP_ENDLOOP##
		return
	}
	##TP_ENDLOOP##
}

##TP_ENDIF##


function displayCalendars() {
	new Calendar(document.forms.debt_management.NewReviewDate,null,false,"lo");
}

function checkDate() {
	var dateArray = new Array();
	dateArray = document.forms.debt_management.NewReviewDate.value.split('-');
	if (dateArray.length != 3) {
		alert ('Error in date field format (should be yyyy-MM-DD)');
		document.forms.debt_management.NewReviewDate.value = '';
		return;
	}
}
</script>

</head>
##TP_IF {[OT_CfgGet RIGHTNOW_DEBT_MAN_ENABLED 1]}##
<body onload="displayCalendars();">
##TP_ELSE##
<body onload="displayCalendars(); updateLetterSelect();">
##TP_ENDIF##
	##TP_PLAY error_rpt.html##
	##TP_PLAY msg_rpt.html##
	<form name="debt_management" method="post" action="##TP_CGI_URL##">
		<table cellspacing=0 cellpadding=2 border=0 >
			<tr>
				<th colspan=16 class=title>
					Debt ##TP_state_desc##
				</th>
			</tr>
			<tr>
				<th nowrap class=colhead>Select</th>
				<th nowrap class=colhead>Account<br>number</th>
				<th nowrap class=colhead>Opened</th>
				<th nowrap class=colhead>Username</th>
				<th nowrap class=colhead>First name</th>
				<th nowrap class=colhead>Last name</th>
				<th nowrap class=colhead>Customer<br>Group</th>
				<th nowrap class=colhead>Balance</th>
				<th nowrap class=colhead>Statement <br>Balance</th>
				<th nowrap class=colhead>Review Date</th>
				<th nowrap class=colhead>Reviewed</th>
				<th nowrap class=colhead>Letter<br>sent</th>
				<th nowrap class=colhead>Largest bet</th>
				<th nowrap class=colhead>Last payment<br> date</th>
				<th nowrap class=colhead>Last payment<br> amount</th>
				<th nowrap class=colhead>Note</th>

			</tr>
			##TP_LOOP row_idx {[tpGetVar debt_num_rows]}##
			<tr>
				<td><input type="checkbox" name="sc" id="chk_##TP_cust_id##" value="##TP_cust_id##">
				<input type="hidden" name="NEXT_##TP_cust_id##" value="##TP_next_state_id##">
				<input type="hidden" name="DIARY_##TP_cust_id##" value="##TP_debt_diary_id##">
				<input type="hidden" name="ST_##TP_cust_id##" value="##TP_debt_state_id##">
				</td>
				<td>##TP_acct_no##</td>
				<td>##TP_opened##</td>
				<td><a href="##TP_CGI_URL##?action=ADMIN::CUST::GoCust&CustId=##TP_cust_id##" target="_blank">##TP_username##</a></td>
				<td>##TP_fname##</td>
				<td>##TP_lname##</td>
				<td>##TP_sort##</td>
				<td>##TP_balance##</td>
				<td>##TP_st_balance##</td>
				<td><a href="##TP_CGI_URL##?action=ADMIN::DEBT_MANAGEMENT::GoUpdateDetails&cust_id=##TP_cust_id##&debt_diary_id=##TP_debt_diary_id##">##TP_review_date##</a></td>
				<td>##TP_reviewed_at##</td>
				<td>##TP_letter_sent##</td>
				<td>##TP_max_bet##</td>
				<td>##TP_lp_date##</td>
				<td>##TP_lp_amount##</td>
				<td>
					##TP_IF {$DEBT_MAN([tpGetVar row_idx],notes)==""}##
						<a href="##TP_CGI_URL##?action=ADMIN::DEBT_MANAGEMENT::GoUpdateDetails&cust_id=##TP_cust_id##&debt_diary_id=##TP_debt_diary_id##">Add</a>
					##TP_ELSE##
						<a href="##TP_CGI_URL##?action=ADMIN::DEBT_MANAGEMENT::GoUpdateDetails&cust_id=##TP_cust_id##&debt_diary_id=##TP_debt_diary_id##">##TP_notes##</a>
					##TP_ENDIF##
				</td>
			</tr>
			##TP_ENDLOOP##
			##TP_IF {[OT_CfgGet RIGHTNOW_DEBT_MAN_ENABLED 1]}##
				##TP_IF {[tpBindGet state_code] == "DS1"}##
				<tr>
					<td class=buttons colspan=3>
						Choose New Review Date
					</td>
					<td class=buttons colspan=3>
						<input type="text" size="12" name="NewReviewDate" onChange="checkDate()">
					</td>
					<td class=buttons colspan=14>
						<input type=button class="btn_def" value="Change Review Date" onClick="return fs(this,'ChangeReviewDate')">
					</td>
				</tr>
				##TP_ENDIF##
			##TP_ELSE##
			<tr>
				<td class=buttons colspan=3>
				Choose Letter
				</td>
				<td class=buttons colspan=13>
					<select name="LetterSelect">
						##TP_LOOP letter_idx {[tpGetVar debt_num_letters]}##
							<option value="##TP_letter_id##">##TP_letter_name##</option>
						##TP_ENDLOOP##
							<option value="0" selected="selected">(New)</option>
					</select>&nbsp;&nbsp;&nbsp;
					<input type=button class="btn_def" value="Send Letter" onClick="return fs(this,'SendLetter')">
				</td>
			</tr>
			##TP_ENDIF##

			<tr>
				<td class=buttons colspan=16>
					<input type=button name="selectAll" class="btn_def" value="Select All" onClick="selectAllCusts(this)">
					<input type=button class="btn_def" value="Update Status" onClick="return fs(this,'MoveToNextState')">
					<input type=button class="btn_def" value="Remove from further processing" onClick="return fs(this,'RemoveFromDebtMan')">

					<input type=button class="btn_def" value="Back" onClick="return fs(this,'Back')">
				</td>
			</tr>
		</table>
		<input type="hidden" name="SubmitName" value="">
		<input type="hidden" name="action" value="ADMIN::DEBT_MANAGEMENT::DoDebtMan">
		<input type="hidden" name="DebtState" value="##TP_DebtState##">
		<input type="hidden" name="DiaryStatus" value="##TP_DiaryStatus##">
		<input type="hidden" name="ReviewDate" value="##TP_ReviewDate##">
		<input type="hidden" name="template_id" value="##TP_template_id##">
		<input type="hidden" name="AuditInfo" value="">
	</form>
</body>
</html>