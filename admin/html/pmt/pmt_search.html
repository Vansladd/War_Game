<html>
<!-- $Id: pmt_search.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>OpenBet Administration</title>
##TP_PLAY header_cal.html##
<script>
function fs(b,t)
{
	var label = b.value;

	b.disabled = true;
	b.value = "Busy...";

	##TP_IF {[OT_CfgGet VALIDATE_PMT_SEARCHES 0]}##
	// Validate to make sure we have a sensible search
	if (b.form.name == "payment_search" && !validate()) {
		b.disabled = false;
		b.value = label;
		return false;
	}
	##TP_ENDIF##

	b.form.SubmitName.value=t;
	b.form.submit();
	return true;
}

function validate_hours (date_fields, payment_range, payment_made_1, payment_made_2) {

	var date_1, date_2, hours;
	var date_unit = 1000*60*60; // This is the number of milliseconds in an hour (unit of time for config item)

		if (date_fields == "") {
			// Drop down still counts as a date.
			if (payment_range == "") {
				return 0;
			} else {
				date_1 = new Date();
				switch (payment_range) {
				case "HR":
					hours = 1;
					break;
				case "TD":
					hours = date_1.getHours();
					break;
				case "YD":
					hours = date_1.getHours() + 24;
					break;
				case "L3":
					hours = date_1.getHours() + 72;
					break;
				case "L7":
					hours = date_1.getHours() + 168;
					break;
				case "CM":
					// Assuming 30 days in a month
					date_2 = new Date(date_1.getFullYear(),date_1.getMonth(),1);
					hours = Math.ceil( (date_1.getTime() - date_2.getTime())/date_unit );
					break;
				}
			}
		} else {
			var re = new RegExp("[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}");
			if (payment_made_1 != "" && payment_made_2 != "") {

				if (!re.test(payment_made_1) || !re.test(payment_made_2)) {
					return 0;
				}

				date_1 = new Date(payment_made_1.substring(0,4),parseInt(payment_made_1.substring(5,7)) - 1,parseInt(payment_made_1.substring(8,10)));
				date_2 = new Date(payment_made_2.substring(0,4),parseInt(payment_made_2.substring(5,7)) - 1,parseInt(payment_made_2.substring(8,10)));

				date_1.setUTCHours(parseInt(payment_made_1.substring(11,13)));
				date_1.setMinutes(parseInt(payment_made_1.substring(14,16)));
				date_1.setSeconds(parseInt(payment_made_1.substring(17,19)));
				date_2.setUTCHours(parseInt(payment_made_2.substring(11,13)));
				date_2.setMinutes(parseInt(payment_made_2.substring(14,16)));
				date_2.setSeconds(parseInt(payment_made_2.substring(17,19)));

				// Actually do the calculation and set the number of hours
				hours = Math.ceil( (date_2.getTime() - date_1.getTime())/date_unit );

			} else {
				return 0;
			}
		}
		
		if (hours <= ##TP_TCL {tpBufWrite [OT_CfgGet PMT_SEARCH_HOUR_SOFT_LIMIT 6]}##) {
			return 2;
		} else if (hours <= ##TP_TCL {tpBufWrite [OT_CfgGet PMT_SEARCH_HOUR_HARD_LIMIT 24]}##) {
			return 1;
		} else {
			return 0;
		}
}

##TP_IF {[OT_CfgGet VALIDATE_PMT_SEARCHES 0]}##
function validate()
{
	var payment_made_1    = document.forms.payment_search.SR_date_1.value;
	var	payment_made_2    = document.forms.payment_search.SR_date_2.value;
	var	payment_range     = document.forms.payment_search.SR_date_range.value;
	var	date_fields       = payment_made_1 + payment_made_2;
	
	var compulsory_fields = 
			document.forms.payment_search.SR_username.value +
			document.forms.payment_search.SR_lname.value + 
			document.forms.payment_search.SR_email.value +
			document.forms.payment_search.SR_acct_no.value +
			document.forms.payment_search.SR_PMT_ID.value +
			document.forms.payment_search.SR_REF_NO.value +
			document.forms.payment_search.SR_operator.value +
			document.forms.payment_search.SR_settled_by.value;
	
	var	hours = 0;
	var date_1, date_2;
	var	username = document.forms.payment_search.SR_username.value;
	var	valid_username;
	var	hard_limit = ##TP_TCL {tpBufWrite [OT_CfgGet PMT_SEARCH_HOUR_HARD_LIMIT 24]}##;
	var	min_username = ##TP_TCL {tpBufWrite [OT_CfgGet PMT_MIN_USERNAME_SEARCH 3]}##;

	// If we've got no dates and no compulsory fields, then we shouldn't run the search
	if (compulsory_fields == "" || document.forms.payment_search.SR_username.value != "") {
	
		var valid_hours = validate_hours(date_fields, payment_range, payment_made_1, payment_made_2);
		
		if (username.length < min_username) {
			valid_username = 0;
		} else {
			valid_username = 1;
		}

		if (valid_username == 1 || valid_hours == 2) {
			return 1;
		} else if (valid_hours == 1) {
			if (confirm("This query may return a large number of results. Continue?")) {
				return 1;
			} else {
				return 0;
			}
		} else {
			alert("The search you have entered will return a LOT of payments. Please redefine it to include at least one of the following fields: \
			   \n\t- Username (at least 3 characters) \
			   \n\t- Surname \
			   \n\t- Email \
			   \n\t- Account No \
			   \n\t- Payment ID \
			   \n\t- Payment Ref No \
			   \n\t- Operator username \
			   \n\t- Settled by username \
			   \n\t- Date Range (Total hours in range must be less than " + hard_limit + " if none of the above are filled)");
			return 0;
		}		
		
		
	} else {
		// We've got something in the compulsory fields somewhere
		return 1;	
	}
}
##TP_ENDIF##



function displayCalendars() {
	new Calendar(document.forms.payment_search.SR_date_1,null,true,"lo")
	new Calendar(document.forms.payment_search.SR_date_2,null,true,"lo")
}
</script>
##TP_PLAY JS_WriteSelect.html##
</head>
<body onload="displayCalendars()">
##TP_PLAY error_rpt.html##
<table cellspacing=0 cellpadding=2 border=0>
<form name="payment_search" method=get action=##TP_CGI_URL##>
	<input type="hidden" name="toFile" value="0">
<tr>
	<th colspan=3 class=title>
	Payment Search
	</th>
</tr>
<tr class=subtitle>
	<th colspan=2 align=left>Customer information</th>
</tr>
<tr>
	<td class=captionindex>Username like</td>
	<td><input type="text" name="SR_username" value="" size=32>&nbsp;
	(case insensitive&nbsp;
	<input type="checkbox" name="SR_upper_username" value="Y" ##TP_IF {[OT_CfgGet FUNC_DEF_CASE_INS_SEARCH 0] == 1}##checked##TP_ENDIF##>
	&nbsp;)</td>
</tr>
<tr>
	<td class=caption>Name</td>
	<td><input type="text" name="SR_fname" value="" size=16>
	&nbsp;&nbsp;
	<input type="text" name="SR_lname" value="" size=16></td>
</tr>
<tr>
	<td class=caption>Email like</td>
	<td><input type="text" name="SR_email" value="" size=40></td>
</tr>
<tr>
	<td class=captionindex>Account No</td>
	<td><input type="text"  name="SR_acct_no" value="" size=32>&nbsp;
	(exact&nbsp;
	<input type="checkbox" name="SR_acct_no_exact" value="Y" checked>
	&nbsp;)
    </td>
</tr>
<tr>
	<td class=caption>Betting currency</td>
	<td>
	<select name="SR_CCYCode">
		<option value="">N/A</option>
	##TP_LOOP ccy_idx {[tpGetVar NumCCYs]}##
		<option value="##TP_CCYCode##">##TP_CCYName##</option>
	##TP_ENDLOOP##
	</select>
	</td>
</tr>
<tr>
	<td class=caption>Registration country</td>
	<td>
	<select name="SR_CNTRYCode">
		<option value="">N/A</option>
	##TP_LOOP cntry_idx {[tpGetVar NumCNTRYs]}##
		<option value="##TP_CNTRYCode##">##TP_CNTRYName##</option>
	##TP_ENDLOOP##
	</select>
	</td>
</tr>
##TP_IF {[OT_CfgGetTrue FUNC_PMT_SEARCH_CUST_GRP]}##
<tr>
	<td class="caption">Customer Group</td>
	<td>
	<select name="SR_CustGrp">
		<option value="">N/A</option>
		<option value="OPT_AllPlatinum">All Platinum Customers</option>
		##TP_LOOP ccc_idx {[tpGetVar NumCCode]}##
		<option value="##TP_CCCode##">##TP_CCDesc##</option>
		##TP_ENDLOOP##
	</select>
	</td>
</tr>
##TP_ENDIF##
<tr class=subtitle>
	<th colspan=2 align=left>Payment details</th>
</tr>
<tr>
	<td class=captionindex>Date Range</td>
	<td>
	<input type="text" name="SR_date_1" value="" size=19>
	&nbsp;and&nbsp;
	<input type="text" name="SR_date_2" value="" size=19>&nbsp;(yyyy-mm-dd hh:mm:ss)
	</td>
</tr>
<tr>
	<td class=captionindex>or</td>
	<td>
	<select name="SR_date_range">
		<option value="">n/a</option>
		<option value="HR" selected>Last hour</option>
		<option value="TD">Today</option>
		<option value="YD">Yesterday</option>
		<option value="L3">Last 3 days</option>
		<option value="L7">Last 7 days</option>
		<option value="CM">Current month</option>
	</select>
	</td>
</tr>
<tr>
	<td class=caption>Status</td>
	<td>
	<select name="SR_status">
		<option value="">Any</option>
		<option value="Y">Good</option>
		<option value="N">Bad</option>
		<option value="P">Pending (Non Delayed)</option>
		<option value="PD">Pending (Delayed)</option>
		<option value="R">Referred</option>
		<option value="I">Incomplete</option>
		<option value="RI">Referred or Incomplete</option>
		<option value="L">Later</option>
		<option value="W">3DSecure Incomplete</option>
		<option value="X">Cancelled</option>
		<option value="U">Unknown</option>
		<option value="B">Reversed</option>
	</select>
	</td>
</tr>
<tr>
	<td class=caption>Type</td>
	<td>
	<select name="SR_pay_mthd">
	<script>
	write_select(""
		,"","Any"
		##TP_LOOP mthd_idx {[tpGetVar NumMthds]}##
                  ##TP_IF {[tpGetVar mthd_idx] == $basc_index && [OT_CfgGet OPENBET_CUST] == "LADBROKES"}##
			,"##TP_pay_mthd##","MCA"
		  ##TP_ELSE##
		        ,"##TP_pay_mthd##","##TP_pay_mthd_desc##"
		  ##TP_ENDIF##
		##TP_ENDLOOP##
	)
	</script>
	</select>
	&nbsp;
	(show outlet&nbsp;
	<input type="checkbox" name="SR_show_outlet" value="Y">
	&nbsp;)
	</td>
</tr>
<tr>
	<td class=caption>Sort</td>
	<td>
	<select name="SR_payment_sort">
		<option value="">Any</option>
		<option value="D">Deposit</option>
		<option value="W">Withdrawal</option>
	</select>
	</td>
</tr>
##TP_TCL {make_channel_binds "" -}##
<tr>
	<td class=caption>Channel</td>
	<td>
	<select name="SR_channel">
		<option value="">All</option>
		##TP_LOOP chan_idx {[tpGetVar NumChannels]}##
			<option value="##TP_ChanCode##">##TP_ChanName##</option>
		##TP_ENDLOOP##
	</select>
	</td>
</tr>
##TP_IF {[OT_CfgGet 3DSECURE_RESUBMIT_POLICY_CODES 0]}##
<tr>
	<td class=caption>Resubmission status</td>
	<td>
		<select name="SR_resub_status">
			<option value="">All</option>
			<option value="R">Resubmitted payments only</option>
			<option value="E">Initial failed payments for resubmission</option>
		</select>
	</td>
</tr>
##TP_ENDIF##
<tr>
	<td class=caption>Pmt Gateway</td>
	<td>
	<select name="SR_PG_host">
		<option value="">All</option>
		##TP_LOOP pg_host_idx {[tpGetVar NumPGHosts]}##
			<option value="##TP_pg_host_id##">##TP_pg_host_desc##</option>
		##TP_ENDLOOP##
	</select>
	</td>
</tr>
<tr>
	<td class=caption>Merchant Acct</td>
	<td>
	<select name="SR_PG_acct">
		<option value="">All</option>
		##TP_LOOP pg_acct_idx {[tpGetVar NumPGAccts]}##
			<option value="##TP_pg_acct_id##">##TP_pg_acct_desc##</option>
		##TP_ENDLOOP##
	</select>
	</td>
</tr>
<tr>
	<td class="caption">Payment ID</td>
	<td><input type="text" name="SR_PMT_ID" value="" /></td>
</tr>
##TP_IF {[OT_CfgGet PMT_RECEIPT_FUNC 0]}##
<tr>
	<td class="caption">Payment Receipt</td>
	<td><input type="text" name="SR_pmt_receipt" value="" /></td>
</tr>
##TP_ENDIF##
<tr>
	<td class="caption">Payment Ref No:</td>
	<td><input type="text" name="SR_REF_NO" value="" /></td>
</tr>
<tr>
	<td class="caption">Operator username</td>
	<td><input type="text" name="SR_operator" value="" /></td>
</tr>
<tr>
	<td class="caption">Settled by username</td>
	<td><input type="text" name="SR_settled_by" value="" /></td>
</tr>
##TP_IF {[OT_CfgGet FUNC_BASIC_PAY 0] == 1}##
<tr>
        <td class="caption">Ref Number</td>
        <td><input type="text" maxlength="8" name="SR_REF_NUM" value="" />&nbsp;<small>(##TP_IF {[OT_CfgGet OPENBET_CUST] == "LADBROKES"}##MCA##TP_ELSE##Basic Pay##TP_ENDIF## Only)</small></td>
</tr>
##TP_ENDIF##
##TP_IF {[OT_CfgGet FUNC_PAY_SEARCH_ON_FULFILL 0] == 1}##
<tr>
        <td class="caption">Fulfilled?</td>
		<td>
			<select name="SR_fulfilled">
				<option value="">Any</option>
				<option value="Y">Fullfilled</option>
				<option value="N">Not fulfilled</option>
			</select>
		</td>
</tr>
<tr>
        <td class="caption">Fulfil Status</td>
		<td>
			<select name="SR_fulfil_status">
				<option value="">Any</option>
				<option value="Y">Only good fulfils</option>
				<option value="N">Only bad fulfils</option>
			</select>
		</td>
</tr>
<tr>
        <td class="caption">Fraud Check Status</td>
		<td>
			<select name="SR_fc_auth_status">
				<option value="">Any</option>
				<option value="P">Pending Authorisation</option>
				<option value="Y">Approved</option>
				<option value="N">Declined</option>
			</select> OR
		</td>
</tr>
<tr>
        <td class="caption">Large Return Status</td>
		<td>
			<select name="SR_lr_auth_status">
				<option value="">Any</option>
				<option value="P">Pending Authorisation</option>
				<option value="Y">Approved</option>
				<option value="N">Declined</option>
			</select>
		</td>
</tr>
##TP_ENDIF##
<tr>
	<th class=buttons colspan=3>
	<input type=button class="btn_def" value="Find Payments" onClick="return fs(this,'DoPmtQry')">
	</th>
</tr>
<input type=hidden name=SubmitName value="">
<input type=hidden name=action value=ADMIN::PMT::do_pmt_query>
</form>
</table>

##TP_IF {[OT_CfgGet FUNC_PAYPAL 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="" />
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_paypal_query" />
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">PayPal Transaction Search</th></tr>
		<tr>
			<td><label for="pp_txn_id">Transaction Id</label></td>
			<td><input id="pp_txn_id" name="pp_txn_id" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtPayPalQry')" />
			</th>
		</tr>
		</table>

	</form>
##TP_ENDIF##

##TP_IF {[OT_CfgGet FUNC_UKASH 0]}##
<br/>
<form method="post" action="##TP_CGI_URL##">
<input type="hidden" name="pay_mthd" value="UKSH" />
<table cellspacing="0" cellpadding="2" border="0">
<tr><th colspan="2" class="title">Quickcash Search</th></tr>
<tr>
	<td><label for="ukash_voucher">Voucher</label></td>
	<td><input id="ukash_voucher" name="ukash_voucher" type="text" value="" size="22" /></td>
</tr>
<tr>
	<td><label for="ukash_txn_id">Transaction Id</label></td>
	<td><input id="ukash_txn_id" name="ukash_txn_id" type="text" value="" size="22" /></td>
</tr>
<tr>
	<th class="buttons" colspan="2">
		<input type="button" value="Find Payment" onClick="return fs(this,'DoPmtUkashQry')" />
	</th>
</tr>
</table>
<input type="hidden" name="SubmitName" value="" />
<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_ukash_query" />
</form>
##TP_ENDIF Ukash##

##TP_IF {[OT_CfgGet FUNC_IKSH 0]}##
<br/>
<form method="post" action="##TP_CGI_URL##">
<input type="hidden" name="pay_mthd" value="IKSH" />
<table cellspacing="0" cellpadding="2" border="0">
<tr><th colspan="2" class="title">Ukash International Search</th></tr>
<tr>
	<td><label for="ukash_voucher">Voucher</label></td>
	<td><input id="ukash_voucher" name="ukash_voucher" type="text" value="" size="22" /></td>
</tr>
<tr>
	<td><label for="ukash_txn_id">Transaction Id</label></td>
	<td><input id="ukash_txn_id" name="ukash_txn_id" type="text" value="" size="22" /></td>
</tr>
<tr>
	<th class="buttons" colspan="2">
		<input type="button" value="Find Payment" onClick="return fs(this,'DoPmtUkashQry')" />
	</th>
</tr>
</table>
<input type="hidden" name="SubmitName" value="" />
<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_ukash_query" />
</form>
##TP_ENDIF IKSH##

##TP_IF {[OT_CfgGet FUNC_NETELLER 0]}##
<br/>
<form method="post" action="##TP_CGI_URL##">
<table cellspacing="0" cellpadding="2" border="0">
<tr><th colspan="2" class="title">Neteller Transaction Search</th></tr>
<tr>
	<td><label for="ntlr_txn_id">Transaction Id</label></td>
	<td><input id="ntlr_txn_id" name="ntlr_txn_id" type="text" value="" /></td>
</tr>
<tr>
	<th class="buttons" colspan="2">
		<input type="button" value="Find Payment" onClick="return fs(this,'DoPmtNtlrQry')" />
	</th>
</tr>
</table>
<input type="hidden" name="SubmitName" value="" />
<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_ntlr_query" />
</form>
##TP_ENDIF Neteller##

##TP_IF {[OT_CfgGet FUNC_CLICKANDBUY 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="" />
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_clickandbuy_query" />
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">Click and Buy Transaction Search</th></tr>
		<tr>
			<td><label for="cb_bdr_id">BDR Id</label></td>
			<td><input id="cb_bdr_id" name="cb_bdr_id" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtClickAndBuyQry')" />
			</th>
		</tr>
		</table>
	</form>
##TP_ENDIF##

##TP_IF {[OT_CfgGet FUNC_CLICK2PAY 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="" />
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_click2pay_query" />
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">Click2Pay Transaction Search</th></tr>
		<tr>
			<td><label for="gw_uid">Gateway UID</label></td>
			<td><input id="gw_uid" name="gw_uid" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtClick2PayQry')" />
			</th>
		</tr>
		</table>
	</form>
##TP_ENDIF##

##TP_IF {[OT_CfgGet FUNC_MONEYBOOKERS 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="" />
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_moneybookers_query" />
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">Money Bookers Transaction Search</th></tr>
		<tr>
			<td><label for="mb_transaction_id">Ref Id</label></td>
			<td><input id="mb_transaction_id" name="mb_transaction_id" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtMoneyBookersQry')" />
			</th>
		</tr>
		</table>
	</form>
##TP_ENDIF##

##TP_IF {[OT_CfgGet FUNC_ENVOY 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="">
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_envoy_query" />
		
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">Envoy EPACS Search</th></tr>
		<tr>
			<td><label for="envoy_epac_ref">EPAC</label></td>
			<td><input id="envoy_epac_ref" name="envoy_epac_ref" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtEnvoyQry')" />
			</th>
		</tr>
		</table>
	</form>
##TP_ENDIF##

##TP_IF {[OT_CfgGet FUNC_PSC 0]}##
	<br/>
	<form method="post" action="##TP_CGI_URL##">
		<input type="hidden" name="SubmitName" value="" />
		<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_paysafecard_query" />
		<table cellspacing="0" cellpadding="2" border="0">
		<tr><th colspan="2" class="title">PSC Transaction Search</th></tr>
		<tr>
			<td><label for="psc_transaction_id">MTID</label></td>
			<td><input id="psc_transaction_id" name="psc_transaction_id" type="text" value="" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" value="Find Payment" class="btn_def" onClick="return fs(this,'DoPmtPaySafeCardQry')" />
			</th>
		</tr>
		</table>
	</form>
##TP_ENDIF##

</body>
</html>

