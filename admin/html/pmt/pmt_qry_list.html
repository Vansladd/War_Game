<html>
<!-- $Id: pmt_qry_list.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>OpenBet Administration</title>
##TP_PLAY JS_WriteSelect.html##
<script>

var authArr = [];
var authLRArr = [];
var authFCArr = [];
var declArr = [];

function wr_tr(status) {
		if (status=="Y") {
			document.write('<tr class=active>');
		} else if (status=="N") {
			document.write('<tr class=suspended>');
		} else if (status=='U') {
			document.write('<tr class=unknown>');
		} else if (status=='B') {
			document.write('<tr class=confirm>');
		} else {
			document.write('<tr class=settled>');
		}
}
function fs(b,t)
{
	chcked = true;
	if (t == 'AuthoriseLR') {
		//check if any of the boxes are ticked
		chcked = false;
		for (var i = 0; i < authLRArr.length; i++) {
			if (eval('b.form.'+authLRArr[i]+'.checked') == 1) {
				chcked = true;
			}
		}
	} else if (t == 'AuthoriseFC') {
		//check if any of the boxes are ticked
		chcked = false;
		for (var i = 0; i < authFCArr.length; i++) {
			if (eval('b.form.'+authFCArr[i]+'.checked') == 1) {
				chcked = true;
			}
		}
	} else if (t == 'Authorise') {
		//check if any of the boxes are ticked
		chcked = false;
		for (var i = 0; i < authArr.length; i++) {
			if (eval('b.form.'+authArr[i]+'.checked') == 1) {
				chcked = true;
			}
		}
	} else if (t == 'Decline') {
		//check if any of the boxes are ticked
		chcked = false;
		for (var i = 0; i < declArr.length; i++) {
			if (eval('b.form.'+declArr[i]+'.checked') == 1) {
				chcked = true;
			}
		}
	}
	if (chcked) {
		b.disabled = true;
		b.value = "Busy...";
		b.form.SubmitName.value=t;
		b.form.submit();
		return true;
	} else {
		alert("You must check at least one "+t+" checkbox.");
		return false;
	}
}

var multi_auth_cc_only =
	##TP_IF { [OT_CfgGetTrue FUNC_MULTI_AUTH_CC_ONLY] }##
		true;
	##TP_ELSE##
		false;
	##TP_ENDIF##

var wu_sgl_wtd_auth =
	##TP_IF { [OT_CfgGetTrue FUNC_WU_SINGLE_WTD_AUTH] }##
		true;
	##TP_ELSE##
		false;
	##TP_ENDIF##


function write_auth_decl(status, pay_mthd, prefix, pmt_id, pay_sort, pg_trans_type, fulfilled_at, state, fraud_flags, checked)
{
	if (fraud_flags != '') {
		document.write(fraud_flags);
		return;
	}

	// Pending deposits via Neteller, Click2Pay, MoneyBooker and ClickAndBuy can
	// never be manually authorised (Cf. make_payment.tcl).
	if (status != 'U') {
		if ( prefix == 'auth' && pay_sort == 'D' && (pay_mthd == 'NTLR' || pay_mthd == 'C2P' || pay_mthd == 'MB' || pay_mthd == 'CB')) {
			document.write('&nbsp;');
			return;
		}
	}

	if (status=='P' && pay_mthd != 'PB' || pg_trans_type == 'E' && status=='Y' && fulfilled_at == "" || status =='U') {
		if (prefix == 'decl') {
			declArr[declArr.length] = prefix+'_'+pmt_id;
			document.write('<input type=checkbox name='+prefix+'_'+pmt_id+' value=Y ' + checked + '></td>');
		} else {
			if (pg_trans_type == 'E' || (pay_mthd == 'MB' && status == 'P') || (pay_mthd == 'PPAL' && status=='P') || (pay_mthd == 'PSC' && status=='P') ) {
				document.write('&nbsp;');
			} else {
				if (prefix == 'auth_lr') {
					authLRArr[authLRArr.length] = prefix+'_'+pmt_id;
				} else if (prefix == 'auth_fc') {
					authFCArr[authFCArr.length] = prefix+'_'+pmt_id;
				} else {
					authArr[authArr.length] = prefix+'_'+pmt_id;
				}
				document.write('<input type=checkbox name='+prefix+'_'+pmt_id+' value=Y '+ checked + ' ' + state+'></td>');
			}
		}
	} else {
		document.write('&nbsp;');
	}
}

function executePSCRetry(b, pmt_id, cust_id)
{
	document.pmt_auth_form.pmt_id.value  = pmt_id;
	document.pmt_auth_form.cust_id.value = cust_id;

	return fs(b,'DoPSCPmtRetry');

}


</script>
</head>
<body>
##TP_IF {[tpGetVar IS_ELITE 0]!=0}##
	<font color="red"><b>&nbsp; * Elite Customer</b></font>
##TP_ENDIF##
##TP_PLAY error_rpt.html##
##TP_PLAY msg_rpt.html##
<form name="pmt_auth_form" action="##TP_CGI_URL##" method="post">
<table cellspacing=0 cellpadding=2 border=0>
	<input type="hidden" name="SubmitName" value="">
	<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_auth">
	<!-- bind search options -->
	<input type="hidden" name="SR_username" value="##TP_SR_username##">
	<input type="hidden" name="SR_upper_username" value="##TP_SR_upper_username##">
	<input type="hidden" name="SR_fname" value="##TP_SR_fname##">
	<input type="hidden" name="SR_lname" value="##TP_SR_lname##">
	<input type="hidden" name="SR_email" value="##TP_SR_email##">
    <input type="hidden" name="SR_acct_no_exact" value="##TP_SR_acct_no_exact##">
	<input type="hidden" name="SR_acct_no" value="##TP_SR_acct_no##">
	<input type="hidden" name="SR_date_1" value="##TP_SR_date_1##">
	<input type="hidden" name="SR_date_2" value="##TP_SR_date_2##">
	<input type="hidden" name="SR_date_range" value="##TP_SR_date_range##">
	<input type="hidden" name="SR_status" value="##TP_SR_status##">
	<input type="hidden" name="SR_payment_sort" value="##TP_SR_payment_sort##">
	<input type="hidden" name="SR_channel" value="##TP_SR_channel##">
	<input type="hidden" name="SR_pay_mthd" value="##TP_SR_pay_mthd##">
	<input type="hidden" name="SR_CCYCode" value="##TP_SR_CCYCode##">
	<input type="hidden" name="SR_CNTRYCode" value="##TP_SR_CNTRYCode##">
	<input type="hidden" name="SR_cust_id" value="##TP_SR_cust_id##">
	<input type="hidden" name="SR_PMT_ID" value="##TP_SR_PMT_ID##">
	<input type="hidden" name="SR_fc_auth_status" value="##TP_SR_fc_auth_status##">
	<input type="hidden" name="SR_lr_auth_status" value="##TP_SR_lr_auth_status##">
	<input type="hidden" name="toFile" value="0">
	<input type="hidden" name="pmt_id" value="">
	<input type="hidden" name="cust_id" value="">

	<tr>
		<th colspan="21" class="title">
		Payment search results
		</th>
	</tr>
	<tr>
		<th nowrap class=colhead>Date</th>
		<th nowrap class=colhead>Method</th>
		<th nowrap class=colhead>Sort</th>
		<th nowrap class=colhead>Status</th>
		<th nowrap class=colhead>Fulfil Status</th>
		<th nowrap class=colhead>Source</th>
		##TP_IF {[tpGetVar SR_show_outlet] == "Y"}##
		<th nowrap class=colhead>Outlet</th>
		##TP_ENDIF##
		<th nowrap class=colhead>Username</th>
		##TP_IF {[OT_CfgGetTrue FUNC_PMT_SEARCH_CUST_GRP]}##
			<th nowrap class="colhead">Group</th>
		##TP_ENDIF##
		<th nowrap class=colhead>AccountNo</th>
		<th nowrap class=colhead>PmtId</th>
		<th nowrap class=colhead>Ref No</th>
		<th nowrap class=colhead>CCY</th>
		<th nowrap class=colhead>Amount</th>
		##TP_IF {[tpGetVar PendFraudCheck 0]==1}##
		<th nowrap class=colhead>Fraud Check Authorise</th>
		<th nowrap class=colhead>Large Returns Authorise</th>
		<th nowrap class=colhead>Decline</th>
		##TP_ELSE##
		##TP_IF {[op_allowed PmtAuthDecline]}##
		<th nowrap class=colhead>Authorise</th>
		<th nowrap class=colhead>Decline</th>
		##TP_ENDIF##
		##TP_IF {[OT_CfgGet 3DSECURE_RESUBMIT_POLICY_CODES 0]}##
		<th nowrap class=colhead>Prev PmtId</th>
		<th nowrap class=colhead>Resub PmtId</th>
		##TP_ENDIF##
		<th nowrap class=colhead>IP Address</th>
		<th nowrap class=colhead>CC Return Message</th>
		<th nowrap class=colhead>Fulfilled At</th>
		<th nowrap class=colhead>Last Fulfil Attempt</th>
			##TP_IF {[OT_CfgGet FUNC_PAYBOX 0]}##
			<th nowrap class=colhead>Paybox Return Message</th>
			##TP_ENDIF##
		##TP_ENDIF##
	</tr>
	##TP_IF {[tpGetVar NumPmts 0]==0}##
	<tr>
		<td colspan=15 align=center>
		No payments match your search criteria
		</td>
	</tr>
	##TP_ELSE##
	<input type=hidden name=NumPmts value="##TP_TCL {tpGetVar NumPmts}##">
	##TP_LOOP pmt_idx {[tpGetVar NumPmts]}##
	<input type=hidden name="row_##TP_TCL {tpGetVar pmt_idx}##" value="##TP_pmt_id##">
	<input type=hidden name="pay_mthd_##TP_TCL {tpGetVar pmt_idx}##" value="##TP_PmtMthd##">
	<input type=hidden name="pay_sort_##TP_pmt_id##" value="##TP_PmtSort##">
	<input type=hidden name="pay_amt_##TP_pmt_id##" value="##TP_Amount##">
	<input type=hidden name="sys_amt_##TP_pmt_id##" value="##TP_Sys_amt##">
	<input type=hidden name="pay_ccy_##TP_pmt_id##" value="##TP_CCYCode##">
	<input type=hidden name="cust_id_##TP_pmt_id##" value="##TP_CustId##">

	<script>wr_tr("##TP_PmtStatus##")</script>
		<td nowrap>##TP_Date##</td>
		<td nowrap>##TP_TCL { tpBufWrite [tpBindGet CPM_Desc_[tpGetVar pmt_idx]]} ##</td>
		<td nowrap>##TP_PmtSort##</td>
		<td nowrap>##TP_PmtStatus##
		##TP_IF {[tpBindGet PmtMthd] == "PSC" && [tpBindGet PmtStatus] == "I"}##
			<input type="button" value="Retry" onClick="executePSCRetry(this,'##TP_pmt_id##','##TP_CustId##');" />
		##TP_ENDIF##
		</td>
		<td nowrap align=left>##TP_FulfilStatus##&nbsp;</td>
		<td nowrap>##TP_PmtSource##</td>
		##TP_IF {[tpGetVar SR_show_outlet] == "Y"}##
		<td nowrap>##TP_Outlet##</td>
		##TP_ENDIF##
		##TP_IF {[tpGetVar PERM_ViewCustInfo 0]}##
		<td nowrap>##TP_IF {[op_allowed EliteCustAccess] || (![op_allowed EliteCustAccess] && [tpBindGet Elite] != "Y")}##<a class="mark_vstd" href="##TP_CGI_URL##?action=ADMIN::CUST::GoCust&CustId=##TP_CustId##">##TP_Username##</a>##TP_ELSE##*##TP_ENDIF##</td>
		##TP_ELSE##
			##TP_IF {[op_allowed EliteCustAccess] || (![op_allowed EliteCustAccess] && [tpBindGet Elite] != "Y")}## ##TP_Username## ##TP_ELSE##*##TP_ENDIF##
		##TP_ENDIF##
		##TP_IF {[OT_CfgGetTrue FUNC_PMT_SEARCH_CUST_GRP]}##
			<td nowrap>##TP_CustGroup##</td>
		##TP_ENDIF##
		<td nowrap>##TP_IF {[op_allowed EliteCustAccess] || (![op_allowed EliteCustAccess] && [tpBindGet Elite] != "Y")}##<a href="##TP_CGI_URL##?action=ADMIN::CUST::GoCust&CustId=##TP_CustId##">##TP_AcctNo##</a>##TP_ELSE## ##TP_AcctNo## ##TP_ENDIF##</td>
		<td nowrap><a href="##TP_CGI_URL##?action=ADMIN::TXN::GPMT::GoPmt&pmt_id=##TP_pmt_id##&SR_username=##TP_SR_username##&SR_upper_username=##TP_SR_upper_username##&SR_fname=##TP_SR_fname##&SR_lname=##TP_SR_lname##&SR_email=##TP_SR_email##&SR_acct_no=##TP_SR_acct_no##& SR_date_1=##TP_SR_date_1##&SR_date_2=##TP_SR_date_2##&SR_date_range=##TP_SR_date_range##&&SR_status=##TP_SR_status##&SR_payment_sort=##TP_SR_payment_sort##&SR_channel=##TP_SR_channel##&SR_pay_mthd=##TP_SR_pay_mthd##">##TP_pmt_id##</a></td>
    <td nowrap>##TP_RefNo####TP_EpRefNo##&nbsp;</td>
		<td nowrap>##TP_CCYCode##</td>
		<td nowrap align=right>##TP_Amount##</td>

		##TP_IF {[tpGetVar PendFraudCheck 0]==1}##
		<td nowrap align=center>
			<script type="text/javascript">
				write_auth_decl('##TP_FraudCheckAuth##','##TP_PmtMthd##','auth_fc','##TP_pmt_id##', '##TP_PmtSort##' , '##TP_PG_TRANS_TYPE##', '##TP_FulfilledAt##','##TP_Auth_Disabled##','','##TP_auth_check_fc##');
			</script>
		</td>
		<td nowrap align=center>
			<script type="text/javascript">
				write_auth_decl('##TP_LargeRetAuth##','##TP_PmtMthd##','auth_lr','##TP_pmt_id##', '##TP_PmtSort##' , '##TP_PG_TRANS_TYPE##', '##TP_FulfilledAt##','##TP_Auth_Disabled##','','##TP_auth_check_lr##');
			</script>
		</td>

			##TP_IF {[op_allowed PmtAuthDecline]}##
		<td nowrap align=center>
			<script type="text/javascript">
				write_auth_decl('##TP_PmtStatus##','##TP_PmtMthd##','decl','##TP_pmt_id##', '##TP_PmtSort##', '##TP_PG_TRANS_TYPE##', '##TP_FulfilledAt##','','','##TP_decl_check##');
			</script>
		</td>
			##TP_ENDIF##

		##TP_ELSE##
			##TP_IF {[op_allowed PmtAuthDecline]}##
		<td nowrap align=center>
			<script type="text/javascript">
				write_auth_decl('##TP_PmtStatus##','##TP_PmtMthd##','auth','##TP_pmt_id##', '##TP_PmtSort##' , '##TP_PG_TRANS_TYPE##', '##TP_FulfilledAt##','##TP_Auth_Disabled##','##TP_FraudFlags##','##TP_auth_check##');
			</script>
		</td>
		<td nowrap align=center>
			<script type="text/javascript">
				write_auth_decl('##TP_PmtStatus##','##TP_PmtMthd##','decl','##TP_pmt_id##', '##TP_PmtSort##', '##TP_PG_TRANS_TYPE##', '##TP_FulfilledAt##','','','##TP_decl_check##');
			</script>
		</td>
			##TP_ENDIF##

		##TP_IF {[OT_CfgGet 3DSECURE_RESUBMIT_POLICY_CODES 0]}##
		<td nowrap align=left><a href="##TP_CGI_URL##?action=ADMIN::TXN::GPMT::GoPmt&pmt_id=##TP_prev_pmt_id##&SR_username=##TP_SR_username##&SR_upper_username=##TP_SR_upper_username##&SR_fname=##TP_SR_fname##&SR_lname=##TP_SR_lname##&SR_email=##TP_SR_email##&SR_acct_no=##TP_SR_acct_no##& SR_date_1=##TP_SR_date_1##&SR_date_2=##TP_SR_date_2##&SR_date_range=##TP_SR_date_range##&&SR_status=##TP_SR_status##&SR_payment_sort=##TP_SR_payment_sort##&SR_channel=##TP_SR_channel##&SR_pay_mthd=##TP_SR_pay_mthd##">##TP_prev_pmt_id##</a></td>
		<td nowrap align=left><a href="##TP_CGI_URL##?action=ADMIN::TXN::GPMT::GoPmt&pmt_id=##TP_retry_pmt_id##&SR_username=##TP_SR_username##&SR_upper_username=##TP_SR_upper_username##&SR_fname=##TP_SR_fname##&SR_lname=##TP_SR_lname##&SR_email=##TP_SR_email##&SR_acct_no=##TP_SR_acct_no##& SR_date_1=##TP_SR_date_1##&SR_date_2=##TP_SR_date_2##&SR_date_range=##TP_SR_date_range##&&SR_status=##TP_SR_status##&SR_payment_sort=##TP_SR_payment_sort##&SR_channel=##TP_SR_channel##&SR_pay_mthd=##TP_SR_pay_mthd##">##TP_retry_pmt_id##</a></td>
		##TP_ENDIF##
		<td nowrap align=left>##TP_IPAddress##&nbsp;</td>
		<td nowrap align=left>##TP_CC_ret_msg##&nbsp;</td>
		<td nowrap align=left>##TP_FulfilledAt##&nbsp;</td>
		<td nowrap align=left>##TP_LastFulfilAttempt##&nbsp;</td>
			##TP_IF {[OT_CfgGet FUNC_PAYBOX 0]}##
			<td nowrap align=left>##TP_PB_ret_msg##&nbsp;</td>
			##TP_ENDIF##
		##TP_ENDIF##
	</tr>
	##TP_ENDLOOP##
	##TP_IF {[op_allowed PmtAuthDecline]}##
	<tr>
		<th colspan=8 class="buttons">
			##TP_IF {[tpGetVar PendFraudCheck 0]==1}##
			<input type=button class="btn_def" value="Authorise Large Returns" onClick="return fs(this,'AuthoriseLR')">
			<input type=button class="btn_def" value="Authorise Fraud Check" onClick="return fs(this,'AuthoriseFC')">
			##TP_ELSE##
			<input type=button class="btn_def" value="Authorise Payments" onClick="return fs(this,'Authorise')">
			##TP_ENDIF##
			<input type=button class="btn_def" value="Decline Payments" onClick="return fs(this,'Decline')">
		</th>
		<th colspan=8 class="buttons" align=right>
		##TP_IF {[tpGetVar PendFraudCheck 0]==1}##
			<select name="MarkActionFC">
				<script>write_select('A','A','Mark Fraud Check Authorised','D','Mark Declined','U','Uncheck')</script>
			</select>
			<input type=button class="btn_def" value="Go" onClick="return fs(this,'UpdMarksFC')">
			<select name="MarkActionLR">
				<script>write_select('A','A','Mark Large Returns Authorised','D','Mark Declined','U','Uncheck')</script>
			</select>
			<input type=button class="btn_def" value="Go" onClick="return fs(this,'UpdMarksLR')">
		##TP_ELSE##
			<select name="MarkAction">
				<script>write_select('A','A','Mark Authorised','D','Mark Declined','U','Uncheck')</script>
			</select>
			<input type=button class="btn_def" value="Go" onClick="return fs(this,'UpdMarks')">
		##TP_ENDIF##
		</th>
	</tr>
	##TP_ENDIF##
	##TP_ENDIF##
</table>
<br>
<br>

<table cellspacing=0 cellpadding=2 border=0>
	<tr>
		<th colspan=15 class=title>
		Payment search results
		</th>
	</tr>
	<tr>
		<th nowrap class=colhead>Currency</th>
		<th nowrap class=colhead align=right>Total</th>
	</tr>
	##TP_LOOP s_idx {[tpGetVar SUM_nrows]}##
	<tr>
		<th nowrap>##TP_SUM_ccy##</th>
		<th nowrap align=right>##TP_SUM_total##</th>
	</tr>
	##TP_ENDLOOP##
</form>
</table>
##TP_IF {[OT_CfgGet FUNC_TOTE_BACS_OUTPUT 0] == 1}##
<br>
<form name="banks_out_frm" action="##TP_CGI_URL##" method="post">
	<input type="hidden" name="SubmitName" value="DoPmtQry">
	<input type="hidden" name="action" value="ADMIN::PMT::do_pmt_query">
	<!-- bind search options -->
	<input type="hidden" name="SR_username" value="##TP_SR_username##">
	<input type="hidden" name="SR_upper_username" value="##TP_SR_upper_username##">
	<input type="hidden" name="SR_fname" value="##TP_SR_fname##">
	<input type="hidden" name="SR_lname" value="##TP_SR_lname##">
	<input type="hidden" name="SR_email" value="##TP_SR_email##">
    <input type="hidden" name="SR_acct_no_exact" value="##TP_SR_acct_no_exact##">
	<input type="hidden" name="SR_acct_no" value="##TP_SR_acct_no##">
	<input type="hidden" name="SR_date_1" value="##TP_SR_date_1##">
	<input type="hidden" name="SR_date_2" value="##TP_SR_date_2##">
	<input type="hidden" name="SR_date_range" value="##TP_SR_date_range##">
	<input type="hidden" name="SR_status" value="##TP_SR_status##">
	<input type="hidden" name="SR_payment_sort" value="##TP_SR_payment_sort##">
	<input type="hidden" name="SR_channel" value="##TP_SR_channel##">
	<input type="hidden" name="SR_pay_mthd" value="##TP_SR_pay_mthd##">
	<input type="hidden" name="SR_CCYCode" value="##TP_SR_CCYCode##">
	<input type="hidden" name="SR_CNTRYCode" value="##TP_SR_CNTRYCode##">
	<input type="hidden" name="SR_cust_id" value="##TP_SR_cust_id##">
	<input type="hidden" name="SR_PMT_ID" value="##TP_SR_PMT_ID##">
	<input type="hidden" name="SR_REF_NUM" value="##TP_SR_REF_NUM##">
	<input type="hidden" name="toFile" value="1">

	<input type="submit" class="btn_def" value="Output BACS To File">
</form>
##TP_ENDIF##
</body>
</html>
