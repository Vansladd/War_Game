##TP_COMMENT {<!--
	$Id: event_lists_main.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $
	Copyright (c) 2009 Orbis Technology Ltd. All rights reserved.
//-->}##
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
	<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
	<title>Event Lists</title>

	##TP_PLAY JS_WriteSelect.html##
	<script language="Javascript" type="text/javascript">
	/* <![CDATA[ */

	String.prototype.trim = function () {
		return this.replace(/^\s*(\S*(\s+\S+)*)\s*$/, "$1");
	};

	function fs(b,t){
		b.disabled = true;
		b.value = "Busy...";
		b.form.SubmitName.value=t;

		// Are we submitting changes?
		if( t == 'SaveChanges' && !validate_update(b.form)) {
			alert ("Details are not changed, cannot update");
			b.disabled = false;
			b.value = "Save Changes";
			return false;
		} else {
			// Are we trying to delete something?
			if (b.form.ev_id_delete.value != "") {
				if (!(confirm ("Are you sure you want to proceed? Events with a blank disporder will removed"))) {
					b.disabled = false;
					b.value = "Save Changes";
					return false;
				}
			 }
		}

		b.form.submit();
		return true;
	}

	function validate_update (f) {

		// Init
		var has_changed = false;

		// Trim id_list
		var re = /\s+/;
		var id_list     = f.ev_id_list.value.replace(/^\s+|\s+$/g, '').split(re);

		var max_other_events = f.max_other_events.value;
		var max_my_events    = f.max_my_events.value;
		var bir_threshold_num = f.bir_threshold_num.value;
		var bir_threshold_den = f.bir_threshold_den.value;
		// Flag any view level change
		if ((max_other_events != f.orig_max_other_events.value) || (max_my_events != f.orig_max_my_events.value) 
			|| (bir_threshold_num != f.orig_bir_threshold_num.value) || (bir_threshold_den != f.orig_bir_threshold_den.value) ) {

			if (!max_other_events.match(/^\d+$/) || !max_my_events.match(/^\d+$/)) {
				alert("Please insert a valid number in 'Max other events' and 'Max my events'");
				f.max_other_events.value = f.orig_max_other_events.value;
				f.max_my_events.value    = f.orig_max_my_events.value;
				return false;
			}

			if (!bir_threshold_num.match(/^\d+$/) || !bir_threshold_den.match(/^\d+$/) || bir_threshold_den.match("0") !=null) {
				alert("Please insert a valid number in 'Betting in running threshold'");
				f.bir_threshold_num.value = f.orig_bir_threshold_num.value;
				f.bir_threshold_den.value    = f.orig_bir_threshold_den.value;
				return false;
			}

			f.view_changed.value = 1;
			has_changed = true;
		}

		// Flag any sport level change
		if ((f.max_sport_other_events.value != f.orig_max_sport_other_events.value ) || (f.max_sport_hpage_events.value != f.orig_max_sport_hpage_events.value)) {
			f.sport_changed.value = "1";
			has_changed = true;
		}

		// Do we have any events to validate ?
		if (id_list != 'none') {
			var list_length = id_list.length;
			var to_update = new Array();
			var to_delete = new Array();
			var to_add    = new Array();

			for (var i = 0; i < list_length ; i++)
			{
				ev_id = id_list[i];

				var curr_val = document.getElementById("disporder_" + ev_id).value.trim();
				var prev_val = document.getElementById("orig_disporder_" + ev_id).value.trim();


				// this is a new row
				if (prev_val == "NEW" ) {
					has_changed = true;
					to_add.push(ev_id+"|"+curr_val);
				}

				// it has changed ...
				else if (curr_val != prev_val) {
					// set the has_changed flag if it wasn't already
					has_changed = true;
					if (curr_val == '') {
						// put in delete queue
						to_delete.push(ev_id);
					} else {
						// put in update queue
						to_update.push(ev_id);
					}
				}
			}
			// Populate change list
			f.ev_id_update.value = to_update.join(' ');
			f.ev_id_delete.value = to_delete.join(' ');
			f.ev_id_add.value    = to_add.join(' ');
		} // end event validation branch

		return has_changed;

	}

	function selchange(s,t) {
		s.form.SubmitName.value=t;
		s.form.submit();
		return true;
	}

	function GoDD() {
		popup=window.open("##TP_CGI_URL##?action=ADMIN::POPUP_DD::GoDD&selected_level=##TP_SelectedSportDD##&selected_id=##TP_SportOBId##&disable_links_at_level=EVENT&selectable_levels=EVENT",  "popup","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,height=500,width=750");
		popup.focus();
	}

	function set_vals(level, id, name) {
		f = document.event_list_form;
		if (!f) {
			alert("Unable to find form");
			return;
		}

		ev_table = document.getElementById('events_table');
		ev_id_list = document.getElementById('ev_id_list');

		if (ev_id_list.value == 'none') {
			no_events_row = document.getElementById("no_events");
			no_events_row.style.display = 'none';

			ev_id_list.value = id;
		} else {
			var re = eval("/ " + id + " |^" + id + " | " + id + "$/");
			if (ev_id_list.value.search(re) >= 0) {
				alert("This event already exists.");
				return;
			}

			ev_id_list.value = ev_id_list.value + ' ' + id;
		}

		new_ev_row = ev_table.insertRow(ev_table.rows.length - 1);

		event_cell = new_ev_row.insertCell(0);
		event_cell.appendChild(document.createTextNode(name));

		ev_type_cell = new_ev_row.insertCell(1);
		ev_type_content = document.createElement('div');
		ev_type_content.name = 'level_name_' + id ;
		ev_type_content.id   = 'level_name_' + id ;
		ev_type_cell.appendChild(ev_type_content);

		disporder_cell = new_ev_row.insertCell(2);
		disporder_el = document.createElement('input');
		disporder_el.type = 'text';
		disporder_el.size = 3;
		disporder_el.value = '0';
		disporder_el.name = 'disporder_' + id;
		disporder_el.id = 'disporder_' + id;
		disporder_cell.appendChild(disporder_el);

		orig_disporder_el = document.createElement('input');
		orig_disporder_el.type = 'hidden';
		orig_disporder_el.value = 'NEW';
		orig_disporder_el.name = 'orig_disporder_' + id;
		orig_disporder_el.id = 'orig_disporder_' + id;
		disporder_cell.appendChild(orig_disporder_el);
	}

	function set_context (id , level_name) {
		document.getElementById('level_name_'+id).innerHTML = level_name;
	}
	/* ]]> */
	</script>

<body>
	<form name="event_list_form" action="##TP_CGI_URL##" method="post">
<table border="0" cellspacing="0" cellpadding="3" id="events_table">

	##TP_COMMENT {<!-- Form global variables //-->}##

	<input type="hidden" name="SubmitName" value=""/>
	<input type="hidden" name="action" value="ADMIN::EVENTLISTS::DoEventLists"/>
	<input type="hidden" name="view" value="##TP_SelectedView##"/>
	<input type="hidden" name="sport_id" value="##TP_SelectedSportId##"/>
	<input type="hidden" name="sport_dd" value="##TP_SelectedSportDD##"/>
	<input type="hidden" name="ev_id_update" value="" />
	<input type="hidden" name="ev_id_delete" value="" />
	<input type="hidden" name="ev_id_add" value="" />

	<tr>
		<th class="title" colspan="3">
		Event Lists (##TP_SelectedView##)
		</th>
	</tr>

	##TP_COMMENT {<!-- View-dependent set up and parameters //-->}##

	<input type="hidden" name="view_changed" value="0" />

	<tr class="subtitle">
		<td colspan="3">View setup</td>
	</tr>
	<tr>
		<td class="caption"><strong>View</strong></td>
		<td class="buttons" colspan="2">
			<select name="view_filter" onchange="selchange(this,'FilterView');">
				<script>
				write_select("##TP_SelectedView##"##TP_LOOP view_idx {[tpGetVar NumViews]} ##, "##TP_ViewId##", "##TP_ViewName##" ##TP_ENDLOOP##);
				</script>
			</select>
		</td>
	</tr>
	<tr>
		<td class="caption"><strong>Maximum events in "Other Events"</strong></td>
		<td colspan="2">
			<input type="text" size="3" name="max_other_events" value="##TP_max_other_events##" />
			<input type="hidden" name="orig_max_other_events" value="##TP_max_other_events##" />
		</td>
	</tr>
	<tr>
		<td class="caption"><strong>Maximum events in "My Events"</strong></td>
		<td colspan="2">
			<input type="text" size="3" name="max_my_events" value="##TP_max_my_events##" />
			<input type="hidden" name="orig_max_my_events" value="##TP_max_my_events##" />
		</td>
	</tr>
	<tr>
		<td class="caption"><strong>Betting in running threshold</strong></td>
		<td colspan="2">
			<input type="text" size="3" name="bir_threshold_num" value="##TP_bir_threshold_num##" />
			<input type="hidden" name="orig_bir_threshold_num" value="##TP_bir_threshold_num##" />
			/
			<input type="text" size="3" name="bir_threshold_den" value="##TP_bir_threshold_den##" />
			<input type="hidden" name="orig_bir_threshold_den" value="##TP_bir_threshold_den##" />
		</td>
	</tr>

	##TP_COMMENT {<!-- Sport set up and parameters for chosen view //-->}##

	<input type="hidden" name="sport_changed" value="0" />

	<tr class="subtitle">
		<td colspan="3">Sport setup</td>
	</tr>
	<tr>
		<td class="caption"><strong>Sport</strong></td>
		<td class="buttons" colspan="2">
			<select name="sport_filter" onchange="selchange(this,'FilterSport');">
			##TP_LOOP sport_idx {[tpGetVar NumSports]}##
				<option value="##TP_SportId##" ##TP_SportSel##>##TP_SportName##</option>
			##TP_ENDLOOP##
			</select>
			##TP_LOOP sport_idx {[tpGetVar NumSports]}##
				<input type="hidden" name="##TP_SportId##_ob_level" value="##TP_SportLev##" />
			##TP_ENDLOOP##
		</td>
	</tr>
	<tr>
		<td class="caption"><strong>Maximum sport events in "Other Events"</strong></td>
		<td colspan="2">
			<input type="text" size="3" name="max_sport_other_events" value="##TP_max_sport_ev##" />
			<input type="hidden" name="orig_max_sport_other_events" value="##TP_max_sport_ev##" />
		</td>
	</tr>
	<tr>
		<td class="caption"><strong>Maximum events on sport homepage</strong></td>
		<td colspan="2">
			<input type="text" size="3" name="max_sport_hpage_events" value="##TP_max_home_bir_ev##" />
			<input type="hidden" name="orig_max_sport_hpage_events" value="##TP_max_home_bir_ev##" />
		</td>
	</tr>

	##TP_COMMENT {<!-- Event disporders for selected sport and view //-->}##

	<tr class="subtitle">
		<td colspan="3">Event List</td>
	</tr>
	##TP_IF {[tpGetVar NumEvents] > 0 }##
	<tr>
		<th><a href="##TP_CGI_URL##?action=ADMIN::EVENTLISTS::DoEventLists&SubmitName=SortList&sort=event_name&view_filter=##TP_SelectedView##&sport_filter=##TP_SelectedSportId##">Event</a></th>
		<th><a href="##TP_CGI_URL##?action=ADMIN::EVENTLISTS::DoEventLists&SubmitName=SortList&sort=type_name&view_filter=##TP_SelectedView##&sport_filter=##TP_SelectedSportId##">Event Type</a></th>
		<th><a href="##TP_CGI_URL##?action=ADMIN::EVENTLISTS::DoEventLists&SubmitName=SortList&sort=disporder&view_filter=##TP_SelectedView##&sport_filter=##TP_SelectedSportId##">Disporder</a> (##TP_SelectedView##)</th>
	</tr>
	##TP_LOOP event_idx {[tpGetVar NumEvents]}##
	<tr>
		<td>##TP_EventName##</td>
		<td>##TP_TypeName##</td>
		<td>
			<input type="text" size="3" name="disporder_##TP_EvId##" id="disporder_##TP_EvId##" value="##TP_EvDisporder##" />
			<input type="hidden" name="orig_disporder_##TP_EvId##" id="orig_disporder_##TP_EvId##" value="##TP_EvDisporder##" />
		</td>
	</tr>
	##TP_ENDLOOP##
	<input type="hidden" name="ev_id_list" id="ev_id_list" value="##TP_LOOP event_idx {[tpGetVar NumEvents]}####TP_EvId## ##TP_ENDLOOP##"/>
	##TP_ELSE##
	<tr id="no_events">
		<input type="hidden" name="ev_id_list" id="ev_id_list" value="none" />
		<td colspan="3">There are no events with a custom display order for <strong>##TP_SelectedView##</strong></td>
	</tr>
	##TP_ENDIF##

	##TP_COMMENT {<!-- Control buttons //-->}##

	<tr>
		<td class="buttons" colspan="3">
			<input type="button" class="btn_def" value="Add Event" style="margin-right:5px;" onclick="javascript:GoDD();"/>
			<input type="button" class="btn_def" value="Save Changes" style="margin-right:5px;" onclick="javascript:fs(this,'SaveChanges');"/>
			<input type="button" class="btn_def" value="Cancel" onclick="javascript:fs(this,'Cancel');"/>
		</td>
	</tr>
</table>
</form>
</body>
</html>
