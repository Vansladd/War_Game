<html>
<!-- $Id: amalco.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>Incident Simulator</title>

<script type="text/javascript">
	##TP_PLAY amalco_ajax.js##
</script>

<script language=JavaScript>
	var periods       = new Array();
	var stats         = new Array();
	var scores        = new Array();
	var participants  = new Array();

	##TP_LOOP period_idx {$PERIOD(nrows)}##
	periods.push("##TP_PERIOD_code##");
	##TP_ENDLOOP##

	##TP_LOOP stat_idx {$STATISTIC(nrows)}##
	stats.push("##TP_STAT_code##");
	##TP_ENDLOOP##

	##TP_LOOP score_idx {$SCORETYPE(nrows)}##
	scores.push("##TP_SCORE_code##");
	##TP_ENDLOOP##

	##TP_LOOP competitor_idx {$COMPETITOR(nrows)}##
	participants.push("##TP_COMPETITOR_desc##");
	##TP_ENDLOOP##

	##TP_LOOP player_idx {$PLAYER(nrows)}##
	participants.push("##TP_PLAYER_desc##");
	##TP_ENDLOOP##

	function disable(b) {
		// Get the button type (period, stat, or score)
		var type = b.id.substring(0,1);

		// Determine the number of buttons of that type
		switch (type) {
			case "p":
				var limit = periods.length;
				var hiddenField = "period"
				break;
			case "t":
				var limit = stats.length;
				var hiddenField = "statistic"
				break;
			case "s":
				var limit = scores.length;
				var hiddenField = "score"
				break;
			case "c":
				var limit = participants.length;
				var hiddenField = "participant"
				break;
		}

		// First enable all buttons of that type
		for (var i = 0; i < limit; i++) {
			switch (type) {
				case "p":
					document.getElementById("p_" + periods[i]).disabled = false;
					break;
				case "t":
					document.getElementById("t_" + stats[i]).disabled = false;
					break;
				case "s":
					document.getElementById("s_" + scores[i]).disabled = false;
					break;
				case "c":
					document.getElementById("c_" + participants[i]).disabled = false;
					break;
			}
		}

		// Now disable the button just pressed
		document.getElementById(b.id).disabled = true;

		// Finally update the appropriate hidden field
		document.getElementById(hiddenField).value = b.id.substring(2);
	}

	function enableSubmit() {
		var period = document.getElementById("period").selectedIndex;
		var stat   = document.getElementById("statistic").selectedIndex;
		var score  = document.getElementById("score").selectedIndex;
		var value  = document.getElementById("value").value;

		if (period != 0 && (stat != 0 || score != 0) && value != "")
			document.getElementById("btn").disabled = false;
		else
			document.getElementById("btn").disabled = true;
	}

	function hiderow() {
		var incidentType = document.getElementById("incident_type").value;

		switch(incidentType) {
			case "t":
				document.getElementById("stat_row").style.display = "";
				document.getElementById("score_row").style.display = "none";
				break;
			case "s":
				document.getElementById("stat_row").style.display = "none";
				document.getElementById("score_row").style.display = "";
				break;
		}
	}

	function updClock(operation) {
		var url = createUrlStub('ADMIN::AMALCO::adjust_clock', 0);
		url = url + "&operation=" + operation + "&ev_id=##TP_ev_id##" + "&period_code=" + document.getElementById('period_code').value;

		var nonstandarderr = false;
		var async = true;

		Ajax(url, ajaxClock, nonstandarderr, async);
	}

	function ajaxClock(httpReq) {
		var ret_val = unescape(httpReq.responseText);
		var ret_arr = new Array();

		ret_arr = ret_val.split("|");

		if (ret_arr[0] == 'ERR') {
			// display the error panel
			document.getElementById('error_panel').style.display='block';
			document.getElementById('error_code').innerHTML = document.getElementById('error_code').innerHTML + '<strong>' + ret_arr[1] + '</strong>';

		} else if (ret_arr[0] == 'RETRY') {
			// display a js error
			document.getElementById('error_panel').style.display='none';
			alert(ret_arr[1]);

		} else if (ret_arr[0] == 'VAL') {
			// valid response - return the second part of the array.
			document.getElementById('error_panel').style.display='none';

			document.getElementById('currentEventTime').innerHTML = ret_arr[2];
			document.getElementById('currentEventPeriod').innerHTML = ret_arr[3];
		}
	}

	function clock(operation) {
		switch (operation) {
			case 'start':
				document.getElementById("startClock").disabled = true;
				document.getElementById("stopClock").disabled  = false;
				updClock("startClock");

				break;
			case 'stop':
				document.getElementById("startClock").disabled = false;
				document.getElementById("stopClock").disabled  = true;
				updClock("stopClock");

				break;
		}
	}

	function fs(b) {
		b.form.submit();
		return true;
	}
</script>

<body>
	<form action="##TP_CGI_URL##" method="post">
		<input type="hidden" name="action"      value="ADMIN::AMALCO::show_incident" />
		<input type="hidden" name="EvId"        value="##TP_ev_id##" />
		<input type="hidden" name="period"      id="period" />
		<input type="hidden" name="statistic"   id="statistic" />
		<input type="hidden" name="score"       id="score" />
		<input type="hidden" name="participant" id="participant" />
		<table>
			<tr>
				<th colspan="100%">Amalco Incident Simulator</th>
			</tr>
			<tr>
				<th colspan="100%">Event id = ##TP_ev_id##</th>
			</tr>
			<tr>
				<td>Period:</td>
				##TP_LOOP period_idx {$PERIOD(nrows)}##
				<td>
					<input type="button" onclick="disable(this);" id="p_##TP_PERIOD_code##" value="##TP_PERIOD_desc##" class="button" />
				</td>
				##TP_ENDLOOP##
			</tr>
			<tr>
				<td colspan="100%">
					<select name="incident_type" id="incident_type" onchange="hiderow();">
						<option value="t">Statistic</option>
						<option value="s">Score</option>
					</select>
				</td>
			</tr>
			<tr id="stat_row">
				<td>Statistic:</td>
				##TP_LOOP stat_idx {$STATISTIC(nrows)}##
				<td>
					<input type="button" onclick="disable(this)" id="t_##TP_STAT_code##" value="##TP_STAT_desc##"  class="button"/>
				</td>
				##TP_ENDLOOP##
			</tr>
			<tr id="score_row" style="display: none">
				<td>Score:</td>
				##TP_LOOP score_idx {$SCORETYPE(nrows)}##
				<td>
					<input type="button" onclick="disable(this)" id="s_##TP_SCORE_code##" value="##TP_SCORE_desc##"  class="button"/>
				</td>
				##TP_ENDLOOP##
			</tr>
			<tr>
				<td>Competitor:</td>
				<td colspan="100%">
					<table>
						##TP_LOOP competitor_idx {$COMPETITOR(nrows)}##
						##TP_IF {[tpGetVar competitor_idx] % 10 == 0}##
						<tr>
						##TP_ENDIF##
							<td>
								<input type="button" onclick="disable(this)" id="c_##TP_COMPETITOR_desc##" value="##TP_COMPETITOR_desc##" class="button"/>
							</td>
						##TP_IF {[tpGetVar competitor_idx] % 10 == 9}##
						</tr>
						##TP_ENDIF##
						##TP_ENDLOOP##
					</table>
				</td>
			</tr>
			<tr>
				<td>Player:</td>
				<td colspan="100%">
					<table>
						##TP_LOOP player_idx {$PLAYER(nrows)}##
						##TP_IF {[tpGetVar player_idx] % 10 == 0}##
						<tr>
						##TP_ENDIF##
							<td>
								<input type="button" onclick="disable(this)" id="c_##TP_PLAYER_desc##" value="##TP_PLAYER_desc##" class="button"/>
							</td>
						##TP_IF {[tpGetVar player_idx] % 10 == 9}##
						</tr>
						##TP_ENDIF##
						##TP_ENDLOOP##
					</table>
				</td>
			</tr>
			<tr>
				<td>Value:</td>
				<td>
					<input type="text" name="value" id="value" style="width: 50" />
				</td>
			</tr>
			<tr>
				<td colspan="100%">Freeform text: <input type="text" name="freeform_text" id="freeform_text" /> Free form language:
					<select name="freeform_lang" id="freeform_lang">
						<option value="">No freeform text language</option>
						##TP_LOOP lang_idx {$LANG(nrows)}##
						<option value="##TP_lang_code##">##TP_lang_name##</option>
						##TP_ENDLOOP##
					</select>
				</td>
			</tr>
			<tr>
				<td colspan="100%">Incident time (MM:SS): <input type="text" name="incident_time" value="00:00" /></td>
			</tr>
			<tr>
				<td><input type="button" value="Submit incident" class="btn_def" onclick="return fs(this)" id="btn"/></td>
			</tr>
		</table>
	</form>
	<form>
		<table>
			<tr>
				<th colspan="100%">Event Clock</th>
			</tr>
			<tr>
				<td><input type="button" id="startClock" value="Start clock" class="btn_def" onclick="clock('start');" ##TP_start_disabled##/></td>
				<td><input type="button" id="stopClock"  value="Stop clock"  class="btn_def" onclick="clock('stop');" ##TP_stop_disabled##/></td>
				<td>
					<select id="period_code">
					##TP_LOOP period_idx {$PERIOD(nrows)}##
						<option value="##TP_PERIOD_code##">##TP_PERIOD_desc##</option>
					##TP_ENDLOOP##
					</select>
				</td>
			</tr>
			<tr>
				<td>Current event time:</td><td id="currentEventTime">##TP_current_event_time##</td>
				<td>Current event period:</td><td id="currentEventPeriod">##TP_current_event_period##</td>
			</tr>
			<tr colspan="100%" id="error_panel" style="display: none">
				<td id="error_code"></td>
			</tr>
		</table>
	</form>

	##TP_IF {[tpBindGet inc_period_code] != ""}##
	<table>
		<tr>
			<th colspan="100%">Incident received</th>
		</tr>
		<tr>
			<th>Period</th><th>##TP_incident_type##</th><th>Participant</th><th>Value</th>
		</tr>
		<tr>
			<td>##TP_inc_period_code##</td><td>##TP_inc_code##</td><td>##TP_inc_participant##</td><td>##TP_inc_value##</td>
		</tr>
		<tr>
			<td>Freeform text</td><td colspan="2">##TP_inc_freeform_text##</td><td>Free form language: ##TP_inc_freeform_lang##</td>
		</tr>
		<tr>
			<td>Incident time:</td><td colspan="3">##TP_inc_incident_time##</td>
		</tr>
	</table>
	##TP_ENDIF##
</body>
</html>
