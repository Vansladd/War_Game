<html>
<!-- $Id: coupon.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>Add Coupon</title>
##TP_PLAY JS_WriteSelect.html##
<script language=JavaScript>

var errorList = "";
var CatHasChanged = 0;

function add_err(e_str)
{
	if (errorList.length > 0) {
		errorList += "\n";
	}
	errorList += e_str;
}

function validate(f)
{
	errorList = "";

	if (errorList != "") {
		alert("There are some errors in the form:\n\n" + errorList);
		return false;
	}

	return true;
}

function fs(b,t)
{
	// should only have value replay when called from onChange...
	if(t == "replay"){
		var selectedSort = b.form.elements["CouponSort"].selectedIndex;
		var sort         = b.form.elements["CouponSort"].options[selectedSort].value;

		if(sort == "BB"){
			b.form.action.value = "ADMIN::COUPON::GoCoupon";
			b.form.IsBBuster.value = "Y";
		} else {
			// only want to submit the form if sort=BB so return here...
			return true;
		}
	}

	##TP_IF {[tpGetVar ISBBUSTER ""] == "Y"}##
	if(t == "CouponMktMod"){
		//carry over the max num to select from each group
		var selectedNum = document.getElementById('SelNum').value;
		b.form.elements["SelNum"].value = selectedNum;
	}
	##TP_ENDIF##
	if (t == "Back") {
		history.back();
	} else {
		b.form.SubmitName.value=t;
		b.form.submit();
	}
	return true;
}

function ChangeCat(b)
{
	if (CatHasChanged == 1){

		var ret=confirm('By changing Category you will need to save the changes. Do you want to continue?');
		if (ret == 0){
			return false
		}
	}
	var selectedCat = b.form.elements["MultiCatCouponCat"].selectedIndex;
	var cat         = b.form.elements["MultiCatCouponCat"].options[selectedCat].value;
	b.form.elements["MultiCatCouponCat"].value = cat;

	b.form.action.value = "ADMIN::COUPON::DoCouponMkts";
	b.form.submit();
	return true
}

function MktChanged()
{
	CatHasChanged = 1;
}


var main_form;

function LangDispPopup(b,id)
{
	if (id == "") {
		id = 0;
	}

	main_form = b.form;

	window.open("##TP_CGI_URL##?action=ADMIN::LANG::GoLangDisp&Id="
				+id+"&IdSort=P",
		"languages",
		"toolbar=no,location=no,directories=no,menubar=no,resizable=yes,width=450,height=300");
}

function ViewDispPopup(b,id,name)
{
	if (id == "") {id = 0;}
	main_form = b.form;

	window.open("##TP_CGI_URL##?action=ADMIN::VIEWS::GoViewDisporders&id="+id+"&sort=COUPON&name="+name,
		"Views",
		"toolbar=no,location=no,directories=no,menubar=no,scrollbars=yes,resizable=yes,width=450,height=300");
}

function clearGroup(mkt,grp)
{
	var frm = document.forms['mkts'];

	var val = eval("frm." + mkt + ".value");

##TP_IF {[tpGetVar ISBBUSTER ""] == "Y"}##
	if(val == 0) {
		eval("frm." + grp + ".selectedIndex = 0");
	}
##TP_ENDIF##
}

function blurb_popup (id, sort)
{
	if (id == "") {
		alert("No Id specified, does the "+sort+" exist.\n"+
			"You must create it before you can add a blurb");
		return;
	}

	window.open("##TP_CGI_URL##?action=ADMIN::BLURB::do_blurb&ref_id="+id+"&sort="+sort,
		"Blurb",
		"toolbar=no,location=no,directories=no,menubar=no,resizable=yes,width=600,height=200");
}
</script>
<style type="text/css">
<!--
#btn_autoupdateset { float:right; }
#text_autoupdate { float:right; }
-->
</style>
</head>

<body>
##TP_PLAY error_rpt.html##
##TP_PLAY msg_rpt.html##

<table border=0 cellspacing=0 cellpadding=3>
<tr>
	<th colspan=2 class=title>
	##TP_ClassName## Coupon
	</th>
</tr>

<form ACTION="##TP_CGI_URL##" method=get onSubmit="return validate(this);">

##TP_IF {[OT_CfgGet FUNC_SHOW_COUPON_ID 0]}##
<tr>
	<td class=caption>
	<b>Coupon ID</b>
	</td>
	<td>##TP_CouponId##</td>
</tr>
##TP_ENDIF##

<tr>
	<td class=caption>
	<b>Coupon Description</b>
	</td>
	<td>
	<input type=text name="CouponDesc" value="##TP_CouponDesc##" SIZE=60>
	</td>
</tr>
<tr>
	<td class=caption>
	<b>Displayed</b>
	</td>
	<td>
		##TP_IF {[OT_CfgGet USE_AUTO_COUPONS 1] && [tpGetVar ISBBUSTER ""] != "Y" && [tpBindGet CouponId] != ""}##
		<table cellspacing=0 cellpadding=0 border=0>
			<tr>
				<td width="41"><select name="CouponDisplayed">
				<script>write_select('##TP_CouponDisplayed##','Y','Yes','N','No');</script>
				</select>
				</td>
				<td width="350"><div id="text_autoupdate"><b>Automatically updated:</b> ##TP_IF {[tpBindGet IsAutoUpdated] == "Y"}##Yes##TP_ELSE##No##TP_ENDIF##</div></td>
			</tr>
		</table>
		##TP_ELSE##
		<select name="CouponDisplayed">
			<script>write_select('##TP_CouponDisplayed##','Y','Yes','N','No');</script>
		</select>
		##TP_ENDIF##
	</td>
</tr>
<tr>
	<td class=caption><b>Disporder</b></td>
	<td>
		<input type=text name=CouponDisporder size=5 value="##TP_CouponDisporder##">
		##TP_IF {[string first LANG [OT_CfgGet FUNC_COUPON_FIELDS]] >= 0}##
			<input type=button class="btn_def" value="Lang Disporder" onclick="LangDispPopup(this,'##TP_CouponId##')">
			<input type=hidden name="LangDisporder" value="">
			<input type=hidden name="LangChange"    value="0">
		##TP_ENDIF##
		##TP_IF {[OT_CfgGetTrue FUNC_VIEWS]}##
		 	&nbsp;&nbsp;<input type=button class="btn_def" value="View Disporder" onclick="ViewDispPopup(this,'##TP_CouponId##','##TP_ESC esc_js####TP_CouponDesc####TP_ESC##')">
		##TP_ENDIF##
	</td>
</tr>
##TP_IF {[string first BLURB [OT_CfgGet FUNC_COUPON_FIELDS]] >= 0 || [tpGetVar ISBBUSTER ""] == "Y"}##
	<tr>
		<td class=caption valign=top>
		<b><br>Coupon blurb</b>
		</td>
		<td>
		<textarea cols=60 rows=6 wrap=virtual name="CouponBlurb">##TP_CouponBlurb##</textarea><br>
		<i>(Only 250 characters are stored)</i>
		</td>
	</tr>
	<tr>
		<td class=caption>&nbsp;</td>
		<td>
			<a href='javascript:blurb_popup("##TP_CouponId##", "COUPON")'>edit multi-lingual text</a>
			<font color=red size=-1><i>(multi-lingual text will take precedence over the default text)</i></font>
		</td>
	</tr>
##TP_ENDIF##
<!--Flags srobins 7/2002-->
##TP_IF {[tpGetVar NumCpnTags 0]>0}##
	<tr>
		<td class=caption>Flags</td>
		<td>
		<table cellspacing=0 cellpadding=0 border=0>
		##TP_LOOP cpn_tag_idx {[expr {4*(([tpGetVar NumCpnTags]+3)/4)}]}##
			##TP_IF {[tpGetVar cpn_tag_idx]%4 == 0}##
				<tr>
			##TP_ENDIF##
			##TP_IF {[tpGetVar cpn_tag_idx]<[tpGetVar NumCpnTags]}##
				<td>
				<input type=checkbox name="CPNTAG_##TP_CpnTagCode##" ##TP_CpnTagSel##>
				##TP_CpnTagName##
				</td>
			##TP_ELSE##
				<td>&nbsp;</td>
			##TP_ENDIF##
			##TP_IF {([tpGetVar cpn_tag_idx]+1)%4 == 0}##
				</tr>
			##TP_ENDIF##
		##TP_ENDLOOP##
		</table>
		</td>
	</tr>
##TP_ENDIF##
<tr>
	<td class=caption>
	<b>Coupon sort</b>
	</td>
	<td>
	##TP_IF {[OT_CfgGet USE_AUTO_COUPONS 1] && [tpGetVar ISBBUSTER ""] != "Y" && [tpBindGet CouponId] != ""}##
	<table cellspacing=0 cellpadding=0 border=0>
	<tr>
	<td width="41">
	##TP_ENDIF##
	<input type="hidden" name=IsBBuster value ="##TP_ISBBUSTER##">
	##TP_IF {[tpGetVar ISBBUSTER ""] == ""}##
		<select name=CouponSort onChange="fs(this,'replay')">
		<script>
		write_select('##TP_CouponSort##',
			'','Standard'
			##TP_IF {[tpGetVar COUPON_SORTS] != ""}##,
			##TP_TCL {tpBufWrite [tpGetVar COUPON_SORTS]}##
			##TP_ENDIF##

		);
		</script>
		</select>
	##TP_ELSE##
		Block Buster </td></tr>

		<tr><td class=caption><i>Maximum Selection from each group &nbsp;</i></td>
		<td>
		<input type="hidden" name=CouponSort value="BB">
		<select name=SelNum id=SelNum>
		##TP_LOOP num_idx {[tpGetVar NumSelsAllowed]}##
			##TP_IF {[tpGetVar MaxNumSel] == $::NUMBERSELS([tpGetVar num_idx],num)}##
				<option value="##TP_SelNum##" selected>##TP_SelNum##</option>
			##TP_ELSE##
				<option value="##TP_SelNum##">##TP_SelNum##</option>
			##TP_ENDIF##
		##TP_ENDLOOP##
		</td></tr>

		<tr>
			<td class=caption valign=top><b>Bonus Percentages</b></td>
			<td><i>The following bonuses are for chosing 1 selection from each group, 2 selections<br>
                   from each group and so on up to 5 selections from each group.<br> (Note : for a 10 % bonus
                   enter 10, not 0.1.)</i></td>
		</tr>
		<tr>
			<td class=caption>Bonus 1</td>
			<td><input type="text" name="bonus1" size=4 value="##TP_Bonus1##"></td>
		</tr>
		<tr>
			<td class=caption>Bonus 2</td>
			<td><input type="text" name="bonus2" size=4 value="##TP_Bonus2##"></td>
		</tr>
		<tr>
			<td class=caption>Bonus 3</td>
			<td><input type="text" name="bonus3" size=4 value="##TP_Bonus3##"></td>
		</tr>
		<tr>
			<td class=caption>Bonus 4</td>
			<td><input type="text" name="bonus4" size=4 value="##TP_Bonus4##"></td>
		</tr>
		<tr>
			<td class=caption>Bonus 5</td>
			<td><input type="text" name="bonus5" size=4 value="##TP_Bonus5##">
	##TP_ENDIF##
	</td>
##TP_IF {[OT_CfgGet USE_AUTO_COUPONS 1] && [tpGetVar ISBBUSTER ""] != "Y" && [tpBindGet CouponId] != ""}##
	<td width="350"><input type="button" id="btn_autoupdateset" value="Auto Update Settings" onClick="return fs(this,'AutoUpdate')"></td>
	</tr>
	</table>
##TP_ENDIF##
	</td>
</tr>
##TP_IF {[OT_CfgGet FUNC_CHANNELS 0]}##
	<tr>
		<td class=caption>Channels</td>
		<td>
		##TP_PLAY chan_sel.html##
		</td>
	</tr>
	<tr>
		<td class=caption>Fastkey</td>
		<td>
		<input type=text name=CouponFastkey size=1 value="##TP_CouponFastkey##">
		</td>
	</tr>
##TP_ENDIF##
##TP_IF {[string first LANG [OT_CfgGet FUNC_COUPON_FIELDS ""]] >= 0}##
	<tr>
		<td class="caption">Languages</td>
		<td colspan="4">
		##TP_PLAY lang_sel.html##
		</td>
	</tr>
##TP_ENDIF##

##TP_IF {[OT_CfgGetTrue FUNC_VIEW_FLAGS]}##
	<tr>
		<td class="caption">Views</td>
		<td colspan="4">
		##TP_PLAY view_sel.html##
		</td>
	</tr>
	<tr class=subtitle><td class="newsInfo" colspan="4">Languages: These are the languages that will be able to see this Event Class with the current views setup</td></tr>
	<tr><td class="newsInfobold" colspan="4">##TP_lang_list##</td></tr>
##TP_ENDIF##

<tr>
	<th colspan="2" class="buttons">

	<table border="0" cellspacing="0" cellpadding="0" width="100%">
	<tr>
		<input type="hidden" name="ClassId" value="##TP_ClassId##">
		<input type="hidden" name="Category" value="##TP_Category##">
		<input type="hidden" name="FromClass" value="##TP_FromClass##">
		<input type="hidden" name="MultiCatCouponCat" value="##TP_MultiCatCouponCat##">

		<th width="75%" class="buttons">

		<input type="hidden" name="CouponId" value="##TP_CouponId##">
		<input type="hidden" name="ClassId" value="##TP_ClassId##">
		##TP_IF {[op_allowed ManageCoupon]}##
			##TP_IF {[tpGetVar opAdd 0]}##
				<input type="button" class="btn_def" value="Add Coupon" onClick="return fs(this,'CouponAdd')">
			##TP_ELSE##
				<input type="button" class="btn_def" value="Modify Coupon" onClick="return fs(this,'CouponMod')">
				##TP_IF {[tpGetVar ISBBUSTER ""] == ""}##
				<input type="button" class="btn_def" value="Delete Coupon" onClick="return fs(this,'CouponDel')">
				##TP_ENDIF##
			##TP_ENDIF##
		##TP_ENDIF##
		<input type="button" class="btn_def" value="Back" onClick="return fs(this,'Back')">

		</th>
		##TP_IF {![tpGetVar opAdd 0]}##
			##TP_IF {[tpGetVar PERM_ViewAudit 0]}##
				<th class="goaudit" width="25%">
				<input type="button" class="btn_def" value="View Audit History" onClick="return fs(this,'GoAudit')">
				<input type="hidden" name="AuditInfo" value="Coupon">
				</th>
			##TP_ENDIF##
		##TP_ENDIF##
	</tr>
	</table>



	</th>
</tr>

<input type=hidden name=SubmitName value="">
<input type=hidden name="NoHilo" value="##TP_CNoHilo##">
<input type=hidden name="AllHilo" value="##TP_CAllHilo##">
<input type=hidden name=action value=ADMIN::COUPON::DoCoupon>
</form>
</table>
<br>
##TP_IF {![tpGetVar opAdd 0]}##
<table border=0 cellspacing=1 cellpadding=1>
<form ACTION="##TP_CGI_URL##" method=post name="mkts">
<input type=hidden name="CouponId" value="##TP_CouponId##">
<input type=hidden name="ClassId" value="##TP_ClassId##">
<input type=hidden name="MktSelOtherCats" value="##TP_MktSelOtherCats##">
<input type="hidden" name="Category" value="##TP_Category##">
<input type=hidden name="FromClass" value="##TP_FromClass##">

<tr>
	<th colspan=4 class=title>
	Coupon Markets
	</th>
</tr>
##TP_IF {[tpBindGet ClassId] == "" && [tpBindGet Category] == "" && [OT_CfgGet FUNC_MULTI_CAT_COUPONS 0]}##
<tr>
	<td class="caption">
		Select Current Category
	</td>
	<td>
		<select name=MultiCatCouponCat onChange="ChangeCat(this)">
			##TP_LOOP multi_coupon_cats_idx {[tpGetVar NumMultiCouponCats]}##
			##TP_MultiCouponCats##
				##TP_IF {[tpBindGet MultiCouponCats] == [tpBindGet MultiCatCouponCat]}##
					<option value="##TP_MultiCouponCats##" selected>##TP_MultiCouponCats##</option>
				##TP_ELSE##
					<option value="##TP_MultiCouponCats##">##TP_MultiCouponCats##</option>
				##TP_ENDIF##
			##TP_ENDLOOP##
		</select>
	</td>
</tr>
##TP_ENDIF##
<tr>
	<th class=colhead>Time</th>
	<th class=colhead>Event</th>
	<th class=colhead>Market</th>
	##TP_IF {[tpGetVar ISBBUSTER ""] == "Y"}##
		<th class=colhead>Group Number</th>
	##TP_ENDIF##
</tr>
##TP_IF {[tpGetVar NumCoupTypes 0]>0}##
##TP_LOOP ctype_idx {[tpGetVar NumCoupTypes]}##
<tr bgcolor=#cc6666>
	<td colspan=4>
	<font color=white>
	<b>
	##TP_CClassName## - ##TP_CTypeName##
	</b>
	</font>
	</td>
</tr>
##TP_LOOP cev_idx {$TYPE([tpGetVar ctype_idx],ev_count)}##
<tr>
	<td>##TP_CEvStart##</td>
	<td>##TP_CEvDesc##</td>
	<td>
	<select name="CouponMkt_##TP_CEvId##" onChange="clearGroup('CouponMkt_##TP_CEvId##','GroupNumber_##TP_CEvId##')" ##TP_IF {[op_allowed ManageAdvancedCoupon] && [OT_CfgGet COUPONS_ALLOW_MISMATCHED_MARKETS 0]}##multiple="multiple" size="4"##TP_ENDIF## style="width:##TP_MaxMktLength##">
		<option value="0">------</option>
		##TP_LOOP cmkt_idx {$EVENT([tpGetVar ctype_idx],[tpGetVar cev_idx],mkt_count)}##
		<option value="##TP_CMktId##" onClick="MktChanged();" ##TP_CMktSel##>##TP_CMktName##</option>
		##TP_ENDLOOP##
	</select>
	</td>
	<td>
	##TP_IF {[tpGetVar ISBBUSTER ""] == "Y"}##
		<select name="GroupNumber_##TP_CEvId##">
		<option value="0">--</option>
		##TP_LOOP num_idx {[tpGetVar NumGroupsAllowed]}##
			##TP_IF {$::EVENT([tpGetVar ctype_idx],[tpGetVar cev_idx],grp_num_sel) == $::NUMBERGROUPS([tpGetVar num_idx],num)}##
				<option value="##TP_GroupNum##" selected>##TP_GroupNum##</option>
			##TP_ELSE##
				<option value="##TP_GroupNum##">##TP_GroupNum##</option>
			##TP_ENDIF##
		##TP_ENDLOOP##
		</select>
	##TP_ENDIF##
	</td>
</tr>
##TP_ENDLOOP##
##TP_ENDLOOP##
<input type="hidden" name="SelNum" value="">
<tr>
	<th colspan=4 class=buttons>
	##TP_IF {[op_allowed ManageCoupon]}##
		<input type=button class="btn_def" value="Modify Coupon Markets" onClick="return fs(this,'CouponMktMod')">
	##TP_ENDIF##
	<input type=button class="btn_def" value="Back" onClick="return fs(this,'Back')">
	</th>
</tr>
##TP_ELSE##
<tr>
    <td colspan=4>
    <b>No markets for this coupon</b>
	</td>
</tr>
##TP_ENDIF##
<input type=hidden name=SubmitName value="">
<input type=hidden name=action value=ADMIN::COUPON::DoCouponMkts>
</form>
</table>
##TP_ENDIF##
</body>
</html>
