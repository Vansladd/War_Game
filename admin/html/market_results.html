<html>
<!-- $Id: market_results.html,v 1.1.1.1 2011/10/04 10:54:25 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>Set Event Market Result</title>

<style type="text/css">
	tr.row1 {
		background-color: #999999;
	}
	tr.row2 {
		background-color: #cccccc;
	}
	tr.confirmed {
		background-color: #9cc;
	}
	td.dbl_res_mismatch {
		color:       red;
		font-weight: bold;
	}
	td.dbl_res_masked {
		color:       green;
		font-weight: bold;
	}
</style>

##TP_PLAY JS_WriteSelect.html##

<script type="text/javascript">

// double resulting vars
is_dbl_res       = '##TP_MktDblRes##';

// number of each way terms on market
each_way_term_no = '##TP_NumTerms##';

// columns for double resulting
result_cols = ['sp','result','place','w_dh','p_dh','tw_div','tp_div'];

// variable for counting selections (required for styling
row_num = 0;

// list of ev_oc_id's
ev_oc_id_list = "";

// has event started
##TP_IF {[tpGetVar AfterEventStart 0]}##
	is_past = "Y";
##TP_ELSE##
	is_past = "N";
##TP_ENDIF##

// error list
errorList = "";

// result mappings
var rslt = new Object();

rslt["-"] = "Unset";
rslt["V"] = "Void";
rslt["W"] = "Win";
rslt["L"] = "Lose";
rslt["H"] = "Handicap";
rslt["P"] = "Place";
rslt["U"] = "Push";

ew_terms   = new Array();
max_ew_pl  = 1;

// list of entries that will NOT be changed by the automatic DH reductions
manual_dh = new Array();

function addEWTerm(ew_id,ew_pl) {

	ew_pl = parseInt(ew_pl);
	if(ew_pl > max_ew_pl) {
		max_ew_pl = ew_pl;
	};
	ew_terms.push(new Array(ew_id,ew_pl));

}

##TP_LOOP ew_idx {[tpGetVar NumTerms 0]}##
	addEWTerm("##TP_EWId##","##TP_EWPl##");
##TP_ENDLOOP##

// If market can dead heat,initialise win/place dead heat reduction limits array
// and add all the data
##TP_IF {[tpGetVar MktCanDeadHeat 1]}##
	w_dh_num = new Array();
	w_dh_den = new Array();
	w_dh_mod = new Array();
	p_dh_num = new Array();
	p_dh_den = new Array();
	p_dh_mod = new Array();
	p_ew_id  = new Array();

	##TP_LOOP s_idx {[tpGetVar NumMktSelns]}##
		##TP_LOOP u_idx {$OC([tpGetVar s_idx],res_num)}##
			##TP_TCL {tpBindString u_idx [tpGetVar u_idx]}##

			// win/place dead heat reduction limits array initialisation
			##TP_IF {[tpGetVar u_idx] == 0}##

				w_dh_num[##TP_ev_oc_id##] = new Array();
				w_dh_den[##TP_ev_oc_id##] = new Array();
				w_dh_mod[##TP_ev_oc_id##] = new Array();
				p_dh_num[##TP_ev_oc_id##] = new Array();
				p_dh_den[##TP_ev_oc_id##] = new Array();
				p_dh_mod[##TP_ev_oc_id##] = new Array();
				p_ew_id[##TP_ev_oc_id##]  = new Array();

			##TP_ENDIF##

			p_dh_num[##TP_ev_oc_id##][##TP_u_idx##] = new Array();
			p_dh_den[##TP_ev_oc_id##][##TP_u_idx##] = new Array();
			p_dh_mod[##TP_ev_oc_id##][##TP_u_idx##] = new Array();
			p_ew_id[##TP_ev_oc_id##][##TP_u_idx##]  = new Array();

			// store win reductions for this ev_oc_id and result set
			w_dh_num[##TP_ev_oc_id##][##TP_u_idx##] = "##TP_W_dh_num##";
			w_dh_den[##TP_ev_oc_id##][##TP_u_idx##] = "##TP_W_dh_den##";
			w_dh_mod[##TP_ev_oc_id##][##TP_u_idx##] = "##TP_W_dh_mod##";

			// store place reductions for this ev_oc_id and result set
			##TP_LOOP e_idx {[tpGetVar NumTerms 0]}##
				##TP_TCL {tpBindString e_idx [tpGetVar e_idx]}##
				p_dh_num[##TP_ev_oc_id##][##TP_u_idx##][##TP_e_idx##] = "##TP_P_dh_num##";
				p_dh_den[##TP_ev_oc_id##][##TP_u_idx##][##TP_e_idx##] = "##TP_P_dh_den##";
				p_dh_mod[##TP_ev_oc_id##][##TP_u_idx##][##TP_e_idx##] = "##TP_P_dh_mod##";
				p_ew_id[##TP_ev_oc_id##][##TP_u_idx##][##TP_e_idx##]  = "##TP_P_ew_id##";
			##TP_ENDLOOP##
		##TP_ENDLOOP##
	##TP_ENDLOOP##
##TP_ENDIF##


// add an error
function add_err(e_str)
{
	if (errorList.length > 0) {
		errorList += "\n";
	}
	errorList += e_str;
}

// validate the form
function validate(f)
{
	return true;

	var desc          = strTrim(f.Desc.value, " ");
	var group_menu    = f.OptGrp;
	var scheme_menu   = f.PricingScheme;
	var group         = group_menu.options[group_menu.selectedIndex].value;
	var scheme        = scheme_menu.options[scheme_menu.selectedIndex].value;
	var max_bet       = f.MaxBet.value;
	var min_bet       = f.MinBet.value;
	var max_tot_stake = f.MaxTotalStake.value;
	var odds_num      = f.OddsNum.value;
	var odds_denom    = f.OddsDenom.value;

	errorList = "";

    if (desc.length == 0) {
        add_err("Description cannot be empty");
    } else {
        if (!isSafeStr(desc)) {
            add_err("don't use these characters in descriptions: "
                + "tab [ ] { } < > \" \\ $");
        }
    }
	if (group == "") {
		add_err("no market specified");
	}
	if (!isMoney(max_tot_stake, false)) {
		add_err("max total stake is invalid - must be a money quantity");
	}
	if ((min_bet.length > 0) && (!isMoney(min_bet, false))) {
        add_err("min bet is invalid - must be a money quantity");
    }
    if ((max_bet.length > 0) && (!isMoney(max_bet, false))) {
        add_err("max bet is invalid - must be a money quantity");
    }
    if ((min_bet.length > 0) && (max_bet.length > 0)) {
        if (isMoney(min_bet, false) && isMoney(max_bet, false)) {
            if (parseFloat(min_bet) > parseFloat(max_bet)) {
                add_err("min bet is bigger than max bet");
            }
        }
	}
	if (scheme == 'LP') {
		if (!isInt8(odds_num, false) || !isInt8(odds_denom, false)) {
			add_err("odds must be specified for live price");
		} else {
			odds_num   = parseInt(odds_num);
			odds_denom = parseInt(odds_denom);
			if ((parseFloat(odds_num) < 1) || (parseFloat(odds_denom) < 1)) {
				add_err("odds num/denom must be positive integers");
			}
		}
	}

	if (errorList != "") {
		alert("There are some errors in the form:\n\n" + errorList);
		return false;
	}

	return true;
}

// write out the options for a result drop down
function write_result_sel(res,results) {
	var i;
	for (i = 0; i < results.length; i++) {
		var r = results.charAt(i);
		var s = (r == res) ? " selected" : "";
		document.write('<option value="'+r+'"'+s+'>'+rslt[r]+'</option>\n')
	}
}

// write out the result string
function write_result(res,results) {
	var i;
	for (i = 0; i < results.length; i++) {
		var r = results.charAt(i);
		if (r == res) {
			document.write(rslt[r]);
		}
	}
}

// create and return a masked table cell (for double resulting)
function get_masked_cell() {
	td = document.createElement('td');
	td.innerHTML = '##TP_DblMaskStr##';
	td.className = 'dbl_res_masked';
	return td;
}

// create and return a table cell with fraction formatted
function get_oc_frac_cell(how,name,id,sort,val1,val2,disabled)
{

	if (typeof disabled == 'undefined' ) disabled = "";

	var d;

	if (disabled != "disabled") {
	   d = "";
	} else {
	   d = disabled;
	}

	var content = "";
	if (sort == "P") {
		content = val1;
	} else {
		if (val1 != "") {
			content = val1+"/"+val2;
		}
	}

	if (how == "INPUT") {
		content = '<input type=text id="' + name +
		          '_' + id + '" name="' + name +
		          '_' + id + '" value="' + content + '" size=7 ' + d + ' >';
	} else {
		if (content == "") {
			content = '&nbsp;';
		}
	}
	td = document.createElement('td');
	td.innerHTML = content;

	return td;
}

// write out list of ev_oc_id's
function write_ev_oc_id_list()
{
	document.write('<input type="hidden" name="EvOcIdList" value="'
		+ ev_oc_id_list + '">\n');
}

// add an ev_oc_id to list
function add_oc_res_id(id)
{
	if (ev_oc_id_list != "") {
		ev_oc_id_list += ","
	}
	ev_oc_id_list += id;
}

// write out a table row in selection list
function write_oc_res_line(
	id,result_idx,ew,lp,sp,pm,desc,res,res_conf,results,place,lp_v,sp_v,stl,
	tw_div,tp_div,res_num,dbl_type,dbl_user,dbl_mask)
{
	var i, tbody, tr, td, a, sel, option, cell1, cell2, input;

	// add id to list of ids if selection not settled or not confirmed
	if (stl == 'N' && result_idx == 0 && res_conf == 'N') {
		add_oc_res_id(id);
	}

	// if first results for selection
	if (result_idx == 0) {
		row_num += 1;
	}

	tbody = document.getElementById('selListBody');
	tr    = document.createElement('tr');

	// alternate row colours
	if (row_num % 2 == 0) {
		tr.className = 'row1';
	} else {
		tr.className = 'row2';
	}

	// change row style if the seln is confirmed already
	if (res_conf == 'Y') {
		tr.className = 'confirmed'
	}

	// only write out selection name, lp if first results for selection
	if (result_idx == 0) {
		td = document.createElement('td');
		td.rowSpan = res_num;
		td.innerHTML =
			'<a href="##TP_CGI_URL##?action=ADMIN::SELN::GoOc' +
			'&MktId=##TP_MktId##&OcId=' + id + '">' + desc + '</a>';

		tr.appendChild(td);

		// write live price, if one exists
		if (lp == "Y") {
			td = document.createElement('td');
			td.rowSpan = res_num;
			td.innerHTML = lp_v + '&nbsp';
			tr.appendChild(td);
		}
	}

	if (is_dbl_res == 'Y') {
		td = document.createElement('td');
		td.innerHTML = dbl_type;
		tr.appendChild(td);

		td = document.createElement('td');
		td.innerHTML = dbl_user;
		tr.appendChild(td);
	}

	// write sp, if sp specified
	if (sp == "Y") {
		if (stl == "N" && result_idx == 0 && res_conf == 'N') {
			tr.appendChild(get_oc_frac_cell('INPUT','oc_sp',id,'P',sp_v));
		} else {
			if (dbl_mask == 1) {
				tr.appendChild(get_masked_cell());
			} else {
				if (sp_v == "") {
					sp_v = '-';
				}
				td = get_oc_frac_cell('TEXT','oc_sp',id,'P',sp_v);
				td.id = 'sp_' + id + '_' + result_idx;
				tr.appendChild(td);
			}
		}
	}

	if (stl == "N" && result_idx == 0) {

		sel = document.createElement('select');
		sel.name = 'oc_res_' + id;
		sel.id   = 'oc_res_' + id;

		if (is_past == "Y" && res == "-") {
			##TP_IF {[string first [tpGetVar MktType] "AHMLU"]>=0}##
				res = "H";
			##TP_ELSE##
				res = "L";
			##TP_ENDIF##
		}

		for(var i = 0; i < results.length; i++) {
			option           = document.createElement('option');
			var r            = results.charAt(i);
			option.value     = r;
			option.innerHTML = rslt[r];
			if (res_conf == "Y") {
				option.disabled = true;
			}

			sel.appendChild(option);

			if (r == res) {
				sel.selectedIndex = i;
			}
		}
		
		sel.onchange=function() {
			eval("updateResult("+id+");");
		}
		
		td = document.createElement('td');
		td.appendChild(sel);
		tr.appendChild(td);

		##TP_IF {[tpGetVar MktCanPlace 1]}##
			td = document.createElement('td');
			if (res_conf == 'N') {
				td.innerHTML = '<input type="text" id="oc_place_'+id+'" name="oc_place_'+id+'" size="3"'+
				' value="'+place+'" onchange="updatePlace('+id+')">';
			} else {
				td.innerHTML = place;
			}
			tr.appendChild(td);
		##TP_ENDIF##

		if (pm == "Y") {
			if (res_conf == 'N') {
				tr.appendChild(get_oc_frac_cell('INPUT','oc_tw_div',id,'P',tw_div));
				tr.appendChild(get_oc_frac_cell('INPUT','oc_tp_div',id,'P',tp_div));
			} else {
				tr.appendChild(get_oc_frac_cell('TEXT','oc_tw_div',id,'P',tw_div));
				tr.appendChild(get_oc_frac_cell('TEXT','oc_tp_div',id,'P',tp_div));
			}
		}

		##TP_IF {[tpGetVar MktCanDeadHeat 1]}##
			var w_r_n = w_dh_num[id][result_idx];
			var w_r_d = w_dh_den[id][result_idx];

			var seperator = "/";

			if (res_conf == 'N') {
				tr.appendChild(get_oc_frac_cell('INPUT','dh_wr',id,'F',w_r_n,w_r_d,'##TP_DeadHeatReductionsDisabled##'));
			} else {
				tr.appendChild(get_oc_frac_cell('TEXT','dh_wr',id,'F',w_r_n,w_r_d,'##TP_DeadHeatReductionsDisabled##'));
			}
			// remember deductions that have values already
			manual_dh["dh_wr_"+id] = w_dh_mod[id][result_idx];

			for (var i = 0; i < each_way_term_no; i++) {

				var p_r_n = p_dh_num[id][result_idx][i];
				var p_r_d = p_dh_den[id][result_idx][i];
				var ew_id = p_ew_id[id][result_idx][i];

				if (p_r_n == "") {
					seperator = "";
				} else {
					seperator = "/";
				}

				td = document.createElement('td');
				ident = "dh_pr_" + id + "_" + ew_id;
				if (res_conf == 'N') {
					td.innerHTML = '<input type="text" id="'+ ident + '" name="'+ ident + '"  size="3"'+ ' value="'+p_r_n + seperator + p_r_d + '" ##TP_DeadHeatReductionsDisabled## >';
				} else {
					td.innerHTML = p_r_n + seperator + p_r_d;
				}
				tr.appendChild(td);
				// remember deductions that have values already
				manual_dh[ident] = p_dh_mod[id][result_idx][i];
			}
		##TP_ENDIF##

	} else {

		// do we need to mask the results
		if (dbl_mask == 1) {
			tr.appendChild(get_masked_cell());
		} else {
			td    = document.createElement('td');
			td.id = 'result_' + id + '_' + result_idx;

			for (i = 0; i < results.length; i++) {
				var r = results.charAt(i);
				if (r == res) {
					td.innerHTML = rslt[r];
				}
			}
			tr.appendChild(td);
		}

		##TP_IF {[tpGetVar MktCanPlace 1]}##

			if (dbl_mask == 1) {
				tr.appendChild(get_masked_cell());
			} else {
				td = document.createElement('td');
				td.id = 'place_' + id + '_' + result_idx;
				if (place == "") {
					place = '-';
				}
				td.innerHTML = place;
				tr.appendChild(td);
			}

		##TP_ENDIF##

		if (pm == 'Y') {
			// do we need to mask the results
			if (dbl_mask == 1) {
				tr.appendChild(get_masked_cell());
				tr.appendChild(get_masked_cell());
			} else {
				if (tw_div == "") {
					td = document.createElement('td');
					td.innerHTML = '-';
				} else {
					td = get_oc_frac_cell('TEXT','oc_tw_div',id,'P',tw_div);
					td.id = 'tw_div_' + id + '_' + result_idx;
				}
				tr.appendChild(td);
				if (tp_div == "") {
					td = document.createElement('td');
					td.innerHTML = '-';
				} else {
					td = get_oc_frac_cell('TEXT','oc_tp_div',id,'P',tp_div);
					td.id = 'tp_div_ '+ id + '_' + result_idx;
				}
				tr.appendChild(td);
			}
		}

		##TP_IF {[tpGetVar MktCanDeadHeat 1]}##

			// do we need to mask the results
			if (dbl_mask == 1) {
				tr.appendChild(get_masked_cell());
			} else {
				var w_r_n = w_dh_num[id][result_idx];
				var w_r_d = w_dh_den[id][result_idx];
				if (w_r_n == "") {
					td = document.createElement('td');
					td.innerHTML = '-';
				} else {
					td = get_oc_frac_cell('TEXT','','','F',w_r_n,w_r_d);
				}
				td.id = 'w_dh_' + id + '_' + result_idx;
				tr.appendChild(td);
			}


			for (var i = 0; i < each_way_term_no; i++) {

				// do we need to mask the results
				if (dbl_mask == 1) {
					tr.appendChild(get_masked_cell());
				} else {
					var p_r_n = p_dh_num[id][result_idx][i];
					var p_r_d = p_dh_den[id][result_idx][i];
					if (p_r_n == "") {
						td = document.createElement('td');
						td.innerHTML = '-';
					} else {
						td = get_oc_frac_cell('TEXT','','','F',p_r_n,p_r_d);
					}
					td.id = 'p_dh_' + id + '_' + result_idx + '_' + i;
					tr.appendChild(td);
				}

			}

		##TP_ENDIF##

	}

	tbody.appendChild(tr);

	// if this is double resulting set 2
	if (is_dbl_res == 'Y' && result_idx == 2) {

		// add form element to confirm that the user has seen 2 sets of
		// results for this selection
		input = document.createElement('input');
		input.type  = 'hidden'
		input.name  = 'dbl_res_force_' + id;
		input.value = '1';
		tbody.appendChild(input);

		// check if need to highlight any differences
		for (var i = 0; i < result_cols.length; i++) {
			if(result_cols[i] == 'p_dh') {

				// check all the reduction rows
				for (var j = 0; j < each_way_term_no; j++) {

					cell1 = document.getElementById('p_dh_' + id + '_1' + '_' + j);
					cell2 = document.getElementById('p_dh_' + id + '_2' + '_' + j);

					if (cell1 && cell1.firstChild.data != cell2.firstChild.data) {
						cell1.className = 'dbl_res_mismatch';
						cell2.className = 'dbl_res_mismatch';
					}
				}

			} else {
				cell1 = document.getElementById(result_cols[i] + '_' + id + '_1');
				cell2 = document.getElementById(result_cols[i] + '_' + id + '_2');

				if (cell1 && cell1.firstChild.data != cell2.firstChild.data) {
					cell1.className = 'dbl_res_mismatch';
					cell2.className = 'dbl_res_mismatch';
				}
			}
		}
	}
}

function updateResult(ev_oc_id) {

	var res_select = document.getElementById("oc_res_"+ ev_oc_id);
	var place_input = document.getElementById("oc_place_"+ ev_oc_id);
	
	var val = res_select.options[res_select.selectedIndex].value;

	switch(val) {
		case 'W':
			place_input.value = 1;
			break;
		default:
			place_input.value = '';
			break;
	}
	
	##TP_IF {[tpGetVar MktAutoDH 0]}##
		// Recalculate and write deadheat reductions
		calcDHReductions();
	##TP_ENDIF##
	
}

function setResult(obj_select,value) {

	for (var i=0; i < obj_select.length; i++) {
		if (obj_select[i].value == value) {
			obj_select.selectedIndex = i;
		}
	}

}

function updatePlace(ev_oc_id) {

	var place = document.getElementById("oc_place_"+ ev_oc_id).value;
	var res_select = document.getElementById("oc_res_"+ ev_oc_id);

	// validate input
	if(place == '') {
		place = 0;
	}

	place = parseInt(place);

	if(isNaN(place)) {
		alert('Please enter a valid place');
		return;
	}

	// Update Result
	switch(place) {
		case 0:
			setResult(res_select,'-');
			break;
		case 1:
			setResult(res_select,'W');
			break;
		default:
			setResult(res_select,'P');
	}

	##TP_IF {[tpGetVar MktAutoDH 0]}##
		// Recalculate and write deadheat reductions
		calcDHReductions();
	##TP_ENDIF##

}

/* Retrieve highest common factor of two integers */
function hcf(a,b) {

	if (b == 0) {
		return a;
	}

	return hcf(b,(a % b));
}

function calcDHReductions() {

	var placed = new Array();
	var num_placed = 0;
	var ew_places  = 0;
	var ew_term_id = 0;
	var wr_ev_oc_ids = "";
	var pr_ev_oc_ids = "";
	var nb_places = 0;

	var dh_num;
	var dh_den;
	var hfc;
	var ident;

	var ev_oc_ids = ev_oc_id_list.split(",");
	
	for (var i = 1;i <= ev_oc_ids.length; i++) {
		placed[i] = {count : 0, ids : "1"};
		
	}

	// find out if multiple selections have the same place
	// also clear current DH reductions
	for (var i = 0;i < ev_oc_ids.length; i++) {
		var place = document.getElementById("oc_place_"+ ev_oc_ids[i]).value;

		if (place != "") {
		
			placed[place].count++;
			if (placed[place].count == 1) {
				placed[place].ids = ev_oc_ids[i];
				nb_places = place;
			} else {
				placed[place].ids += ","+ev_oc_ids[i];
			}
		}
		
		// clear DH recuctions except for manual ones
		if (manual_dh["dh_wr_"+ev_oc_ids[i]] == 0)
			document.getElementById("dh_wr_"+ev_oc_ids[i]).value = '';
		for (var e=0; e < ew_terms.length;e++) {
			ident = "dh_pr_"+ev_oc_ids[i]+"_"+ew_terms[e][0];
			if (manual_dh[ident] == 0)
				document.getElementById(ident).value = '';
		}
	}

	// loop through all relevant places beginning from 1 and
	// generate the sum of selections placed.
	for (var p = 1;p <= nb_places; p++) {

		num_placed = placed[p].count;

		// check for dead heat
		if (num_placed < 2) {continue;}

		// set a win reduction if this is place 1
		if (p == 1) {
			wr_ev_oc_ids = placed[p].ids.split(",");
			
			for (var i = 0;i < wr_ev_oc_ids.length; i++) {
				ident = "dh_wr_"+wr_ev_oc_ids[i];
				if (manual_dh[ident] == 0)
					document.getElementById(ident).value = "1/"+num_placed;
			}
			
		}

		// loop through all each way terms
		for (var e=0; e < ew_terms.length;e++) {

			ew_places = ew_terms[e][1];
			ew_term_id = ew_terms[e][0];

			if (p > ew_places) {continue}

			dh_num = ew_places + 1 - p;
			dh_den = num_placed;

			if (dh_num >= dh_den) {continue}

			hfc = hcf(dh_num,dh_den);

			dh_num = dh_num / hfc;
			dh_den = dh_den / hfc;

			// set all reductions
			pr_ev_oc_ids = placed[p].ids.split(",");
			
			for (var i = 0;i < pr_ev_oc_ids.length; i++) {
				ident = "dh_pr_"+pr_ev_oc_ids[i]+"_"+ew_term_id;
				if (manual_dh[ident] == 0)
					document.getElementById("dh_pr_"+pr_ev_oc_ids[i]+"_"+ew_term_id).value = dh_num+"/"+dh_den;
			}
			
		}
	}
}


// submit the form
function fs(b,t)
{
	if (t == "CalcDH") {
		if (!confirm(
			"Are you sure you want to overwrite any manual input?"
		)) {
			return;
		}
	}

	b.disabled = true;
	b.value = "Busy...";
	b.form.SubmitName.value=t;
	b.form.submit();
	return true;
}


</script>

</head>

<body>
##TP_PLAY error_rpt.html##
<form name="SetEvMktRes" method=post action="##TP_CGI_URL##" onSubmit="return validate(this);">
<table border=0 cellspacing=0 cellpadding=2>
##TP_IF {[tpGetVar NumMktSelns] > 0}##
	##TP_IF {[string first [tpGetVar MktType] "AHMLU"] < 0}##
		##TP_TCL {tpSetVar SelTblCols 2}##
		##TP_IF {[tpGetVar MktSPAvail]}##
			##TP_TCL {tpSetVar SelTblCols [expr {1+[tpGetVar SelTblCols]}]}##
		##TP_ENDIF##
		##TP_IF {[tpGetVar MktLPAvail]}##
			##TP_TCL {tpSetVar SelTblCols [expr {1+[tpGetVar SelTblCols]}]}##
		##TP_ENDIF##
		##TP_IF {[tpGetVar MktDblRes]}##
			##TP_TCL {tpSetVar SelTblCols [expr {2+[tpGetVar SelTblCols]}]}##
		##TP_ENDIF##
		##TP_IF {[tpGetVar MktPMAvail]}##
			##TP_TCL {tpSetVar SelTblCols [expr {2+[tpGetVar SelTblCols]}]}##
		##TP_ENDIF##
		##TP_IF {[tpGetVar MktCanPlace 1]}##
			##TP_TCL {tpSetVar SelTblCols [expr {1+[tpGetVar SelTblCols]}]}##
		##TP_ENDIF##
		##TP_IF {[tpGetVar MktCanDeadHeat 1]}##
			##TP_TCL {tpSetVar SelTermCols [expr {[tpGetVar NumTerms 0] + 1}]}##
			##TP_TCL {tpSetVar SelTblCols [expr {[tpGetVar SelTblCols] + [tpGetVar SelTermCols]}]}##
		##TP_ENDIF##
		##TP_TCL {tpBindString SelTblCols [tpGetVar SelTblCols]}##
		##TP_TCL {tpBindString SelTermCols [tpGetVar SelTermCols]}##
		##TP_IF {[tpGetVar MktCanDeadHeat 1] || [tpGetVar MktDblRes]}##
			##TP_TCL {tpBindString SelRowSpan 2}##
		##TP_ELSE##
			##TP_TCL {tpBindString SelRowSpan 1}##
		##TP_ENDIF##
		<tr>
			<th class=title colspan=2>
			##TP_EvDesc##, ##TP_EvStartTime##<br>##TP_MktName##
			</th>
		</tr>
		<tr>
			<td class=caption>Pricing</td>
			<td>
			##TP_IF {[tpGetVar MktLPAvail]}##
				(Live)&nbsp;
			##TP_ENDIF##
			##TP_IF {[tpGetVar MktSPAvail]}##
				SP&nbsp;
			##TP_ENDIF##
			##TP_IF {[tpGetVar MktPMAvail]}##
				Tote Div&nbsp;
			##TP_ENDIF##
			</td>
		</tr>
		##TP_IF {[OT_CfgGet FUNC_DBL_RES 0]}##
			<tr>
				<td class=caption>Double Resulting</td>
				<td>
					<script>
						write_which('##TP_MktDblRes##','Y','Active','N','Inactive','','Inactive');
					</script>
				</td>
			</tr>
		##TP_ENDIF##
		</table>
		<br>
		<table border=0 cellspacing=1 cellpadding=1>
			<thead>
				<tr>
					<th class=colhead rowspan="##TP_SelRowSpan##">Selection</th>
					##TP_IF {[tpGetVar MktLPAvail]}##
						<th class=colhead rowspan="##TP_SelRowSpan##">Price</th>
					##TP_ENDIF##
					##TP_IF {[tpGetVar MktDblRes]}##
						<th class="colhead" colspan="2">Double Resulting</th>
					##TP_ENDIF##
					##TP_IF {[tpGetVar MktSPAvail]}##
						<th class=colhead rowspan="##TP_SelRowSpan##">Starting Price</th>
					##TP_ENDIF##
					<th class=colhead rowspan="##TP_SelRowSpan##">Result</th>
					##TP_IF {[tpGetVar MktCanPlace 1]}##
						<th class=colhead rowspan="##TP_SelRowSpan##">Place</th>
					##TP_ENDIF##
					##TP_IF {[tpGetVar MktPMAvail]}##
						<th class=colhead rowspan="##TP_SelRowSpan##">Win Div</th>
						<th class=colhead rowspan="##TP_SelRowSpan##">Place Div</th>
					##TP_ENDIF##
					##TP_IF {[tpGetVar MktCanDeadHeat 1]}##
						<th class=colhead colspan="##TP_SelTermCols##">Dead Heat Reductions</th>
					##TP_ENDIF##
				</tr>
				##TP_IF {[tpGetVar MktCanDeadHeat 1] || [tpGetVar MktDblRes]}##
					<tr>
						##TP_IF {[tpGetVar MktDblRes]}##
							<th class="colhead">Type</th>
							<th class="colhead">By</th>
						##TP_ENDIF##
						##TP_IF {[tpGetVar MktCanDeadHeat 1]}##
							<th class=colhead>Win</th>
							<input type=hidden name="can_deadheat" value="##TP_MktCanDeadHeat##"/>
							<input type=hidden name="num_terms" value="##TP_NumTerms##"/>
							<input type=hidden name="ew_term_ids" value="##TP_EWTermIds##"/>
							##TP_LOOP ew_idx {[tpGetVar NumTerms 0]}##
								<th class=colhead>
									Place<br>##TP_IF {[tpGetVar ew_idx 0] == 0}##Mkt: ##TP_ENDIF####TP_EWPl##@##TP_EWNum##/##TP_EWDen##
								</th>
							##TP_ENDLOOP##
						##TP_ENDIF##
					</tr>
				##TP_ENDIF##
			<thead>
			<tbody id="selListBody">
				<script type="text/javascript">
					##TP_LOOP s_idx {[tpGetVar NumMktSelns]}##
						##TP_LOOP u_idx {$OC([tpGetVar s_idx],res_num)}##
							write_oc_res_line(
								"##TP_ev_oc_id##",
								"##TP_TCL {tpBufWrite [tpGetVar u_idx]}##",
								"##TP_MktEWAvail##",
								"##TP_MktLPAvail##",
								"##TP_MktSPAvail##",
								"##TP_MktPMAvail##",
								"##TP_desc##",
								"##TP_result##",
								"##TP_result_conf##",
								"##TP_result_flags##",
								"##TP_place##",
								"##TP_lp##",
								"##TP_sp##",
								"##TP_settled##",
								"##TP_tw_div##",
								"##TP_tp_div##",
								"##TP_res_num##",
								"##TP_dbl_type##",
								"##TP_dbl_user##",
								"##TP_dbl_mask##"
							);
						##TP_ENDLOOP##
					##TP_ENDLOOP##
					write_ev_oc_id_list();
				</script>
			</tbody>
		##TP_ELSE##
			##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
				##TP_TCL -quiet {tpSetVar SelTblCols 3}##
			##TP_ELSE##
				##TP_TCL -quiet {tpSetVar SelTblCols 2}##
			##TP_ENDIF##
			##TP_IF {[tpGetVar MktDblRes]}##
				##TP_TCL {tpBindString SelRowSpan 2}##
				##TP_TCL {tpSetVar SelTblCols [expr {2+[tpGetVar SelTblCols]}]}##
			##TP_ELSE##
				##TP_TCL {tpBindString SelRowSpan 1}##
			##TP_ENDIF##
				##TP_TCL {tpBindString SelTblCols [tpGetVar SelTblCols]}##
			<table border=0 cellspacing=1 cellpadding=1>
			<tr>
				<th class=title colspan=##TP_SelTblCols##>
				##TP_EvDesc##, ##TP_EvStartTime##<br>##TP_MktName##
				</th>
			</tr>
			##TP_IF {[string first [tpGetVar MktType] "U"] >= 0}##
				##TP_COMMENT for under/over allow entry of full time scores##
				<tr>
					<th class="colhead">Final score(home)</th>
					<th class="colhead">Final score(away)</th>
					##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
						<th class=colhead>&nbsp;</th>
					##TP_ENDIF##
				</tr>
				<tr>
					<td>
						##TP_IF {[tpBindGet result_conf] == "N"}##
							<input type="text" size="5" name="fs_home" value="##TP_FS_HOME##">
						##TP_ELSE##
							##TP_FS_HOME##
						##TP_ENDIF##
					</td>
					<td>
						##TP_IF {[tpBindGet result_conf] == "N"}##
							<input type="text" size="5" name="fs_away" value="##TP_FS_AWAY##">
						##TP_ELSE##
							##TP_FS_AWAY##
						##TP_ENDIF##
					</td>
					##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
						<td class=colhead>&nbsp;</td>
					##TP_ENDIF##
				</tr>
			##TP_ENDIF##
			<tr>
				<th class=colhead rowspan="##TP_SelRowSpan##">Selection</th>
				##TP_IF {[tpGetVar MktDblRes]}##
					<th class="colhead" colspan="2">Double Resulting</th>
				##TP_ENDIF##
				<th class=colhead rowspan="##TP_SelRowSpan##">Result</th>
				##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
					<th class=colhead rowspan="##TP_SelRowSpan##">Score</th>
				##TP_ENDIF##
			</tr>
			##TP_IF {[tpGetVar MktDblRes]}##
				<tr>
					<th class="colhead">Type</th>
					<th class="colhead">By</th>
				</tr>
			##TP_ENDIF##
			##TP_LOOP s_idx {[tpGetVar NumMktSelns]}##
				##TP_LOOP u_idx {$OC([tpGetVar s_idx],res_num)}##
					##TP_IF {[tpGetVar u_idx] == 0}##
						##TP_IF {[tpBindGet result_conf] == "N"}##
							<script>add_oc_res_id(##TP_ev_oc_id##);</script>
						##TP_ENDIF##
						<tr ##TP_IF {[expr {[tpGetVar s_idx]%2}] == 0}## class="row1" ##TP_ELSE## class="row2" ##TP_ENDIF##>
							<td  rowspan="##TP_res_num##">
								<a href="##TP_CGI_URL##?action=ADMIN::SELN::GoOc&OcId=##TP_ev_oc_id##">##TP_desc##</a>
							</td>
							##TP_IF {[tpGetVar MktDblRes]}##
								<td>
									##TP_dbl_type##
								</td>
								<td>
									##TP_dbl_user##
								</td>
							##TP_ENDIF##
							<td>
								##TP_IF {[tpBindGet result_conf] == "N"}##
									<select name="oc_res_##TP_ev_oc_id##">
										<script>
											write_result_sel("##TP_result##","##TP_result_flags##")
										</script>
									</select>
								##TP_ELSE##
									<script>write_result("##TP_result##","##TP_result_flags##")</script>
								##TP_ENDIF##
							</td>
							##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
								##TP_IF {[tpBindGet fb_result] != "L"}##
									<td>
										##TP_IF {[tpBindGet result_conf] == "N"}##
											<input type=text name="oc_score_##TP_ev_oc_id##" size=5 value="##TP_hcap_score##">
										##TP_ELSE##
											##TP_hcap_score##
										##TP_ENDIF##
									</td>
								##TP_ELSE##
									<td>&nbsp;</td>
								##TP_ENDIF##
							##TP_ENDIF##
						</tr>
					##TP_ELSE##
						<tr ##TP_IF {[expr {[tpGetVar s_idx]%2}] == 0}## class="row1" ##TP_ELSE## class="row2" ##TP_ENDIF##>
							##TP_IF {[tpGetVar MktDblRes]}##
								<td>
									##TP_dbl_type##
								</td>
								<td>
									##TP_dbl_user##
								</td>
							##TP_ENDIF##
							<td>
								##TP_IF {[tpBindGet dbl_mask] == 1}##
									##TP_DblMaskStr##
								##TP_ELSE##
									<script>
										write_result("##TP_result##","##TP_result_flags##")
									</script>
								##TP_ENDIF##
							</td>
							##TP_IF {[string first [tpGetVar MktType] "AHM"] >= 0}##
								<td>
									##TP_IF {[tpBindGet dbl_mask] == 1}##
										##TP_DblMaskStr##
									##TP_ELSEIF {[tpBindGet fb_result] != "L"}##
										##TP_hcap_score##
									##TP_ELSE##
										-
									##TP_ENDIF##
								</td>
							##TP_ENDIF##
						</tr>
					##TP_ENDIF##
				##TP_ENDLOOP##
			##TP_ENDLOOP##
			<script>write_ev_oc_id_list();</script>
			</table>
		##TP_ENDIF##
	##TP_ELSE##
		##TP_TCL -quiet {tpBindString SelTblCols 3}##
		<tr>
			<td colspan=3>
			<I>There are no selections specified for this market.</I>
			</td>
		</tr>
	##TP_ENDIF##
<input type=hidden name="EvId"     value="##TP_EvId##">
<input type=hidden name="MktId"    value="##TP_MktId##">
<input type=hidden name="SP_Avail" value="##TP_MktSPAvail##">
<tr>
	<th colspan="##TP_SelTblCols##" class=buttons>
	##TP_IF {[op_allowed SetResults] && [tpGetVar NumMktSelns] > 0}##
		<input type=button value="Set Selection Results" onClick="return fs(this,'SetSelRes')">
	##TP_ENDIF##
	<input type=button value="Back" onClick="return fs(this,'Back')">
	##TP_IF {[tpGetVar MktAutoDH 0]}##
		<input type=button value="Generate Reductions" onClick="return fs(this,'CalcDH')">
	##TP_ENDIF##
	</td>
</tr>
</table>
<input type=hidden name=SubmitName value="">
<input type=hidden name=action value="ADMIN::SELN::DoOcsRes">
</form>
<script type="text/javascript">
##TP_IF {[tpGetVar MktAutoDH 0]}##
	// Recalculate and write deadheat reductions
	//calcDHReductions();
##TP_ENDIF##
</script>
</body>
</html>
