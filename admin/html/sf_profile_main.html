<html>
<!-- $Id: sf_profile_main.html,v 1.1.1.1 2011/10/04 10:54:25 xbourgui Exp $ -->
<!-- Main page for adding or modifying a stake factor profile -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##" />
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet" />
<title>Stake Factor Profiles</title>
<script src="##TP_OFFICE_STATIC_URL##/js/base.js" language="javascript" type="text/javascript"></script>
<style type="text/css">
	input.changed {color: green;}
	input.invalid {color: red;}
	input.disabled {background-color: white;}
	.displayNone {display: none;}
</style>
<script>

	var limitCount = ##TP_TCL {tpGetVar NumLimits 0}##;
	var categoryIds = new Array();
	var classIds = new Array();
	var typeIds = new Array();
	var eventIds = new Array();

	// We need to do this to build up the various arrays of ids for each level
	// the hierarchy
	function buildLevelArrays() {
		var categoryList = new Array();
		var classList = new Array();
		var typeList = new Array();
		var eventList = new Array();
		var categories = "##TP_TCL {tpGetVar CategoryList ""}##";
		var classes = "##TP_TCL {tpGetVar ClassList ""}##";
		var types = "##TP_TCL {tpGetVar TypeList ""}##";
		var events = "##TP_TCL {tpGetVar EventList ""}##";
		if (categories != "") {
			categoryList = categories.split(" ");
		}
		if (classes != "") {
			classList = classes.split(" ");
		}
		if (types != "") {
			typeList = types.split(" ");
		}
		if (events != "") {
			eventList = events.split(" ");
		}

		for (var i in categoryList) {
			if (i == "indexOf") continue;
			categoryIds[categoryList[i]] = "Y";
		}
		for (var i in classList) {
			if (i == "indexOf") continue;
			classIds[classList[i]] = "Y";
		}
		for (var i in typeList) {
			if (i == "indexOf") continue;
			typeIds[typeList[i]] = "Y";
		}
		for (var i in eventList) {
			if (i == "indexOf") continue;
			eventIds[eventList[i]] = "Y";
		}
	}

	function fs (b, a) {
		var old_value = b.value;
		b.disabled = true;
		b.value = "Busy...";
		switch (a) {
			case "AddProfile":
				var cont = true;
				if (!checkField(document.getElementById("profile_name"), "ALPHANUM", false)) {
					alert("Invalid name - must not be null and can contain only alphanumeric values");
					cont = false;
				}
				if (populateSubmitLists() && cont) {
					b.form.action.value = "ADMIN::SFPROFILE::DoProfileAdd";
				} else {
					b.disabled = false;
					b.value = old_value;
					return false;
				}
				break;
			case "UpdProfile":
				var cont = true;
				if (!checkField(document.getElementById("profile_name"), "ALPHANUM", false)) {
					alert("Invalid name - must be not null and contain only alphanumeric values");
					cont = false;
				}
				if (populateSubmitLists() && cont) {
					b.form.action.value = "ADMIN::SFPROFILE::DoProfileUpd";
				} else {
					b.disabled = false;
					b.value = old_value;
					return false;
				}
				break;
			case "DelProfile":
				if (confirm("Are you sure you want to delete this profile?")) {
					b.form.action.value = "ADMIN::SFPROFILE::DoProfileDel";
				} else {
					b.disabled = false;
					b.value = old_value;
					return false;
				}
				break;
			case "CancelAdd":
				if (confirm("Are you sure you don't want to add this profile?")) {
					b.form.action.value = "ADMIN::SFPROFILE::GoProfileList";
				} else {
					b.disabled = false;
					b.value = old_value;
					return false;
				}
				break;
			case "CancelUpd":
				if (confirm("Are you sure you don't want to save changes to this profile?")) {
					b.form.action.value = "ADMIN::SFPROFILE::GoProfileList";
				} else {
					b.disabled = false;
					b.value = old_value;
					return false;
				}
				break;
			default:
				b.disabled = false;
				b.value = old_value;
				return false;
		}

		b.form.submit();
		return true;
	}

	// Takes the values from the inputs which are being submitted and puts
	// them into a series of lists
	function populateSubmitLists() {

		// Don't bother doing the limits if there are none
		if (limitCount != 0) {
			var fromLimit   = document.getElementById("from_limit_0").value;
			var toLimit     = document.getElementById("to_limit_0").value;
			var stakeFactor = document.getElementById("sf_0").value;

			for (var i = 1; i < limitCount; i++) {
				fromLimit   += "," + document.getElementById("from_limit_" + i).value;
				toLimit     += "," + document.getElementById("to_limit_" + i).value;
				stakeFactor += "," + document.getElementById("sf_" + i).value;
			}

			document.getElementById("from_list").value = fromLimit;
			document.getElementById("to_list").value   = toLimit;
			document.getElementById("sf_list").value   = stakeFactor;
		}

		// Populate the hierarchy levels
		var categories = "";
		var classes = "";
		var types = "";
		var events = "";

		for (var i in categoryIds) {
			if (i == "indexOf") continue;
			if (categoryIds[i] == "Y") {
				if (categories == "") {
					categories = i;
				} else {
					categories += "," + i;
				}
			}
		}
		for (var i in classIds) {
			if (i == "indexOf") continue;
			if (classIds[i] == "Y") {
				if (classes == "") {
					classes = i;
				} else {
					classes += "," + i;
				}
			}
		}
		for (var i in typeIds) {
			if (i == "indexOf") continue;
			if (typeIds[i] == "Y") {
				if (types == "") {
					types = i;
				} else {
					types += "," + i;
				}
			}
		}
		for (var i in eventIds) {
			if (i == "indexOf") continue;
			if (eventIds[i] == "Y") {
				if (events == "") {
					events = i;
				} else {
					events += "," + i;
				}
			}
		}

		document.getElementById("category_list").value = categories;
		document.getElementById("class_list").value = classes;
		document.getElementById("type_list").value = types;
		document.getElementById("event_list").value = events;

		return true;
	}

	// Add a new limit to the arrays
	function addLimit () {
		// First, validate the limit which is to be added
		var fromAdd = document.getElementById("from_limit_NEW");
		var toAdd = document.getElementById("to_limit_NEW");
		var sfAdd = document.getElementById("sf_NEW");

		if (!checkField(fromAdd, "INTEGER", false) || !checkField(toAdd, "INTEGERSTRICT", false) || !checkField(sfAdd, "FLOAT", false)) {
			alert ("Invalid field entries, please check limit values");
			return;
		}

		if (parseInt(fromAdd.value) <= parseInt(toAdd.value) && typeof fromAdd.value != undefined && fromAdd.value != "") {
			alert ("'From' value must be greater than the 'To' value");
			return;
		}

		// Check that previous "From" isn't null
		var prevFrom = document.getElementById("from_limit_" + (limitCount - 1));
		if ( prevFrom && (prevFrom.value == "" || typeof prevFrom.value == undefined) ) {
			alert ("Previous limit's From value must not be null, remove it first in order to add a new limit");
			return;
		}

		var newId = limitCount;
		limitCount++;

		// Add new input elements
		var newRow = document.createElement("tr");

		var newFromTd = document.createElement("td");
		var newDashTd = document.createElement("td");
		var newToTd = document.createElement("td");
		var newSFTd = document.createElement("td");
		var newLinkTd = document.createElement("td");

		var newFromInput = document.createElement("input");
		var newToInput = document.createElement("input");
		var newSFInput = document.createElement("input");
		var newLink = document.createElement("a");

		newRow.id = "limit_row_" + newId;

		newFromInput.type = "text";
		newFromInput.id = "from_limit_" + newId;
		newFromInput.size = 10;
		newFromInput.value = fromAdd.value;
		newFromInput.disabled = true;

		newDashTd.innerHTML = "-";

		newToInput.type = "text";
		newToInput.id = "to_limit_" + newId;
		newToInput.size = 10;
		newToInput.disabled = true;
		newToInput.value = toAdd.value;

		newSFInput.type = "text";
		newSFInput.id = "sf_" + newId;
		newSFInput.size = 10;
		newSFInput.value = sfAdd.value;

		newLink.href = "javascript: removeLimit(" + newId + ");";
		newLink.id = "remove_limit_" + newId;
		newLink.innerHTML = "Remove";

		addClass(newFromInput, "disabled");
		addClass(newToInput, "disabled");

		var tbody = document.getElementById("limit_body");

		newFromTd.appendChild(newFromInput);
		newToTd.appendChild(newToInput);
		newSFTd.appendChild(newSFInput);
		newLinkTd.appendChild(newLink);

		newRow.appendChild(newFromTd);
		newRow.appendChild(newDashTd);
		newRow.appendChild(newToTd);
		newRow.appendChild(newSFTd);
		newRow.appendChild(newLinkTd);

		tbody.appendChild(newRow);

		// Update the "Add New Limit Time" fields
		if (typeof fromAdd.value == undefined || fromAdd.value == "") {
			addClass(document.getElementById("add_table"), "displayNone");
		} else {
			toAdd.value = fromAdd.value;
			fromAdd.value = "";
		}

		// Hide the "Remove" link for any limits which aren't the last one
		if (limitCount > 1) {
			addClass(document.getElementById("remove_limit_" + (limitCount - 2)), "displayNone");
		}
	}

	function removeLimit() {
		limitCount--;
		var tbody = document.getElementById("limit_body");
		var toRemove = document.getElementById("to_limit_" + limitCount).value;
		tbody.removeChild(document.getElementById("limit_row_" + limitCount));

		// Update the "Add New LImit Time" fields
		var toAdd = document.getElementById("to_limit_NEW");
		toAdd.value = toRemove;

		removeClass(document.getElementById("add_table"), "displayNone");
		removeClass(document.getElementById("remove_limit_" + (limitCount - 1)), "displayNone");
	}

	// Simple wrapper function to validate input
	function checkField (_obj, _checkType, _raiseError, _max) {
		var rexp, error_msg;

		switch (_checkType) {
			case "INTEGER":
				rexp = new RegExp("^[0-9]*$");
				error_msg = "You must enter a whole number";
				break;
			case "INTEGERSTRICT":
				rexp = new RegExp("^[0-9]+$");
				error_msg = "You must enter a whole number";
				break;
			case "FLOAT":
				rexp = new RegExp("^([0-9]+|[0-9]*\\.[0-9]+)*$");
				error_msg = "You must enter a whole or decimal number";
				break;
			case "ALPHANUM":
				rexp = new RegExp("^[A-Za-z0-9 ]+$");
				error_msg = "You may only enter alphanumeric characters";
				break;
			default:
				return false;
		}

		if (rexp.test(_obj.value) == false) {
			if (_raiseError) alert (error_msg);
			addClass(_obj, "invalid");
			return false;
		} else {
			removeClass(_obj, "invalid");
		}

		// A bit hacky, as we just need to check the max in one place but easier....
		if (_obj.value > _max) {
			if (_raiseError) alert ("Maximum value can't be more than " + _max);
			addClass(_obj, "invalid");
			return false;
		} else {
			removeClass(_obj, "invalid");
		}

		return true;
	}

	function goDD() {
		popup=window.open("##TP_CGI_URL##?action=ADMIN::POPUP_DD::GoDD&selected_level=ROOT&selected_id=1&close_on_select=1&disable_links_at_level=EVENT&selectable_levels=EVENT,TYPE,CLASS,CATEGORY&select_option=CHECKBOX&show_date=1",  "popup","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,height=500,width=750");
		popup.focus();
	}

	function set_vals (levels, ids, names) {
		var level, id, newRow, newName, newHidden, newRemoveTd, newRemoveLink, parentRow;

		for (var i = 0; i < levels.length; i++) {
			// Add a new row into the relevant level
			level = levels[i];
			id = ids[i];

			// If we've already got it, no need to recreate
			newRow = document.getElementById(level + "_" + id);
			if (newRow) {
				continue;
			} else {
				switch (level) {
					case "CATEGORY":
						categoryIds[id] = "Y";
						break;
					case "CLASS":
						classIds[id] = "Y";
						break;
					case "TYPE":
						typeIds[id] = "Y";
						break;
					case "EVENT":
						eventIds[id] = "Y";
						break;
					default:
						// Invalid level so just ignore
						continue;
				}
			}

			newRow = document.createElement("tr");
			newName = document.createElement("td");
			newHidden = document.createElement("input");
			newRemoveTd = document.createElement("td");
			newRemoveLink = document.createElement("a");

			newRow.id = level + "_" + id;

			newName.innerHTML = names[i];

			newHidden.type = "hidden";
			newHidden.value = id;

			newRemoveLink.href = "javascript: removeLevel('" + level + "', " + id + ");";
			newRemoveLink.innerHTML = "Remove";

			newRemoveTd.appendChild(newRemoveLink);
			newRow.appendChild(newName);
			newRow.appendChild(newRemoveTd);
			newRow.appendChild(newHidden);

			switch (level) {
				case "CATEGORY":
					parentRow = document.getElementById("category_parent");
					parentTable = document.getElementById("category_table");
					categoryIds[id] = "Y";
					break;
				case "CLASS":
					parentRow = document.getElementById("class_parent");
					parentTable = document.getElementById("class_table");
					classIds[id] = "Y";
					break;
				case "TYPE":
					parentRow = document.getElementById("type_parent");
					parentTable = document.getElementById("type_table");
					typeIds[id] = "Y";
					break;
				case "EVENT":
					parentRow = document.getElementById("event_parent");
					parentTable = document.getElementById("event_table");
					eventIds[id] = "Y";
					break;
			}

			parentRow.appendChild(newRow);
			removeClass(parentTable, 'displayNone');
		}

	}

	function removeLevel(level, id) {
		var row = document.getElementById (level + "_" + id);
		var length = 0;

		if (row) {
			var parent_body = document.getElementById (level.toLowerCase() + "_parent");
			parent_body.removeChild(row);

			// If we've removed the final element in that level, hide the table
			switch (level) {
				case "CATEGORY":
					categoryIds[id] = "N";
					break;
				case "CLASS":
					classIds[id] = "N";
					break;
				case "TYPE":
					typeIds[id] = "N";
					break;
				case "EVENT":
					eventIds[id] = "N";
					break;
				default:
					// Invalid level
					return;
			}
			if (getNumActiveLevels(level) == 0) {
				addClass(document.getElementById(level.toLowerCase() + "_table"), "displayNone");
			}
		}
	}

	// Levels in the hierarchy are stored in an array, but we only want to
	// submit the ones marked "Y", not those which are "N"
	function getNumActiveLevels (level) {
		var arr;
		var count = 0;

		switch (level) {
			case "CATEGORY":
				arr = categoryIds;
				break;
			case "CLASS":
				arr = classIds;
				break;
			case "TYPE":
				arr = typeIds;
				break;
			case "EVENT":
				arr = eventIds;
				break;
			default:
				return 0;
		}

		for (var i in arr) {
			if (i == "indexOf") continue;
			if (arr[i] == "Y") count++;
		}

		return count;
	}

</script>
</head>
<body onload="javascript: buildLevelArrays();">
##TP_PLAY msg_rpt.html##
##TP_PLAY error_rpt.html##
<form>
<table>
	<thead>
		<tr><th class="title" colspan="2">Stake Factor Profile Details</th></tr>
	</thead>
	<tbody>
		<tr>
			<td>Name:</td>
			<td><input type="text" name="ProfileName" id="profile_name" value="##TP_ProfileName##" maxlength="50" size="60" onblur="javascript: checkField(this, 'ALPHANUM', true);" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="2">
			##TP_IF {[tpGetVar AddProfile 0] == 1}##
			<input type="button" class="btn_def" value="Add Profile" onclick="return fs(this, 'AddProfile');" />
			<input type="button" class="btn_def" value="Cancel" onclick="return fs(this,'CancelAdd');" />
			##TP_ELSE##
			<input type="button" class="btn_def" value="Update" onclick="return fs(this,'UpdProfile');" />
			<input type="button" class="btn_def" value="Delete" onclick="return fs(this,'DelProfile');" />
			<input type="button" class="btn_def" value="Cancel" onclick="return fs(this,'CancelUpd');" />
			##TP_ENDIF##
			</th>
		</tr>
	</tbody>
</table>
<table>
	<thead>
		<tr>
			<th colspan="5"class="title">Limit Times</th>
		</tr>
		<tr>
			<th>From (hrs)</th>
			<th />
			<th>To (hrs)</th>
			<th>Stake Factor (0-99)</th>
			<th />
		</tr>
	</thead>
	<tbody id="limit_body">
		##TP_IF {![tpGetVar AddProfile 0]}##
		##TP_LOOP limit_idx {[tpGetVar NumLimits]}##
		<tr id="limit_row_##TP_TCL {tpGetVar limit_idx}##">
			<td><input type="text" id="from_limit_##TP_TCL {tpGetVar limit_idx}##" class="disabled" value="##TP_From##" size="10" disabled="disabled" /></td>
			<td>-</td>
			<td><input type="text" id="to_limit_##TP_TCL {tpGetVar limit_idx}##" class="disabled" value="##TP_To##" size="10" disabled="disabled" /></td>
			<td><input type="text" id="sf_##TP_TCL {tpGetVar limit_idx}##" class="disabled" value="##TP_Sf##" size="10" onblur="javascript: checkField(this, 'FLOAT', true, 99);" /></td>
			<td><a href="javascript: removeLimit(##TP_TCL {tpGetVar limit_idx}##);" id="remove_limit_##TP_TCL {tpGetVar limit_idx}##" ##TP_IF {[expr [tpGetVar NumLimits] - 1] != [tpGetVar limit_idx]}##class="displayNone"##TP_ENDIF##>Remove</a></td>
		</tr>
		##TP_ENDLOOP##
		##TP_ENDIF##
	</tbody>
</table>
<input type="hidden" name="action" id="action" value="" />
<input type="hidden" name="FromList" id="from_list" value="" />
<input type="hidden" name="ToList" id="to_list" value="" />
<input type="hidden" name="SfList" id="sf_list" value="" />
<input type="hidden" name="ProfileId" id="profile_id" value="##TP_ProfileId##" />
<table id="add_table" ##TP_IF {[tpGetVar HideAdd 0] == 1}##class="displayNone"##TP_ENDIF##>
	<thead>
		<tr>
			<th colspan="4"class="title">Add New Limit Time</th>
		</tr>
		<tr>
			<th>From (hrs)</th>
			<th />
			<th>To (hrs)</th>
			<th>Stake Factor (0-99)</th>
		</tr>
	</thead>
	<tbody id="limit_body">
		<tr id="limit_row_0">
			<td><input type="text" id="from_limit_NEW" value="" size="10" onblur="javascript: checkField(this, 'INTEGER', true);" /></td>
			<td>-</td>
			<td><input type="text" id="to_limit_NEW" value="##TP_NextTo##" size="10" class="disabled"  disabled="disabled" /></td>
			<td><input type="text" id="sf_NEW" size="10" value="1.00" onblur="javascript: checkField(this, 'FLOAT', true, 99);" /></td>
		</tr>
		<tr>
			<th class="buttons" colspan="4">
				<input type="button" class="btn_def" value="Add" onclick="addLimit();" />
			</th>
		</tr>
	</tbody>
</table>
<table>
	<thead>
		<tr><th class="title" colspan="2">Event Hierarchy Links</th></tr>
		<tr>
			<th class="buttons" colspan="2">
				<input type="button" class="btn_def" value="Add Hierarchy Item" onclick="goDD();" />
			</th>
		</tr>
	</thead>
</table>
<table id="category_table"##TP_IF {[llength [tpGetVar CategoryList]] == 0}## class="displayNone"##TP_ENDIF##>
	<thead>
		<tr><th colspan="2">Categories</th></tr>
	</thead>
	<tbody id="category_parent">
		##TP_FOREACH category_idx {[tpGetVar CategoryList]}##
		<tr id="CATEGORY_##TP_TCL {tpGetVar category_idx}##">
			<td>##TP_CategoryName##</td>
			<td><a href="javascript: removeLevel('CATEGORY', ##TP_TCL {tpGetVar category_idx}##);">Remove</a></td>
		</tr>
		##TP_ENDFOREACH##
	</tbody>
</table>
<table id="class_table"##TP_IF {[llength [tpGetVar ClassList]] == 0}## class="displayNone"##TP_ENDIF##>
	<thead>
		<tr><th colspan="2">Classes</th></tr>
	</thead>
	<tbody id="class_parent">
		##TP_FOREACH class_idx {[tpGetVar ClassList]}##
		<tr id="CLASS_##TP_TCL {tpGetVar class_idx}##">
			<td>##TP_ClassName##</td>
			<td><a href="javascript: removeLevel('CLASS', ##TP_TCL {tpGetVar class_idx}##);">Remove</a></td>
		</tr>
		##TP_ENDFOREACH##
	</tbody>
</table>
<table id="type_table"##TP_IF {[llength [tpGetVar TypeList]] == 0}## class="displayNone"##TP_ENDIF##>
	<thead>
		<tr><th colspan="2">Types</th></tr>
	</thead>
	<tbody id="type_parent">
		##TP_FOREACH type_idx {[tpGetVar TypeList]}##
		<tr id="TYPE_##TP_TCL {tpGetVar type_idx}##">
			<td>##TP_TypeName##</td>
			<td><a href="javascript: removeLevel('TYPE', ##TP_TCL {tpGetVar type_idx}##);">Remove</a></td>
		</tr>
		##TP_ENDFOREACH##
	</tbody>
</table>
<table id="event_table"##TP_IF {[llength [tpGetVar EventList]] == 0}## class="displayNone"##TP_ENDIF##>
	<thead>
		<tr><th colspan="2">Events</th></tr>
	</thead>
	<tbody id="event_parent">
		##TP_FOREACH event_idx {[tpGetVar EventList]}##
		<tr id="EVENT_##TP_TCL {tpGetVar event_idx}##" name="EVENT">
			<td>##TP_EventName##</td>
			<td><a href="javascript: removeLevel('EVENT', ##TP_TCL {tpGetVar event_idx}##);">Remove</a></td>
		</tr>
		##TP_ENDFOREACH##
	</tbody>
</table>
<input type="hidden" name="CategoryList" id="category_list" value="" />
<input type="hidden" name="ClassList" id="class_list" value="" />
<input type="hidden" name="TypeList" id="type_list" value="" />
<input type="hidden" name="EventList" id="event_list" value="" />
</form>
</body>
</html>
