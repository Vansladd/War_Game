<html>
<!-- $Id: ipoints_qry.html,v 1.1.1.1 2011/10/04 10:54:25 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>OpenBet Administration</title>
##TP_PLAY header_cal.html##
<script>
function fs(b,t)
{
	var label = b.value;

	b.disabled = true;
	b.value = "Busy...";

	// Validate to make sure we have a sensible search
	if (b.form.name == "conversion_search" && !validate()) {
		b.disabled = false;
		b.value = label;
		return false;
	}

	b.form.SubmitName.value=t;
	b.form.submit();
	return true;
}

function validate()
{
		var conversion_made_1    = document.forms.conversion_search.SR_date_1.value,
		conversion_made_2    = document.forms.conversion_search.SR_date_2.value,
		conversion_range     = document.forms.conversion_search.SR_date_range.value,
		date_fields       = conversion_made_1 + conversion_made_2,
		compulsory_fields = document.forms.conversion_search.SR_username.value + document.forms.conversion_search.SR_acct_no.value + document.forms.conversion_search.SR_conversion_id.value, hours = 0, date_1, date_2,
		date_unit = 1000*60*60; // This is the number of milliseconds in an hour (unit of time for config item)

	// If we've got no dates and no compulsory fields, then we shouldn't run the search
	if (compulsory_fields == "") {
		if (date_fields == "") {
			// Drop down still counts as a date.
			if (conversion_range == "") {
				alert("The search you have entered will return a LOT of records.  Please redefine it to include at least one of the following fields:\n\t- Username\n\t- Account No\n\t- Date Range\n\t- Conversion ID");
				return 0;
			} else {
				date_1 = new Date();
				switch (conversion_range) {
				case "HR":
					hours = 1;
					break;
				case "TD":
					hours = date_1.getHours();
					break;
				case "YD":
					hours = date_1.getHours() + 24;
					break;
				case "L3":
					hours = date_1.getHours() + 72;
					break;
				case "L7":
					hours = date_1.getHours() + 168;
					break;
				case "CM":
					// Assuming 30 days in a month
					date_2 = new Date(date_1.getFullYear(),date_1.getMonth(),1);
					hours = Math.ceil( (date_1.getTime() - date_2.getTime())/date_unit );
					break;
				}
			}
		} else {
			// Set the number of hours between the dates specified
			var re = new RegExp("[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}");
			if (conversion_made_1 != "" && conversion_made_2 != "") {

				if (!re.test(conversion_made_1)) {
					alert("First 'Bet placed between' date is invalid");
					return 0;
				} else if (!re.test(conversion_made_2)) {
					alert("Second 'Bet placed between' date is invalid");
					return 0;
				}

				date_1 = new Date(conversion_made_1.substring(0,4),parseInt(conversion_made_1.substring(5,7)) - 1,parseInt(conversion_made_1.substring(8,10)));
				date_2 = new Date(conversion_made_2.substring(0,4),parseInt(conversion_made_2.substring(5,7)) - 1,parseInt(conversion_made_2.substring(8,10)));

				date_1.setUTCHours(parseInt(conversion_made_1.substring(11,13)));
				date_1.setMinutes(parseInt(conversion_made_1.substring(14,16)));
				date_1.setSeconds(parseInt(conversion_made_1.substring(17,19)));
				date_2.setUTCHours(parseInt(conversion_made_2.substring(11,13)));
				date_2.setMinutes(parseInt(conversion_made_2.substring(14,16)));
				date_2.setSeconds(parseInt(conversion_made_2.substring(17,19)));

				// Actually do the calculation and set the number of hours
				hours = Math.ceil( (date_2.getTime() - date_1.getTime())/date_unit );

			} else {
				alert("Please enter both a from and to date.");
				return 0;
			}
		}

		if (hours <= ##TP_TCL {tpBufWrite [OT_CfgGet PT_IPOINTS_SEARCH_HOUR_LIMIT 99999]}##) {
			// The hours are beneath the limit we've set so it's ok to do the search
				return 1;
		} else if (confirm("The date range you have specified will return a large number of records.  As a result, it may take some time to return results and impact the speed of the database for other users.  Continue?")) {
				return 1;
		} else {
				return 0;
		}
	} else {
		// We've got something in the compulsory fields somewhere
		return 1;
	}
}

function displayCalendars() {
	new Calendar(document.forms.conversion_search.SR_date_1,null,true,"lo")
	new Calendar(document.forms.conversion_search.SR_date_2,null,true,"lo")
}

</script>
##TP_PLAY JS_WriteSelect.html##
</head>
<body onload="displayCalendars()">
##TP_PLAY error_rpt.html##
<table cellspacing=0 cellpadding=2 border=0>
<form name="conversion_search" method=get action=##TP_CGI_URL##>
<tr>
	<th colspan=3 class=title>
	iPoints Conversion Search
	</th>
</tr>
<tr class=subtitle>
	<th colspan=2 align=left>iPoints Conversion Search</th>
</tr>
<tr>
	<td class=captionindex>Username like</td>
	<td><input type="text" name="SR_username" value="" size=32>&nbsp;
	(case insensitive&nbsp;
	<input type="checkbox" name="SR_upper_username" value="Y" ##TP_IF {[OT_CfgGet FUNC_DEF_CASE_INS_SEARCH 0] == 1}##checked##TP_ENDIF##>
	&nbsp;)</td>
</tr>
<tr>
	<td class=captionindex>Account No</td>
	<td><input type="text"  name="SR_acct_no" value="" size=32>&nbsp;
	(exact&nbsp;
	<input type="checkbox" name="SR_acct_no_exact" value="Y" checked>
	&nbsp;)
    </td>
</tr>
<tr>
	<td class=captionindex>Date Range</td>
	<td>
	<input type="text" name="SR_date_1" value="" size=19>
	&nbsp;and&nbsp;
	<input type="text" name="SR_date_2" value="" size=19>&nbsp;(yyyy-mm-dd hh:mm:ss)
	</td>
</tr>
<tr>
	<td class=captionindex>or</td>
	<td>
	<select name="SR_date_range">
		<option value="">n/a</option>
		<option value="HR" selected>Last hour</option>
		<option value="TD">Today</option>
		<option value="YD">Yesterday</option>
		<option value="L3">Last 3 days</option>
		<option value="L7">Last 7 days</option>
		<option value="CM">Current month</option>
	</select>
	</td>
</tr>
<tr>
	<td class=caption>Status</td>
	<td>
	<select name="SR_status">
		<option value="">Any</option>
		<option value="Y">Good</option>
		<option value="N">Bad</option>
		<option value="U">Unknown</option>
	</select>
	</td>
</tr>
<tr>
	<td class="caption">Conversion ID</td>
	<td><input type="text" name="SR_conversion_id" value="" /></td>
</tr>
<tr>
	<th class=buttons colspan=3>
	<input type=button class="btn_def" value="Find Conversions" onClick="return fs(this,'DoQuery')">
	</th>
</tr>
<input type=hidden name=SubmitName value="">
<input type=hidden name=action value=ADMIN::IPOINTS::DoQuery>
</form>
</table>

</body>
</html>
