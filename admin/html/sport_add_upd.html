<html>
<!-- $Id: sport_add_upd.html,v 1.1.1.1 2011/10/04 10:54:25 xbourgui Exp $ -->
<head>
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>Add/Update Sport and Market Mappings</title>
<script>

function check_valid (b,t)
{
	if (b.form.SportName.value == "" || b.form.SportDDLevel.value == "Please Select" || b.form.SportDDLevel.value == "") {
		alert ("Please enter missing data")
		return false;
	} else {
		return fs(b,t)
	}	
}

function fs(b,t)
{
	b.disabled = true;
	b.value = "Busy...";
	b.form.SubmitName.value=t;
	b.form.submit();
	return true;
}


function add_mkt_map(b,t)
{
	if ( validate_update(b.form) ) {
		b.disabled = true;
		b.value = "Busy...";
		b.form.SubmitName.value=t;
		b.form.submit();
		return true;
	} else {
		alert ("The Market Linking is empty or not valid");
		return false;
	}
}

function del_mkt_map(b,t) {

	// Fetch the existing ones
	id_list = b.form.ExistingLinks.value.split(' ');

	// initialize the delete array
	var to_delete = new Array();

	// Push the to be deleted id on the list
	for (var i = 0; i < id_list.length ; i++) {
		var is_chk = eval ('b.form.del_'+id_list[i]+'.checked');
		if (is_chk) {
			to_delete.push(id_list[i]);
		}
	}

	// Have we anything to delete? if so, do it otherwise cancel with
	// an alert message
	if(to_delete.length > 0 ) {

		// Make sure it's wanted
		if (!(confirm ("Are you sure you want to delete?"))) {
			return false;
		}
	
		b.form.ToDelete.value = to_delete.join(' ');
		b.disabled = true;
		b.value = "Busy...";
		b.form.SubmitName.value=t;
		b.form.submit();
		return true ;
	} else {
		alert ("You have not selected anything to delete");
		return false;
	}

}

function validate_update (f) {

	// How many options we have
	master_options  = f.AddMasterMktSel.options.length;
	slave_options   = f.AddSlaveMktSel.options.length;

	// Populate Master market
	for (var i = 0; i < master_options; i++) {
		if (f.AddMasterMktSel.options[i].selected) {
			f.SelectedMaster.value = f.AddMasterMktSel.options[i].value;
		}
	}

	var slave_list = new Array();
	
	// Populate Slave markets
	for (var i = 0; i < slave_options; i++) {
		if (f.AddSlaveMktSel.options[i].selected) {
			// Add the slave to the list
			slave_list.push(f.AddSlaveMktSel.options[i].value);
		}
	}

	var separator = f.Separator.value;

	// Do we have a master market and at least one slave? 
	if (slave_list.length > 0 && f.SelectedMaster.value != "") {

		// In case it wasn't done, force the master market in the slave list
		// as well to create the master record.
		var master_found_in_slave_list = false;

		for (var j = 0; j < slave_list.length; j++) {
			if (slave_list[j] == f.SelectedMaster.value) {
				master_found_in_slave_list = true;
				break;
			}
		}

		// Was it found? if not, push it on the list
		if (master_found_in_slave_list == false) {
			slave_list.push(f.SelectedMaster.value);
		}

		// Is the user creating a "self" mapping?
		if (slave_list.length == 1 && f.SelectedMaster.value == slave_list[0]) {
			alert("Cannot create a single linking on the same market");
			return false;
		}

		// All ok ...
		// Populate the input field
		f.SelectedSlave.value = slave_list.join(separator);

		return true ;
	}
	return false;

}


function clear_dd_level(b)
{
	b.SportDDLevel.value = "Please Select";
}

function GoDD()
{
	popup=window.open("##TP_CGI_URL##?action=ADMIN::BIR::do_bir_dd&selected_level=ROOT&disable_links_at_level=CLASS",  "popup",
		"toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,height=400,width=600");

	popup.focus();
}

function set_vals(level, id, name) {
	f = document.sportFm;
	if (!f) {
		alert("unable to find form");
		return;
	}

	f.SportDDLevel.value   = name;
	f.SportName.value      = name;
	f.SportObId.value      = id;

	if (level == "CATEGORY") {
		level = 'y' ;
	} else if (level == "CLASS") {
		level = 'c' ;
	} else {
		alert("Invalid level has been entered");
	}

	f.SportObLevel.value = level;
}

</script>
</head>

<body>

##TP_PLAY error_rpt.html##
##TP_PLAY msg_rpt.html##

<form method="get" action="##TP_CGI_URL##" name="sportFm">
	<input type="hidden" name="action" value="ADMIN::SPORT::DoSport" />
	<input type="hidden" name="SubmitName" value="" />
<table cellspacing="0" cellpadding="2" border="0">

	<tr>
		<th colspan="4" class="title">
		##TP_IF {[tpGetVar sport_id] == ""}##
			Add Sport
		##TP_ELSE##
			Update Sport
		##TP_ENDIF##
		</th>
	</tr>
	<tr>
		<td class="captionindex">Sport Name</td>
		<td colspan="1">
		<input type="text" name="SportName" value="##TP_SportName##" maxlength="50" />
		</td>
	</tr>
	<tr>
		<td class="caption">Drill Down Level</td>
		<td colspan="1">
			
			##TP_IF {[tpGetVar sport_id] == ""}##
				<input disabled="true" type="text" name="SportDDLevel" value="Please Select" maxlength="50" />
			##TP_ELSE##
				<input disabled="true" type="text" name="SportDDLevel" value="##TP_SportDDLevel##" maxlength="50" />
			##TP_ENDIF##

			##TP_IF {[tpGetVar allowDDLevelUpd 0]}##
				&nbsp;&nbsp;
				<A HREF="javascript: GoDD();">Select</A>
				&nbsp;&nbsp;
				<A HREF="javascript: clear_dd_level(document.sportFm)">Clear</A>
			##TP_ENDIF##	
		</td>
	</tr>

	<tr>
		##TP_IF {[OT_CfgGet FUNC_MENU_SPORTS 0] && [op_allowed ManageSport]}##
			<th class="buttons">
				<input type="button" value="OK" onClick="return check_valid(this,'SportAddUpd')" />
			</th>
		##TP_ENDIF##
		<th class="buttons">
			
			<input type="button" value="Cancel" onClick="return fs(this,'Back')" />
			<input type="hidden" name="SportObLevel" value="##TP_SportObLevel##">
			<input type="hidden" name="SportObId"    value="##TP_SportObId##">
			<input type="hidden" name="SportId" value="##TP_TCL {tpBufWrite [tpGetVar sport_id]} ##">
		</th>
	</tr>

</table>
</form>

##TP_IF {[tpGetVar sport_id] != ""}##
<table border="0" cellspacing="0" cellpadding="3">
	<form name="MarketListForm" action="##TP_CGI_URL##" method="post">

	<input type="hidden" name="SportId" value="##TP_TCL {tpBufWrite [tpGetVar sport_id]} ##">
	<input type="hidden" name="action" value="ADMIN::SPORT::DoMktLink" />
	<input type="hidden" name="SelectedMaster" value="" />
	<input type="hidden" name="SelectedSlave"  value="" />
	<input type="hidden" name="SubmitName" value="" />
	<input type="hidden" name="Separator" value="~"/>
	<input type="hidden" name="ToDelete" value="" />
	<input type="hidden" name="ExistingLinks" value="##TP_ExistingLinks##"/>

	<input type="hidden" name="SportObLevel" value="##TP_SportObLevel##">
	<input type="hidden" name="SportObId"    value="##TP_SportObId##">
	<input type="hidden" name="SportId" value="##TP_TCL {tpBufWrite [tpGetVar sport_id]} ##">
	<input type="hidden" name="SportDDLevel" value="##TP_SportDDLevel##"/>
	<input type="hidden" name="SportName" value="##TP_SportName##"/>

	<tr>
		<th class="title" colspan="3">
		Market links for ##TP_SportName##
		</th>
	</tr>
	<tr class="subtitle">
		<td colspan="3">Existing links</td>
	</tr>
	<tr>
		<th>Master</th>
		<th>Mapped market</th>
		<th>-</th>
	</tr>
	##TP_IF {[tpGetVar NumLinks] > 0 }##

		##TP_LOOP mkt_idx {[tpGetVar NumLinks]}##
			##TP_IF { [tpBindGet MktMaster] != [tpBindGet MktSlave] }##
			<tr>
				<td>##TP_MktMaster##</td>
				<td>##TP_MktSlave##</td>
				<td>##TP_IF {[OT_CfgGet FUNC_MENU_SPORTS 0] && [op_allowed ManageSport]}##<input name="del_##TP_LinkId##" type="checkbox" value="##TP_LinkId##"></td>##TP_ENDIF##
			</tr>
			##TP_ENDIF##
		##TP_ENDLOOP##

	##TP_ELSE##
	<tr>
		<td colspan="3">There are no market linking defined for this sport</td>
	</tr>
	##TP_ENDIF##

	##TP_IF {[OT_CfgGet FUNC_MENU_SPORTS 0] && [op_allowed ManageSport]}##
	<tr>
		<th class="subtitle" colspan="3">
		Add new market link for ##TP_SportName##
		</th>
	</tr>
	<tr>
		<th>Master Market</th>
		<th>Map to ...</th>
		<th>-</th>
	</tr>
	<tr>
		<td>
		##TP_IF {[tpGetVar NumberMasMarketNames] > 0 }##
		<select name="AddMasterMktSel" size="8">
			##TP_LOOP MAS_MKTS_idx {[tpGetVar NumberMasMarketNames]}##
			<option value="##TP_MasMktName##">##TP_MasMktName##</option>
			##TP_ENDLOOP##
		</select>
		##TP_ELSE##
			There are no markets to link
		##TP_ENDIF##
		</td>
		<td>
		##TP_IF {[tpGetVar NumberSlvMarketNames] > 0 }##
		<select name="AddSlaveMktSel" size="8" multiple="multiple">
			##TP_LOOP SLV_MKTS_idx {[tpGetVar NumberSlvMarketNames]}##
			<option value="##TP_SlvMktName##">##TP_SlvMktName##</option>
			##TP_ENDLOOP##
		</select>
		</td>
		##TP_ELSE##
			There are no markets to link
		##TP_ENDIF##
	</th>
	</tr>
	##TP_IF {[OT_CfgGet FUNC_MENU_SPORTS 0] && [op_allowed ManageSport]}##
	<tr>
		<th class="buttons" colspan="3">
			<input type="button" value="Add Market Link" onClick="javascript:add_mkt_map(this,'ADD');" ##TP_IF {[tpGetVar NumberSlvMarketNames] == 0 || [tpGetVar NumberMasMarketNames] == 0}## disabled="disabled" ##TP_ENDIF##/>
			<input type="button" value ="Delete selected mappings" onClick="javascript:del_mkt_map(this,'DEL');"/ >
		</th>
	</tr>
	##TP_ENDIF##
	##TP_ENDIF##
	</form>
</table>
##TP_ENDIF##
</body>
</html>
