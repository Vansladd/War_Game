<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!-- $Id: oncourse_trans.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##" />
<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
<title>On-Course Summary</title>
##TP_PLAY header_cal.html##
<script>
function fs(b,t,fname)
{
	document.disabled = true;
	document.value = "Busy...";
	this_form = document.getElementById(b);
	this_form.filename.value=fname;
	if (!check_upload_oc_file(this_form)) {return;}
	this_form.SubmitName.value=t;
	this_form.submit();
	return true;
}

function update_batch(b,t,batch_ref_id, ocb_id)
{
	document.disabled = true;
	document.value = "Busy...";
	this_form = document.getElementById(b);
	this_form.batch_ref_id.value=batch_ref_id;
	this_form.ocb_id.value=ocb_id;
	this_form.SubmitName.value=t;
	this_form.submit();
	return true;
}

function check_upload_oc_file(form)
{
  if (!checkFileName(form.filename.value)) { return false; }
  if (form.course.value.length == 0) {
    alert("The field 'Meeting Name' must not be empty");
    return false;
  }
  return true;
}

function check_batch(form)
{
  if (form.course.value.length == 0 || form.course.value.length > 32) {
    alert("The field 'Meeting Name' \n must not be empty or longer than 32 characters");
    return false;
  }
  if (!_isInteger(form.batch_ref_id.value)){
    alert ("The field 'Batch Reference' must be an integer");
    return false;
  }
  return true;
}

function _isInteger(str) {
  var re = /^\s*\d+\s*/;
  if (re.test(str)) {return true;}
  return false;
}

function _isDate(str) {
	var re = /^\s*\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\s*/;
	if (re.test(str)) {return true;}
	return false;
}

function check_add_batch(form) {
	if (form.meeting_name.value.length == 0 || form.meeting_name.value.length > 32) {
		alert("The field 'Meeting Name' \n must not be empty or longer than 32 characters");
		return false;
	}

	if (!_isDate(form.meeting_date.value)) {
		alert ("The field 'Meeting Date' must contain a valid date in the format YYYY-MM-DD hh:mm:ss");
		return false;
	}

	return true;
}

function confirm_delete(msg) {
	return confirm(msg);
}

function displayCalendars() {
	new Calendar(document.forms.add_meeting_batch.meeting_date,null,true,"lo");

##TP_LOOP courseIndex {[tpGetVar numTracks]}##
	new Calendar(document.forms.manual_bet_batches.date_##TP_OCBId##,null,true,"lo");
	##TP_LOOP batchIndex {[tpBindGet numBatches]}##
		new Calendar(document.forms.manual_bet_batches.process_date_##TP_BatchId##,null,true,"lo");
	##TP_ENDLOOP##
##TP_ENDLOOP##
}

##TP_PLAY upload/JS_CheckFileName.html##

</script>
</head>

<body onload="displayCalendars();">
##TP_PLAY error_rpt.html##
##TP_PLAY msg_rpt.html##
<table style="spacing:1px; border:none padding:1px;">
<tr>
	<th colspan="4" class="title">
		Add Meeting Batch
	</th>
</tr>
<form action="##TP_CGI_URL##" method="post" name=add_meeting_batch onsubmit="return check_add_batch(this);">
<input type="hidden" name="action" value="ADMIN::ONCOURSE::DoOnCourse">
<input type="hidden" name="returl" value="##TP_CGI_URL##" />
<input type="hidden" name="retaction" value="ADMIN::ONCOURSE::GoOnCourse" />
<input type="hidden" name="SubmitName" value="add_meeting_batch">
<tr>
	<td align=right>Meeting Name</td>
	<td>
		<input type="text" name="meeting_name" value="" size=19><br>
	</td>
</tr>
<tr>
	<td align=right>Meeting Date<br>&nbsp;</td>
	<td>
		<input type="text" name="meeting_date" value="" size=19><br>
		Date/time format: YYYY-MM-DD hh:mm:ss
	</td>
</tr>
<tr><td><input type="submit" class="btn_def" value="Add" /></td></tr>
</form>
</table>
When there are files in ##TP_ONCOURSE_UPLOAD_PATH## they will appear here for you to process.<br />
Process once and then delete.
<form id="process_files" method="post" action="##TP_CGI_URL##" enctype="multipart/form-data">
<input type="hidden" name="returl" value="##TP_CGI_URL##" />
<input type="hidden" name="retaction" value="ADMIN::ONCOURSE::GoOnCourse" />
<input type="hidden" name="action" value="ADMIN::ONCOURSE::DoOnCourse">
<input type="hidden" name="SubmitName" value="">
<input type="hidden" name="filename" value="">
<input type="hidden" name="filetype" value="oncourse">
<table style="spacing:1px; border:none padding:1px;">
<tr>
	<th colspan="4" class="title">
		Process On-course Bet Report Files
	</th>
</tr>

<tr>
	<td class=mandatory_caption>
		Meeting Name
	</td>
	<td colspan=3>
		<select name="course">
		<option value="">--</option>
		##TP_LOOP meetingIndex {[tpGetVar numMeetings]}##
			<option value="##TP_MeetingName##/##TP_MeetingDate##/##TP_MeetingOCBId##">##TP_MeetingName## - ##TP_MeetingDate##</option>
		##TP_ENDLOOP##
		</select>
	</td>
</tr>

<tr>
	<th class="colhead">File name</th>
	<th class="colhead" title="Processes Bet lines as Manual Bets">Process Bets</th>
	<th class="colhead" title="Processes Cash/Cheque lines as Manual Adjustments">Process Adjustments</th>
	<th class="colhead">Delete File <br />when processing complete</th>
</tr>

##TP_LOOP fileIdx {[tpGetVar numFiles]}##
<tr>
	<td>##TP_OCFileName##</td>
	<td>
		##TP_COMMENT {The Focus is intended as a guide for the user, but is not fully implemented currently}##
		##TP_IF {[tpBindGet OCFocus] == "BETS"}##-->##TP_ENDIF##
		<a href="javascript:fs('process_files', 'upload_bets', '##TP_OCFileName##')"
		   title="Processes Bet lines as Manual Bets">[process bets]</a>
	</td>
	<td>
		##TP_IF {[tpBindGet OCFocus] == "ADJ"}##-->##TP_ENDIF##
		<a href="javascript:fs('process_files', 'upload_adj', '##TP_OCFileName##')"
		   title="Processes Cash/Cheque lines as Manual Adjustments">[process adj]</a>
	</td>
	<td>
		##TP_IF {[tpBindGet OCFocus] == "DEL"}##-->##TP_ENDIF##
		<a href="##TP_CGI_URL##?action=ADMIN::ONCOURSE::DoOnCourse&SubmitName=del_oc_file&filename=##TP_OCFileName##"
		   title="Processed files will remain archived here:  ##TP_OCUploadsDir##"
		   onclick="return confirm_delete('Remove csv, filename: \'##TP_OCFileName##\'?')">[delete]</a>
	</td>
</tr>
##TP_ENDLOOP##

</table>

</form>


<form id="manual_bet_batches" method="post" action="##TP_CGI_URL##" onsubmit="return check_batch(this)">
<input type="hidden" name="returl" value="##TP_CGI_URL##" />
<input type="hidden" name="retaction" value="ADMIN::ONCOURSE::GoOnCourse" />
<input type="hidden" name="action" value="ADMIN::ONCOURSE::DoOnCourse">
<input type="hidden" name="SubmitName" value="set_batch">
<input type="hidden" name="batch_ref_id" value="">
<input type="hidden" name="ocb_id" value="">

<table style="spacing:1px; border:none padding:1px;">
<tr>
	<th colspan="7" class="title">
	On-Course Manual Bet Batches by Track
	</th>
</tr>
<tr>
	<th class="colhead">Meeting Name</th>
	<th class="colhead">Meeting Date</th>
	<th class="colhead">Batch Reference</th>
	<th class="colhead">Remove from Course</th>
	<th class="colhead">Process Date</th>
	<th class="colhead">Update Batch</th>
	<th class="colhead">Delete Meeting</th>
</tr>
##TP_LOOP courseIndex {[tpGetVar numTracks]}##
<tr ##TP_IF {[tpBindGet InPast] == 1}##style="background: red"##TP_ENDIF##>
	<td><input type="text" size="20" name="course_##TP_OCBId##" value="##TP_Course##"></td>
	<td><input type="text" style="width:14em" size="19" name="date_##TP_OCBId##" value="##TP_CourseDate##"></td>
	<td>
	<table>
	##TP_LOOP batchIndex {[tpBindGet numBatches]}##
		<tr><td>##TP_IF {[tpBindGet BatchID] == -1}## No associated uploads ##TP_ELSE## ##TP_BatchID## ##TP_ENDIF## ##TP_IF {$OC_BATCH([tpGetVar courseIndex],[tpGetVar batchIndex],is_processed) == 1}##<a HREF="##TP_CGI_URL##?action=ADMIN::BET::DoManualBetQuery&batch_ref_id=##TP_BatchID##&man_only=Y">[view bets]</a>
	<a HREF="##TP_CGI_URL##?action=ADMIN::ADJ::do_adj_query&SR_batch_ref_id=##TP_BatchID##">[view adj]</a>##TP_ENDIF##<br/></td></tr>
	##TP_ENDLOOP##
	</table>
	</td>
	<td>
	<table>
	##TP_LOOP batchIndex {[tpBindGet numBatches]}##
		 <tr><td>##TP_IF {$OC_BATCH([tpGetVar courseIndex],[tpGetVar batchIndex],is_processed) == 1}##<a HREF="##TP_CGI_URL##?action=ADMIN::ONCOURSE::DoOnCourse&SubmitName=remove_batch&batch_ref_id=##TP_BatchID##"
		   onclick="return confirm_delete('Remove batch, Batch Reference:##TP_BatchID##?')">[remove]</a>##TP_ENDIF##<br/></td></tr>
	##TP_ENDLOOP##
	</table>
	</td>
	<td>
	<table>
	##TP_LOOP batchIndex {[tpBindGet numBatches]}##
		<tr><td><input type="text" style="width:14em" size="19" name="process_date_##TP_BatchID##" value="##TP_BatchDate##"></td></tr>
	##TP_ENDLOOP##
	</table>
	</td>
	<td>
	<table>
	##TP_LOOP batchIndex {[tpBindGet numBatches]}##
	<tr><td><a href="javascript:update_batch('manual_bet_batches', 'set_batch', '##TP_BatchID##', '##TP_OCBId##')">[update]</a></td></tr>
	##TP_ENDLOOP##
	</table>
	</td>
	<td>
	<a href="##TP_CGI_URL##?action=ADMIN::ONCOURSE::DoOnCourse&SubmitName=delete_meeting&ocb_id=##TP_OCBId##"
		   onclick="return confirm_delete('Delete meeting ##TP_Course##?')">[delete]</a>
	</td>
</tr>
##TP_ENDLOOP##
</table>
</form>



<br /><br />
<b>Notes</b><br />
Files to be uploaded must be in <a href="#CSV">CSV</a> format. <br />
The files must be internally consistent.  e.g. The sum of all Bet stakes for a given race should equal the Race stakes for that race.  <br/>
The value of first column determines the row type. The row types are as follows: <br />
<br />

<table style="spacing:1px; border:none padding:1px;">
<tr>
	<th colspan="5" class="title">
	OnCourse Bet Report Row Formats
	</th>
</tr>
<tr>
	<th class="colhead">Details of Meeting</th>
	<th class="colhead">Details of Race</th>
	<th class="colhead">Details of Competitors</th>
	<th class="colhead">Details of Bets</th>
	<th class="colhead">Cash/Cheques</th>
</tr>
<tr>
	<td valign="top" style="text-align:left;">
		<ol>
			<li>Row Type (M)</li>
			<li>Meeting Key</li>
			<li>Meeting Date</li>
			<li>Rep. Code</li>
			<li>Rep. Name</li>
			<li>Clerk Name</li>
			<li>Win Stakes</li>
			<li>Pl Stakes</li>
			<li>Win W/L</li>
			<li>Pl W/L</li>
			<li>Card Tot</li>
			<li>Card Stakes</li>
			<li>Tot Expenses</li>
			<li>Cash Start</li>
			<li>Cash Book W/L</li>
			<li>Cash Rec Paid</li>
			<li>Tot Off Stakes</li>
			<li>Tot Crs Stakes</li>
			<li>Tot Off W/L</li>
			<li>Tot Crs W/L</li>
			<li>Cash DR Bank</li>
			<li>Cash at Fin</li>
			<li>Cash Transfer</li>
			<li>Cash Adj</li>
			<li>Actual Cash at Fin</li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
			<li>Cash Excomm</li>
		</ol>
	</td>
	<td valign="top" style="text-align:left;">
		<ol>
			<li>Row Type (R)</li>
			<li>Race Key</li>
			<li>Meeting Key</li>
			<li>Win Stakes</li>
			<li>Pl Stakes</li>
			<li>Win W/L</li>
			<li>Pl W/L</li>
			<li>Cash Win Stakes</li>
			<li>Cash Pl Stakes</li>
			<li>Credit Win Stakes</li>
			<li>Credit Pl Stakes</li>
			<li>Office Hedge Stakes</li>
			<li>Crs Hedge Stakes</li>
			<li>Office Hedge W/L</li>
			<li>Crs Hedge W/L</li>
			<li>Result Changed</li>
			<li>Result Settled</li>
			<li>Reason for not Settling</li>
			<li>Result Time</li>
			<li>No. Result Changes</li>
			<li>Rule4</li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
			<li>Race time</li>
		</ol>
	</td>
	<td valign="top" align="left">
		<ol>
			<li>Row Type (H)</li>
			<li>Runner Key</li>
			<li>Race Key</li>
			<li>Runner Name</li>
			<li>Racecard No.</li>
			<li>Odds</li>
			<li>Position</li>
			<li>Win</li>
			<li>Place</li>
			<li>With</li>
		</ol>
	</td>
	<td valign="top" style="text-align:left;">
		<ol>
			<li>Row Type (B)</li>
			<li>Bet Key</li>
			<li>Race Key</li>
			<li>Runner Key</li>
			<li>Account No</li>
			<li>Forename</li>
			<li>Surname</li>
			<li>Nickname</li>
			<li>Trans Type</li>
			<li>Ratio Bet</li>
			<li>Cover to Win</li>
			<li>Cover to EW</li>
			<li>Fair Price</li>
			<li>Hedged Bet</li>
			<li>Price</li>
			<li>Win Stake</li>
			<li>Place Stake</li>
			<li>Win Returns</li>
			<li>Place Returns</li>
			<li>Duty Relief</li>
			<li>SP</li>
			<li>Rule4</li>
			<li>Void Bet</li>
			<li>Void Time</li>
			<li>Ticket Prod</li>
			<li>Ticket ID</li>
			<li>Date</li>
			<li>Time</li>
			<li>Paid Out</li>
			<li>Runner Name</li>
		</ol>
	</td>
	<td valign=top align=left>
		<ol>
			<li>Row Type (C)</li>
			<li>Account No.</li>
			<li>Account Name</li>
			<li>Meeting Key</li>
			<li>Rep Code</li>
			<li>Cash</li>
			<li>Payment Type</li>
			<li>Cheque No.</li>
			<li>Bank Acc No.</li>
		</ol>
	</td>
</tr>

</table>
<br /><br />
<a name="CSV"><b>CSV Files</b></a><br />
<p>A CSV file is a comma-separated file. Fields which themselves contain commas need to be enclosed in double quotes.</p>


</body>
</html>
