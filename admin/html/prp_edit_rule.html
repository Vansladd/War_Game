<html>
<!-- $Id: prp_edit_rule.html,v 1.1.1.1 2011/10/04 10:54:25 xbourgui Exp $ -->
<head>
	<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
	<title>Payment Gateway Rule</title>
	##TP_PLAY JS_WriteSelect.html##
	<script type="text/javascript">

		function fs(b,t) {

			// cache the form elements
			var elems = document.forms["PMTGWRuleFrm"].elements;

			// check that the percentages specified are correctly specified and
			// add up to 100%
			if(t == "DoEditPmtRule") {

				var totalPercentage = 0;

				for (var i = 0; i < ##TP_TCL {tpBufWrite [tpGetVar N_Accts]}##; i++) {

					var percentage = elems["percentage_" + i].value;

					if (percentage == "") {
						continue;
					}

					if(!isNaN(parseInt(percentage))) {

						if(percentage < 0 || percentage > 100) {

							alert(percentage + "% must be between 0 and 100");

							return false;

						} else {

							totalPercentage += parseInt(percentage);
						}

					} else {

						alert("Percentage values must be integers");
						return false;
					}
				}

				if(totalPercentage != 100) {

					alert("The total percentage is " + totalPercentage +
							"%, this value should be 100%");

					return false;
				}
			}

			b.disabled          = true;
			b.value             = "Busy...";
			b.form.action.value = "ADMIN::PMT::" + t;
			b.form.submit();

			return true;
		}


		function go_audit(b) {
			b.disabled              = true;
			b.value                 = "Busy...";
			b.form.action.value     = "##TP_CGI_URL##";
			b.form.SubmitName.value = "GoAudit";
			b.form.submit();
		}

		// Get an array of the hosts
		var host_array = Array();

		##TP_LOOP host_idx {[tpGetVar N_Hosts]}##
			host_array[##TP_GWHost_Id##] = Array();
			host_array[##TP_GWHost_Id##]['type'] = "##TP_GWHost_Type##";
			host_array[##TP_GWHost_Id##]['desc'] = "##TP_GWHost_Desc##";
		##TP_ENDLOOP##


		function write_host_select(cur_type, cur_host) {
			
			// loop through all hosts
			for (i in host_array) {

				// only add to the list if it is of the correct type
				if (cur_type == host_array[i]['type']) {
					var sel_tag = (cur_host == i) ? " selected" : "";

					document.writeln('<option value="' + i + '"' + sel_tag + '>' +
							host_array[i]['desc'] + '</option');

				}
			}
		}

	</script>
</head>
<body>

<p><b>Note:</b> Any changes made to a payment gateway profile since it was activated will not be copied across to the live payment rules. If changes have been made, the payment gateway profile must be reactivated to pick up the changes</p>

<form name="PMTGWRuleFrm" action="##TP_CGI_URL##" method="get">
<table cellspacing="0" cellpadding="2" border="0">
<input type="hidden" name="action"       value="">
<input type="hidden" name="SubmitName"   value="">
<input type="hidden" name="accounts"     value="##TP_TCL {tpBufWrite [tpGetVar N_Accts]}##">
<input type="hidden" name="profile_id"   value="##TP_Profile_Id##">
<input type="hidden" name="rule_id"      value="##TP_Rule_Id##">
<input type="hidden" name="AuditInfo"    value="PmtRulesProfile">


<tr>
	<th colspan="3" class="title">
		Percentage of payments to go to each Payment Gateway
	</th>
</tr>

<tr class="subtitle">
	<th colspan="1" align="left">Payment Gateway Account</th>
	<th colspan="1" align="left">Payment Gateway Host</th>
	<th colspan="1">%</th>
</tr>

##TP_LOOP acct_idx {[tpGetVar N_Accts]}##

<input type="hidden" name="acct_##TP_TCL {tpBufWrite [tpGetVar acct_idx]}##" value="##TP_Account_Id##">
<tr>
	<td>##TP_Account_Name## (##TP_pg_type##)</td>
	<td>
		<select name="host_id_##TP_TCL {tpBufWrite [tpGetVar acct_idx]}##" style="width: 220px;">
			<script>
				write_host_select("##TP_pg_type##", "##TP_Host_Id##");
			</script>
		</select>
	</td>
	<td>
		<input type="text" name="percentage_##TP_TCL {tpBufWrite [tpGetVar acct_idx]}##" value="##TP_Pmt_Percentage##" size="3">
	</td>
</tr>
##TP_ENDLOOP##

<tr>
	<th colspan="3" class="buttons">
		<input type="button" value="Update Rule" onClick="return fs(this,'DoEditPmtRule')">
		<input type="button" value="Back" onClick="return fs(this,'GoEditPRProfile')">
	</th>
</tr>

</table>
</form>
</body>
</html>
