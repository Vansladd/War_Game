<!--
	$Id: bet.html,v 1.1.1.1 2011/10/04 10:54:26 xbourgui Exp $
	Copyright (c) 2005 Orbis Technology Ltd. All rights reserved.
-->

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=##TP_CHARSET##">
	<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=stylesheet">
	<script type="text/javascript" src="##TP_OFFICE_STATIC_URL##/js/xmlhttp.js"></script>
	##TP_IF {![OT_CfgGetTrue FUNC_OFFICE]}##
	<link rel="stylesheet" type="text/css" href="##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GoStylesheet">
	##TP_ENDIF##
	##TP_IF {$ASYNC(leg,nrows)}##
                <script language="javascript" src="##TP_OFFICE_STATIC_URL##/js/base.js"  type="text/javascript" />
		<script language="javascript" src="##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GoScript" type="text/javascript"></script>
	##TP_ENDIF##

	<title>Auto-referral Betting</title>
	##TP_PLAY header_cal.html##
	##TP_IF {$ASYNC(leg,nrows)}##
		<script language="javascript">

			##TP_PLAY input_util.js##

			##TP_COMMENT
				The following script is added here cause we need to bind stuff, which cannot be
				done within the sourced script
			##

			var bet_group_id = '##TP_bet_group_id##';

			// selected bet-leg
			var selectedLeg = '##TP_selected_leg##';

			// selected DD
			var selectedDD = '##TP_selected_dd##';

			// time remaining to resolve the bet
			var timeToResolve = ##TP_time_to_resolve##;

			// selected leg-sort
			var selectedLegSort = '##TP_selected_leg_sort##';

			// on page load
			function onLoad() {

				changeObjectDisplay(selectedDD + '_' + selectedLeg, '');
				changeClass(selectedDD, 'bordered_title_selected');

				changeClass(selectedLeg, 'selectedLeg');

				// hide any open-popups if clicked outside of the popup div
				getObject('asyncBet').onmouseup = hidePopupOnClick;

				##TP_COMMENT Only start clock if we are not overriden ##
				##TP_IF {[tpBindGet off_status] != "O"}##
					countDown("countDown();",1000);
				##TP_ENDIF##

				##TP_IF {!$ASYNC(offer) && !$ASYNC(action,cancel)}##
					// display Change Stake/Price Clear + Submit buttons
					displayStkLPButtons();
				##TP_ENDIF##

				##TP_IF {[tpBindGet off_status] != "O"}##
					##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
						new Calendar(document.forms.ev_##TP_leg_leg_no##_##TP_leg_part_no##.start_time,null,true,'lo');
						new Calendar(document.forms.ev_##TP_leg_leg_no##_##TP_leg_part_no##.suspend_at,null,true,'lo');
					##TP_ENDLOOP leg_idx##
				##TP_ENDIF##

				##TP_IF {[tpGetVar CONFIRM_ASYNC_BET_LOCK 0]}##
					goLockBet('##TP_bet_id##','##TP_locked_by##');
				##TP_ENDIF##
			}

			// copy Bet-Action data to bet_action form
			function copyToBetAction(formName) {

				##TP_IF {!$ASYNC(offer) && [op_allowed ManageAsyncBets]}##
					var actionForm = document.forms['bet_action'];
					var toForm = document.forms[formName];

					insertInputObj(toForm, 'hidden', '', 'comment', actionForm.comment.value);
					insertInputObj(toForm, 'hidden', '', 'reason_code', actionForm.reason_code.value);
					insertInputObj(toForm, 'hidden', '', 'stake_per_line', actionForm.stake_per_line.value);
					##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
						insertInputObj(toForm, 'hidden', '', 'lp_##TP_leg_leg_no##_##TP_leg_part_no##', actionForm.lp_##TP_leg_leg_no##_##TP_leg_part_no##.value);
					##TP_ENDLOOP##
				##TP_ENDIF##
			}


			// determine if the Change Stake/Price Clear + Submit buttons should be displayed
			function displayStkLPButtons() {

				##TP_IF {!$ASYNC(offer) && !$ASYNC(action,cancel)}##
					var f = document.forms['bet_action'];
					var display = f.stake_per_line.value.length;

					if(!display) {
						display = f.leg_type.value.length;
					}

					##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
						if(!display) {
							display = f.lp_##TP_leg_leg_no##_##TP_leg_part_no##.value.length;
						}
					##TP_ENDLOOP##

					changeObjectDisplay('actionStkLPClearButton', display ? '' : 'none');
					changeObjectDisplay('actionStkLPSubmitButton', display ? '' : 'none');

					changeClass('actionStakeButton', 'actionButtonInnerAll');
				##TP_ENDIF##
			}


			// clear the stake and price-offers
			function clearStkLPOffers() {

				##TP_IF {!$ASYNC(offer) && !$ASYNC(action,cancel)}##
					var f = document.forms['bet_action'];

					f.stake_per_line.value = '';
					f.leg_type.value = '';
					f.stake_leg_terms_changed.value=0;
					changeObjectDisplay('betDetailsActionStake', 'none');

					##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
						f.lp_##TP_leg_leg_no##_##TP_leg_part_no##.value = '';
						changeObjectDisplay('betLegActionPrice_##TP_leg_leg_no##_##TP_leg_part_no##', 'none');
						changeObjectDisplay('betLegActionTerms_##TP_leg_leg_no##_##TP_leg_part_no##', 'none');
					##TP_ENDLOOP##


					changeObjectDisplay('actionStkLPClearButton', 'none');
					changeObjectDisplay('actionStkLPSubmitButton', 'none');

					changeClass('actionStakeButton', selectedLegSort != '--' ? 'actionButtonInnerAll' : 'actionButtonInnerStart');
				##TP_ENDIF##
			}

			function clearLegTerms(t) {
				var f = document.forms['bet_action'];
				##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
					changeObjectDisplay('betLegActionTerms_##TP_leg_leg_no##_##TP_leg_part_no##', 'none');
				##TP_ENDLOOP##

				betActionLeg(t);
			}

			//DBV pop-up for selection
			function goDBV(id, sort, level) {

				if (level == 'seln') {
					var url = "##TP_TCL {OT_CfgGet DBV_URL}##?action=go_seln&ev_oc_id=" + id;
					window.open(
						url,
						"Liability_monitor",
						"toolbar=no,location=no,directories=no,menubar=no,resizable=yes,scrollbars=yes,width=600,height=500"
					);
				} else if (level == 'mkt'){
					var url = "##TP_TCL {OT_CfgGet DBV_URL}##?action=go_market&ev_mkt_id=" + id + "&sort=" + sort;
					window.open(
						url,
						"Liability_monitor",
						"toolbar=no,location=no,directories=no,menubar=no,resizable=yes,scrollbars=yes,width=600,height=500"
					);
				}
				return false;
			}

			// Admin receipt Popup
			function goBetReceipt(bet_id) {
				var url = "##TP_CGI_URL##?action=ADMIN::BET::GoBetReceipt&BetId=" + bet_id;

				window.open(
						url,
						"bet_details",
						"toolbar=no,location=no,directories=no,menubar=no,resizable=yes,scrollbars=yes,width=600,height=950"
					);

				return false;
			}

			##TP_IF {[OT_CfgGet FUNC_ASYNC_BET_DETAILS 0]}##
			function goLockBet(bet_id,locked_by) {

				var url;

				url = '##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GoBet&bet_id='+bet_id+'&attempt_lock=Y&confirm_lock=Y';

				if (confirm("Bet locked by "+locked_by+". Do you want to take over the lock?")) {
					location.href = url;
				}
			}
			##TP_ENDIF##

			// Create a countdown clock
			function countDown() {

				if (timeToResolve > 0) {
					timeToResolve--;
					setTimeout("countDown();", 1000);
					getObject('countDownToResolve').innerHTML = timeToResolve;
				} else {
					getObject('addNewResTimeButton').disabled=true;
					getObject('newResTime').disabled=true;
					getObject('countDownToResolve').innerHTML = 0;
				}

			}
			
			/**
			* This function just empties the new resolution time input field
			*
			*/
			function updTime(response) {
				document.getElementById('newResTime').value = '';
			}
			
			function addTime (bet_id,new_res_time_sec) {
				// Updating the counter with the input value
				timeToResolve += parseInt(new_res_time_sec);
				
				// Building up the parameters string
				var params = '';
				params += 'bet_group_id=' + bet_group_id;
				params += '&bet_id=' + bet_id;
				params += '&new_res_time_sec=' + new_res_time_sec;
				// Sending AJAX request to the server
				var call_back_function = function(_req) {asynchProcessHTMLResponse(_req, 'updTime','##TP_XL ASYNCH_BET_DETAILS_UNAVAILABLE##');};
				HttpRequest('##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GoUpdateExpTime', 'POST', call_back_function, params, true);
			}
			
			var original_payout = '##TP_potential_payout##';
			var original_stake  = '##TP_stake_per_line##';
		
			
			// Get the leg prices and stakes for the new offer and send an AJAX
			// request to get the potential win factor, which calls
			// handleOfferResp(_req) on response
			function checkAndConfirmOffer() {
				var prices = "";
				var sorts  = "";
			
				// Get the price and sort for each leg into tcl lists
				var i = 1;
				while (true) {
					// In case of emergency
					if (i > 50) { break; }
				
					e = getObject('betLegActionPrice_' + i + "_1");
					
					// If the element doesn't exist then we have run out of legs
					if (e == null) break;
					
					// If the element is empty, it doesn't have an offer price,
					// so use the original
					if (e.innerHTML.indexOf("/") == -1) {
						price = getObject(i + "_1" + "_leg_price").value.split("/");
					} else {
						price = e.innerHTML.split("/");
					}
					p_num = parseInt(price[0],10);
					p_den = parseInt(price[1],10);
			
					sort  = getObject(i + "_1" + "_leg_sort").value;

					prices += " {" + p_num + " " + p_den + "}";
					sorts  += " " + sort;
					i++;
				}
				
				// If i is still one then we didn't find any elements
				if (i == 1) {
					return;
				}
			
				// Construct params and send the request
				var params = '';
				params += "&bet_type=" + "##TP_bet_type##";
				params += "&leg_type=" + "##TP_leg_type##";
				params += "&prices=" + prices;
				params += "&sorts="  + sorts;
				params += "&ew_terms=" + "##TP_ew_terms##";
				HttpRequest('##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GetWinFactor', 
					'POST', handleOfferResp, params, true);
			}
			
			// Get the win factor from the response text and if it the new payout
			// will be bigger then ask the user for confirmation of the offer
			function handleOfferResp(_req) {
				actionForm    = document.forms['bet_action'];
				submitOffForm = document.forms['bet_stakelp_action'];
			
				offer_stake      = actionForm.stake_per_line.value;
				offer_win_factor = parseFloat(_req.responseText);
				
				if (offer_stake == null || offer_stake == "") {
					offer_stake = original_stake;
				}

				var offerCount = actionForm.group_offer_count.value;
				offer_stake     = parseFloat(offer_stake);
				offer_payout    = offer_stake * offer_win_factor;
				offer_payout    = parseFloat(offer_payout);
				original_payout = parseFloat(original_payout);
 				if (offer_payout > original_payout) {
					offer_payout    = offer_payout.toFixed(2);
					original_payout = original_payout.toFixed(2);

					if (confirm("Original payout was ##TP_default_ccy## " + original_payout + "\n" +
					"New offer payout is ##TP_default_ccy## " + offer_payout + "\n\n" +
					"Are you sure you wish to offer a bigger payout?")) {
					
						// Note: this code is duplicated from script.js, don't have time to fix
						var source = document.getElementById('source').value;

						if (source == 'P' || source == 'N') {
							actionForm.bet_reason.value = submitOffForm.bet_reason.value;
						}
						actionForm.action.value  = 'ADMIN::ASYNC_BET::DoActStkLP';
				
						submitForm(getObject("betActionSubmitOffBut"), 'bet_action');
						if (offerCount == 1 && confirm("Close the Auto Referral Betting Window now?")) {
							window.close();
						}
					}
				} else {
					// Note: this code is duplicated from script.js, don't have time to fix
					var source = document.getElementById('source').value;

					if (source == 'P' || source == 'N') {
						actionForm.bet_reason.value = submitOffForm.bet_reason.value;
					}
					actionForm.action.value  = 'ADMIN::ASYNC_BET::DoActStkLP';
			
					submitForm(getObject("betActionSubmitOffBut"), 'bet_action');
					if (offerCount == 1 && confirm("Close the Auto Referral Betting Window now?")) {
						window.close();
					}
				}
			}

			/**
			* This function refreshes the page and shows the selected bet details
			*
			*/
			function popupAsyncBetDetails(bet_id, bet_group_id) {

				var url = "##TP_CGI_URL##?action=ADMIN::ASYNC_BET::GoBet&bet_id=" + bet_id + "&bet_group_id=" + bet_group_id;

				window.location.href = url;

			}

		</script>
	##TP_ENDIF##
</head>

<body onload="##TP_IF {$ASYNC(leg,nrows)}##onLoad();##TP_ENDIF##">

	##TP_IF {![tpGetVar DD_ERR 0]}##
		##TP_PLAY error_rpt.html##
	##TP_ENDIF##

	##TP_IF {[op_allowed ViewAsyncBets] && $ASYNC(nrows)}##
	<div id="asyncBet">
		<table cellspacing="0" cellpadding="0" border="0" width="98%" align="center">

			##TP_IF {[tpGetVar NumGrpBets 0] > 1}##
				##TP_PLAY async_bet/bet_group_detail.html##
			##TP_ENDIF##

			##TP_PLAY async_bet/bet_details.html##

			##TP_IF {$ASYNC(leg,nrows)}##
				##TP_PLAY async_bet/bet_legs.html##

				##TP_IF {!$ASYNC(offer) && [op_allowed ManageAsyncBets]}##
					##TP_PLAY async_bet/action.html##
				##TP_ELSEIF {$ASYNC(offer)}##
					##TP_PLAY async_bet/offer.html##
				##TP_ENDIF##
				
				##TP_IF {[tpBindGet off_status] != "O"}##
	
					<!-- Leg Drill-Down -->
					<tr>
						<td style="padding-top: 10px" colspan="2">
							<table cellspacing="0" cellpadding="3" border="0" align="left" width="100%">
	
								##TP_PLAY async_bet/dd_title.html##
								##TP_PLAY async_bet/dd_cust.html##
								##TP_LOOP leg_idx {$ASYNC(leg,nrows)}##
									##TP_PLAY async_bet/dd_ev.html##
									##TP_PLAY async_bet/dd_mkt.html##
									##TP_PLAY async_bet/dd_oc.html##
								##TP_ENDLOOP leg_idx##
							</table>
						</td>
					</tr>
					<!-- End of Leg Drill-Down -->
				##TP_ELSE##
					<tr><td colspan="2"><table style="margin: 0 auto;" border="0" cellspacing="0">
					<tr>
						<td id="cust">
							Customer
						</td>
				
						<td id="mkt">

						</td>
					</tr>
						##TP_PLAY async_bet/dd_cust.html##
						<script>ddOnClick('cust');</script>
					</table></td></tr>
				##TP_ENDIF##

			##TP_ENDIF leg##
	

		</table>
	</div>
	##TP_ENDIF op_allowed##
	
	##TP_IF {[tpBindGet off_status] == "O"}##
		<script>
			alert("This auto-referall has been overridden by the telephone operator, ##TP_admin_user##.\n You cannot make any changes in this state.");
		</script>
	##TP_ENDIF##

</body>
</html>
